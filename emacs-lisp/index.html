<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content="Emacs Lisp - https://aituyaa.com/emacs-lisp/">
    <meta name="author" content="Jack - https://aituyaa.com/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title>Emacs Lisp</title>
    
    <base target="_blank">
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    
    
    
    
    <link rel="stylesheet" href="https://aituyaa.com/style.min.7a1211384e00d894dc501a9708ae5fb349825c010d5348b62a8727d135f41615.css">
    
    <script>const DARK =  false ;</script>
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        
        <div class="cool-before" style="background: url('/imgs/bg/color.jpg') left top/100% no-repeat fixed;"></div>
        <div id="header" class=""><div class="container-header">

    
    
    
    <div class="right">
        
        <h1 class="title">Emacs Lisp</h1>
    
        
        
            <div id="toc">📜</div>
        
    </div>
</div>
</div>
        <div id="content">










<div class="container-main container-page ">

    

    
    
    
    <div class="rel">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        <div class="curtag-desc">
            <a href="https://aituyaa.com/tags/ols/"><img src="/imgs/icons/tag.svg" width="16" /> 相关文章：OLs <sup>13</sup></a>
        </div>

        <div class="curtag-post">
            
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/css-%E4%B8%AD%E7%9A%84%E5%8A%A8%E6%95%88/">CSS 中的动效</a>
                </div>
                
                
            
            
                <div class="curtag-post-item curtag-post-item--active">
                    <a href="https://aituyaa.com/emacs-lisp/">Emacs Lisp</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/git/">Git</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/git-%E6%8F%90%E4%BA%A4%E6%B6%88%E6%81%AF%E7%BA%A6%E5%AE%9A/">Git 提交消息约定</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/json-web-tokens/">Json Web Tokens</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/lua-%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/">Lua 那些事儿</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/poetry-%E7%9A%84%E7%AE%80%E8%A6%81%E8%AF%B4%E6%98%8E/">Poetry 的简要说明</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/python-%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/">Python 那些事儿</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/shell-%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/">Shell 那些事儿</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/sql/">SQL</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/%E5%AD%97%E7%AC%A6%E9%9B%86%E5%92%8C%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/">字符集和字符编码</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a>
                </div>
                
                
            
            
                <div class="curtag-post-item ">
                    <a href="https://aituyaa.com/%E8%BF%9B%E5%88%B6%E5%8F%8A%E8%BD%AC%E6%8D%A2/">进制及转换</a>
                </div>
                
                
        </div>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
    

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="7409" width="12" height="12">
                <path
                    d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z"
                    p-id="7410" fill="#adb5bd"></path>
            </svg>
            2023-05-26&nbsp;&nbsp;&nbsp;
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="23838" width="11" height="11">
                <path
                    d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z"
                    p-id="23839" fill="#adb5bd"></path>
            </svg>
            2025-01-29&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="33866" width="12" height="12">
                <path
                    d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z"
                    fill="#adb5bd" p-id="33867"></path>
                <path
                    d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z"
                    fill="#adb5bd" p-id="33868"></path>
            </svg>
            47289 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="32892" width="12" height="12">
                <path
                    d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z"
                    p-id="32893" fill="#adb5bd"></path>
                <path
                    d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z"
                    p-id="32894" fill="#adb5bd"></path>
            </svg>
            95 分钟</span>
        <div class="container-ctgtag">
	<div class="taxonomy">
		<div class="tag">
			
			
			<a href="/tags/ols">OLs</a>
			
			<a href="/tags/%E7%BC%96%E8%BE%91%E5%99%A8">编辑器</a>
			
		</div>
	</div>
</div>
        
    </div>

    <div class="toc">
        <div class="container-page-operation">
	<div class="page-operation">
		<div><a href="/"><img src="/imgs/icons/home-2.svg" alt=""></a></div>
		<div><a href="/nav"><img src="/imgs/icons/iov-navigate-1.svg" alt=""></a></div>
		<div><a href="/wiki"><img src="/imgs/icons/wiki.svg" alt=""></a></div>
		<div><a href="/tags"><img src="/imgs/icons/treetags.svg" alt=""></a></div>
		<div id="light-dark"><a><img src="/imgs/icons/moon2.svg" alt=""></a></div>
		<div><a href="#"><img src="/imgs/icons/up2.svg" alt=""></a></div>
	</div>
</div>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一个-hello-world-例子">一个 Hello World 例子</a></li>
    <li><a href="#基础知识">基础知识</a>
      <ul>
        <li><a href="#函数和变量">函数和变量</a></li>
        <li><a href="#局部作用域的变量">局部作用域的变量</a></li>
        <li><a href="#lambda-表达式">lambda 表达式</a></li>
        <li><a href="#控制结构">控制结构</a>
          <ul>
            <li><a href="#顺序执行">顺序执行</a></li>
            <li><a href="#条件判断">条件判断</a></li>
            <li><a href="#循环">循环</a></li>
          </ul>
        </li>
        <li><a href="#逻辑运算">逻辑运算</a></li>
        <li><a href="#函数列表">函数列表</a></li>
      </ul>
    </li>
    <li><a href="#基本数据类型之一--数字">基本数据类型之一 – 数字</a>
      <ul>
        <li><a href="#测试函数">测试函数</a></li>
        <li><a href="#数的比较">数的比较</a></li>
        <li><a href="#数的转换">数的转换</a></li>
        <li><a href="#数的运算">数的运算</a></li>
        <li><a href="#函数列表-1">函数列表</a></li>
        <li><a href="#变量列表">变量列表</a></li>
      </ul>
    </li>
    <li><a href="#基本数据类型之二--字符和字符串">基本数据类型之二 – 字符和字符串</a>
      <ul>
        <li><a href="#测试函数-1">测试函数</a></li>
        <li><a href="#构造函数">构造函数</a></li>
        <li><a href="#字符串比较">字符串比较</a></li>
        <li><a href="#转换函数">转换函数</a></li>
        <li><a href="#格式化字符串">格式化字符串</a></li>
        <li><a href="#查找和替换">查找和替换</a></li>
        <li><a href="#函数列表-2">函数列表</a></li>
      </ul>
    </li>
    <li><a href="#基本数据类型之三--cons-cell-和列表">基本数据类型之三 – cons cell 和列表</a>
      <ul>
        <li><a href="#测试函数-2">测试函数</a></li>
        <li><a href="#构造函数-1">构造函数</a></li>
        <li><a href="#把列表当数组用">把列表当数组用</a></li>
        <li><a href="#把列表当堆栈用">把列表当堆栈用</a></li>
        <li><a href="#重排列表">重排列表</a></li>
        <li><a href="#把列表当集合用">把列表当集合用</a></li>
        <li><a href="#把列表当关联表">把列表当关联表</a></li>
        <li><a href="#把列表当树用">把列表当树用</a></li>
        <li><a href="#遍历列表">遍历列表</a></li>
        <li><a href="#其它常用函数">其它常用函数</a></li>
        <li><a href="#函数列表-3">函数列表</a></li>
        <li><a href="#问题解答">问题解答</a>
          <ul>
            <li><a href="#用-list-生成-a-b-c">用 list 生成 (a b c)</a></li>
            <li><a href="#nthcdr-的一个实现">nthcdr 的一个实现</a></li>
            <li><a href="#my-subseq-函数的定义">my-subseq 函数的定义</a></li>
            <li><a href="#setcdr-foo-foo-是什么怪东西">(setcdr foo foo) 是什么怪东西？</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#基本数据类型之四--数组和序列">基本数据类型之四 – 数组和序列</a>
      <ul>
        <li><a href="#测试函数-3">测试函数</a></li>
        <li><a href="#序列的通用函数">序列的通用函数</a></li>
        <li><a href="#数组操作">数组操作</a></li>
        <li><a href="#函数列表-4">函数列表</a></li>
        <li><a href="#问题解答-1">问题解答</a>
          <ul>
            <li><a href="#测试列表是否是环形列表">测试列表是否是环形列表</a></li>
            <li><a href="#转换字符的-tr-函数">转换字符的 tr 函数</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#基本数据类型之五--符号">基本数据类型之五 – 符号</a>
      <ul>
        <li><a href="#创建符号">创建符号</a></li>
        <li><a href="#符号的组成">符号的组成</a></li>
        <li><a href="#函数列表-5">函数列表</a></li>
        <li><a href="#问题解答-2">问题解答</a>
          <ul>
            <li><a href="#obarray-里符号数为什么大于向量长度">obarray 里符号数为什么大于向量长度</a></li>
            <li><a href="#根据关键字删除关联列表中的元素">根据关键字删除关联列表中的元素</a></li>
            <li><a href="#plist-get-和-plist-put-的实现">plist-get 和 plist-put 的实现</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#求值规则">求值规则</a></li>
    <li><a href="#变量">变量</a>
      <ul>
        <li><a href="#buffer-local-变量">buffer-local 变量</a></li>
        <li><a href="#变量的作用域">变量的作用域</a></li>
        <li><a href="#其它函数">其它函数</a></li>
        <li><a href="#变量名习惯">变量名习惯</a></li>
        <li><a href="#函数列表-6">函数列表</a></li>
        <li><a href="#变量列表-1">变量列表</a></li>
        <li><a href="#问题解答-3">问题解答</a>
          <ul>
            <li><a href="#同一个表达式运行再次结果不同">同一个表达式运行再次结果不同？</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#函数和命令">函数和命令</a>
      <ul>
        <li><a href="#参数列表的语法">参数列表的语法</a></li>
        <li><a href="#关于文档字符串">关于文档字符串</a></li>
        <li><a href="#调用函数">调用函数</a></li>
        <li><a href="#宏">宏</a></li>
        <li><a href="#命令">命令</a></li>
        <li><a href="#函数列表-7">函数列表</a></li>
        <li><a href="#变量列表-2">变量列表</a></li>
        <li><a href="#问题解答-4">问题解答</a>
          <ul>
            <li><a href="#可选误差的浮点数比较">可选误差的浮点数比较</a></li>
            <li><a href="#遍历树的函数">遍历树的函数</a></li>
            <li><a href="#宏-with-inhibit-read-only-t">宏 with-inhibit-read-only-t</a></li>
            <li><a href="#切换-major-mode-的命令">切换 major-mode 的命令</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#正则表达式">正则表达式</a>
      <ul>
        <li><a href="#与-perl-正则表达式比较">与 Perl 正则表达式比较</a></li>
        <li><a href="#语法表格和分类表格简介">语法表格和分类表格简介</a></li>
        <li><a href="#几个常用的函数">几个常用的函数</a></li>
        <li><a href="#函数列表-8">函数列表</a></li>
        <li><a href="#命令列表">命令列表</a></li>
      </ul>
    </li>
    <li><a href="#操作对象之一--缓冲区">操作对象之一 – 缓冲区</a>
      <ul>
        <li><a href="#缓冲区的名字">缓冲区的名字</a></li>
        <li><a href="#当前缓冲区">当前缓冲区</a></li>
        <li><a href="#创建和关闭缓冲区">创建和关闭缓冲区</a></li>
        <li><a href="#在缓冲区内移动">在缓冲区内移动</a></li>
        <li><a href="#缓冲区的内容">缓冲区的内容</a></li>
        <li><a href="#修改缓冲区的内容">修改缓冲区的内容</a></li>
        <li><a href="#函数列表-9">函数列表</a></li>
        <li><a href="#问题解答-5">问题解答</a>
          <ul>
            <li><a href="#可选择区域也可不选择区域的命令">可选择区域也可不选择区域的命令</a></li>
            <li><a href="#标记整个-s-表达式">标记整个 S 表达式</a></li>
            <li><a href="#oowriter-表格转换">oowriter 表格转换</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#操作对象之二--窗口">操作对象之二 – 窗口</a>
      <ul>
        <li><a href="#分割窗口">分割窗口</a></li>
        <li><a href="#删除窗口">删除窗口</a></li>
        <li><a href="#窗口配置">窗口配置</a></li>
        <li><a href="#选择窗口">选择窗口</a></li>
        <li><a href="#窗口大小信息">窗口大小信息</a></li>
        <li><a href="#窗口对应的缓冲区">窗口对应的缓冲区</a></li>
        <li><a href="#改变窗口显示区域">改变窗口显示区域</a></li>
        <li><a href="#函数列表-10">函数列表</a></li>
        <li><a href="#问题解答-6">问题解答</a>
          <ul>
            <li><a href="#保存窗口位置信息">保存窗口位置信息</a></li>
            <li><a href="#改进的保存窗口信息的函数">改进的保存窗口信息的函数</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#操作对象之三--文件">操作对象之三 – 文件</a>
      <ul>
        <li><a href="#打开文件的过程">打开文件的过程</a></li>
        <li><a href="#文件读写">文件读写</a></li>
        <li><a href="#文件信息">文件信息</a></li>
        <li><a href="#修改文件信息">修改文件信息</a></li>
        <li><a href="#文件名操作">文件名操作</a></li>
        <li><a href="#临时文件">临时文件</a></li>
        <li><a href="#读取目录内容">读取目录内容</a></li>
        <li><a href="#神奇的-handle">神奇的 Handle</a></li>
        <li><a href="#函数列表-11">函数列表</a></li>
        <li><a href="#问题解答-7">问题解答</a>
          <ul>
            <li><a href="#提取头文件中函数名">提取头文件中函数名</a></li>
            <li><a href="#模拟-chmod-的函数">模拟 chmod 的函数</a></li>
            <li><a href="#列出目录中所有文件">列出目录中所有文件</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#操作对象之四--文本">操作对象之四 – 文本</a>
      <ul>
        <li><a href="#查看文本属性">查看文本属性</a></li>
        <li><a href="#修改文本属性">修改文本属性</a></li>
        <li><a href="#查找文本属性">查找文本属性</a></li>
        <li><a href="#函数列表-12">函数列表</a></li>
        <li><a href="#问题解答-8">问题解答</a>
          <ul>
            <li><a href="#手工高亮代码">手工高亮代码</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#后记">后记</a></li>
  </ul>
</nav>
    </div>

    <div class='content  '>
        <p>📕 转载自 <a href="http://smacs.github.io/elisp/">Emacs Lisp 简明教程 - 水木社区 Emacs 版</a></p>
<blockquote>
<p>这是 叶文彬（水木 ID: happierbee) 写的一份 Emacs Lisp 的教程，深入浅出，非常适合初学者。文档的 TeX 代码及 PDF 文档可在<a href="http://www.newsmth.net/nForum/article/Emacs/58338?s=58338">此处下载</a> 。</p>
</blockquote>
<p>emacs 的高手不能不会 elisp。但是对于很多人来说 elisp 学习是一个痛苦的历程，至少我是有这样一段经历。因此，我写了这一系列文章，希望能为后来者提供一点捷径。</p>
<h2 id="一个-hello-world-例子">一个 Hello World 例子</h2>
<p>自从 K&amp;R 以来，hello world 程序历来都是程序语言教程的第一个例子。我也用一个 hello world 的例子来演示 emacs 里执行 elisp 的环境。下面就是这个语句：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">message</span> <span style="color:#d14">&#34;hello world&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>前面我没有说这个一个程序，这是因为，elisp 不好作为可执行方式来运行（当然也不是不可能），所有的 elisp 都是运行在 emacs 这个环境下。</p>
<p>首先切换到 <code>*scratch*</code> 缓冲区里，如果当前模式不是 <code>lisp-interaction-mode</code>，用 <code>M-x lisp-interaction-mode</code> 先转换到 <code>lisp-interaction-mode</code>。然后输入前面这一行语句。在行尾右括号后，按 <code>C-j</code> 键。如果 <code>Minibuffer</code> 里显示 <code>hello world</code>，光标前一行也显示 <code>&quot;hello world&quot;</code>，那说明你的操作没有问题。我们就可以开始 elisp 学习之旅了。</p>
<p>注：elisp 里的一个完整表达式，除了简单数据类型（如数字，向量），都是用括号括起来，称为一个 S-表达式。让 elisp 解释器执行一个 S-表达式除了前一种方法之外，还可以用 <code>C-x C-e</code>。它们的区别是，<code>C-x C-e</code> 是一个全局按键绑定，几乎可以在所有地方都能用。它会将运行返回值显示在 <code>Minibuffer</code> 里。这里需要强调一个概念是返回值和作用是不同的。比如前面 <code>message</code> 函数它的作用是在 Minibuffer 里显示一个字符串，但是它的返回值是 <code>&quot;hello world&quot;</code> 字符串。</p>
<h2 id="基础知识">基础知识</h2>
<p>这一节介绍一下 elisp 编程中一些最基本的概念，比如如何定义函数，程序的控制结构，变量的使用和作用域等等。</p>
<h3 id="函数和变量">函数和变量</h3>
<p>elisp 中定义一个函数是用这样的形式：</p>
<pre tabindex="0"><code>(defun function-name (arguments-list)
  &#34;document string&#34;
  body)
</code></pre><p>比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">hello-world</span> (<span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;Say hello to user whose name is NAME.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Hello, %s&#34;</span> <span style="color:#008080">name</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中函数的文档字符串是可以省略的。但是建议为你的函数（除了最简单，不作为接口的）都加上文档字符串。这样将来别人使用你的扩展或者别人阅读你的代码或者自己进行维护都提供很大的方便。</p>
<p>在 emacs 里，当光标处于一个函数名上时，可以用 <code>C-h f</code> 查看这个函数的文档。比如前面这个函数，在 <code>*Help*</code> 缓冲区里的文档是：</p>
<pre tabindex="0"><code>hello-world is a Lisp function.
(hello-world name)

Say hello to user whose name is name.
</code></pre><p>如果你的函数是在文件中定义的。这个文档里还会给出一个链接能跳到定义的地方。</p>
<p>要运行一个函数，最一般的方式是：</p>
<pre tabindex="0"><code>(function-name arguments-list)
</code></pre><p>比如前面这个函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">hello-world</span> <span style="color:#d14">&#34;Emacser&#34;</span>)                 <span style="color:#998;font-style:italic">; =&gt; &#34;Hello, Emacser&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>每个函数都有一个返回值。这个返回值一般是函数定义里的最后一个表达式的值。</p>
<p>elisp 里的变量使用无需象 C 语言那样需要声明，你可以用 setq 直接对一个变量赋值。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;I&#39;m foo&#34;</span>)                    <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m foo&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">message</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m foo&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>和函数一样，你可以用 C-h v 查看一个变量的文档。比如当光标在 foo 上时用 <code>C-h v</code> 时，文档是这样的：</p>
<pre tabindex="0"><code>foo&#39;s value is &#34;I&#39;m foo&#34;

Documentation:
Not documented as a variable.
</code></pre><p>有一个特殊表达式（special form）<code>defvar</code>，它可以声明一个变量，一般的形式是：</p>
<pre tabindex="0"><code>(defvar variable-name value
  &#34;document string&#34;)
</code></pre><p>它与 <code>setq</code> 所不同的是，如果变量在声明之前，这个变量已经有一个值的话， <strong>用 <code>defvar</code> 声明的变量值不会改变成声明的那个值</strong> 。另一个区别是 <code>defvar</code> 可以为变量提供文档字符串，当变量是在文件中定义的话，<code>C-h v</code> 后能给出变量定义的位置。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defvar</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;Did I have a value?&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;A demo variable&#34;</span>)                    <span style="color:#998;font-style:italic">; =&gt; foo</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m foo&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defvar</span> <span style="color:#008080">bar</span> <span style="color:#d14">&#34;I&#39;m bar&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;A demo variable named \&#34;bar\&#34;&#34;</span>)      <span style="color:#998;font-style:italic">; =&gt; bar</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">bar</span>                                     <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m bar&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用 <code>C-h v</code> 查看 foo 的文档，可以看到它已经变成：</p>
<pre tabindex="0"><code>foo&#39;s value is &#34;I&#39;m foo&#34;

Documentation:
A demo variable
</code></pre><p>由于 elisp 中函数是全局的，变量也很容易成为全局变量（因为全局变量和局部变量的赋值都是使用 <code>setq</code> 函数），名字不互相冲突是很关键的。所以除了为你的函数和变量选择一个合适的前缀之外，用 <code>C-h f</code> 和 <code>C-h v</code> 查看一下函数名和变量名有没有已经被使用过是很关键的。</p>
<h3 id="局部作用域的变量">局部作用域的变量</h3>
<p>如果没有局部作用域的变量，都使用全局变量，函数会相当难写。elisp 里可以用 let 和 <code>let*</code> 进行局部变量的绑定。<code>let</code> 使用的形式是：</p>
<pre tabindex="0"><code>(let (bindings)
  body)
</code></pre><p>bingdings 可以是 (var value) 这样对 var 赋初始值的形式，或者用 var 声明一个初始值为 <code>nil</code> 的变量。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">circle-area</span> (<span style="color:#008080">radix</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">pi</span> <span style="color:#099">3.1415926</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#008080">area</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">area</span> (<span style="color:#900;font-weight:bold">*</span> <span style="color:#008080">pi</span> <span style="color:#008080">radix</span> <span style="color:#008080">radix</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">message</span> <span style="color:#d14">&#34;直径为 %.2f 的圆面积是 %.2f&#34;</span> <span style="color:#008080">radix</span> <span style="color:#008080">area</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">circle-area</span> <span style="color:#099">3</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>C-h v</code> 查看 area 和 pi 应该没有这两个变量。</p>
<p><code>let*</code> 和 <code>let</code> 的使用形式完全相同，唯一的区别是在 <code>let*</code> 声明中就<strong>能使用前面声明的变量</strong>，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">circle-area</span> (<span style="color:#008080">radix</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let*</span> ((<span style="color:#008080">pi</span> <span style="color:#099">3.1415926</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#008080">area</span> (<span style="color:#900;font-weight:bold">*</span> <span style="color:#008080">pi</span> <span style="color:#008080">radix</span> <span style="color:#008080">radix</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">message</span> <span style="color:#d14">&#34;直径为 %.2f 的圆面积是 %.2f&#34;</span> <span style="color:#008080">radix</span> <span style="color:#008080">area</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="lambda-表达式">lambda 表达式</h3>
<p>可能你久闻 lambda 表达式的大名了。其实依我的理解，lambda 表达式相当于其它语言中的匿名函数。比如 perl 里的匿名函数。它的形式和 <code>defun</code> 是完全一样的：</p>
<pre tabindex="0"><code>(lambda (arguments-list)
  &#34;documentation string&#34;
  body)
</code></pre><p>调用 lambda 方法如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">funcall</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>           (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Hello, %s!&#34;</span> <span style="color:#008080">name</span>)) <span style="color:#d14">&#34;Emacser&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>你也可以把 lambda 表达式赋值给一个变量，然后用 <code>funcall</code> 调用：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>            (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Hello, %s!&#34;</span> <span style="color:#008080">name</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;Emacser&#34;</span>)                   <span style="color:#998;font-style:italic">; =&gt; &#34;Hello, Emacser!&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>lambda 表达式最常用的是作为参数传递给其它函数，比如 <code>mapc</code>。</p>
<h3 id="控制结构">控制结构</h3>
<h4 id="顺序执行">顺序执行</h4>
<p>一般来说程序都是按表达式顺序依次执行的。这在 <code>defun</code> 等特殊环境中是自动进行的。但是一般情况下都不是这样的。比如你无法用 <code>eval-last-sexp</code> 同时执行两个表达式，在 if 表达式中的条件为真时执行的部分也只能运行一个表达式。这时就需要用 <code>progn</code> 这个特殊表达式。它的使用形式如下：</p>
<pre tabindex="0"><code>(progn A B C ...)
</code></pre><p>它的作用就是让表达式 A, B, C 顺序执行。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#099">3</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Square of %d is %d&#34;</span> <span style="color:#008080">foo</span> (<span style="color:#900;font-weight:bold">*</span> <span style="color:#008080">foo</span> <span style="color:#008080">foo</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="条件判断">条件判断</h4>
<p>elisp 有两个最基本的条件判断表达式 <code>if</code> 和 <code>cond</code>。使用形式分别如下：</p>
<pre tabindex="0"><code>(if condition
    then
  else)

(cond (case1 do-when-case1)
      (case2 do-when-case2)
      ...
      (t do-when-none-meet))
</code></pre><blockquote>
<p>:: <code>cond</code> 类似于其他语言中的 <code>switch</code> ，而且明显 elisp 的语义化更好。</p>
</blockquote>
<p>使用的例子如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-max</span> (<span style="color:#008080">a</span> <span style="color:#008080">b</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">&gt;</span> <span style="color:#008080">a</span> <span style="color:#008080">b</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#008080">a</span> <span style="color:#008080">b</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">my-max</span> <span style="color:#099">3</span> <span style="color:#099">4</span>)                            <span style="color:#998;font-style:italic">; =&gt; 4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">fib</span> (<span style="color:#008080">n</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">cond</span> ((<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">n</span> <span style="color:#099">0</span>) <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>        ((<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">n</span> <span style="color:#099">1</span>) <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">t</span> (<span style="color:#900;font-weight:bold">+</span> (<span style="color:#008080">fib</span> (<span style="color:#900;font-weight:bold">-</span> <span style="color:#008080">n</span> <span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>                 (<span style="color:#008080">fib</span> (<span style="color:#900;font-weight:bold">-</span> <span style="color:#008080">n</span> <span style="color:#099">2</span>))))))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">fib</span> <span style="color:#099">10</span>)                                <span style="color:#998;font-style:italic">; =&gt; 55</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有两个宏 <code>when</code> 和 <code>unless</code>，从它们的名字也就能知道它们是作什么用的。使用这两个宏的好处是使代码可读性提高，<code>when</code> 能省去 <code>if</code> 里的 <code>progn</code> 结构，<code>unless</code> 省去条件为真子句需要的的 <code>nil</code> 表达式。</p>
<h4 id="循环">循环</h4>
<p>循环使用的是 <code>while</code> 表达式。它的形式是：</p>
<pre tabindex="0"><code>(while condition
  body)
</code></pre><p>比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">factorial</span> (<span style="color:#008080">n</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">res</span> <span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">while</span> (<span style="color:#900;font-weight:bold">&gt;</span> <span style="color:#008080">n</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">res</span> (<span style="color:#900;font-weight:bold">*</span> <span style="color:#008080">res</span> <span style="color:#008080">n</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#008080">n</span> (<span style="color:#900;font-weight:bold">-</span> <span style="color:#008080">n</span> <span style="color:#099">1</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#008080">res</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">factorial</span> <span style="color:#099">10</span>)                          <span style="color:#998;font-style:italic">; =&gt; 3628800</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="逻辑运算">逻辑运算</h3>
<p>条件的逻辑运算和其它语言都是很类似的，使用 <code>and</code>、<code>or</code>、<code>not</code>。<code>and</code> 和 <code>or</code> 也同样具有短路性质。很多人喜欢在表达式短时，用 <code>and</code> 代替 <code>when</code>，<code>or</code> 代替 <code>unless</code>。当然这时一般不关心它们的返回值，而是在于表达式其它子句的副作用。比如 <code>or</code> 经常用于设置函数的缺省值，而 <code>and</code> 常用于参数检查：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">hello-world</span> (<span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">or</span> <span style="color:#008080">name</span> (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">name</span> <span style="color:#d14">&#34;Emacser&#34;</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Hello, %s&#34;</span> <span style="color:#008080">name</span>))           <span style="color:#998;font-style:italic">; =&gt; hello-world</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">hello-world</span>)                           <span style="color:#998;font-style:italic">; =&gt; &#34;Hello, Emacser&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">hello-world</span> <span style="color:#d14">&#34;Ye&#34;</span>)                      <span style="color:#998;font-style:italic">; =&gt; &#34;Hello, Ye&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">square-number-p</span> (<span style="color:#008080">n</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">&gt;</span> <span style="color:#008080">n</span> <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>       (<span style="color:#900;font-weight:bold">=</span> (<span style="color:#900;font-weight:bold">/</span> <span style="color:#008080">n</span> (<span style="color:#900;font-weight:bold">sqrt</span> <span style="color:#008080">n</span>)) (<span style="color:#900;font-weight:bold">sqrt</span> <span style="color:#008080">n</span>))))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">square-number-p</span> <span style="color:#099">-1</span>)                    <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">square-number-p</span> <span style="color:#099">25</span>)                    <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="函数列表">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">NAME</span> <span style="color:#008080">ARGLIST</span> <span style="color:#008080">[DOCSTRING]</span> <span style="color:#008080">BODY...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defvar</span> <span style="color:#008080">SYMBOL</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">INITVALUE</span> <span style="color:#008080">DOCSTRING</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">SYM</span> <span style="color:#008080">VAL</span> <span style="color:#008080">SYM</span> <span style="color:#008080">VAL</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> <span style="color:#008080">VARLIST</span> <span style="color:#008080">BODY...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let*</span> <span style="color:#008080">VARLIST</span> <span style="color:#008080">BODY...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">lambda</span> <span style="color:#008080">ARGS</span> <span style="color:#008080">[DOCSTRING]</span> <span style="color:#008080">[INTERACTIVE]</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">progn</span> <span style="color:#008080">BODY</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">COND</span> <span style="color:#008080">THEN</span> <span style="color:#008080">ELSE...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">cond</span> <span style="color:#008080">CLAUSES...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">when</span> <span style="color:#008080">COND</span> <span style="color:#008080">BODY</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">unless</span> <span style="color:#008080">COND</span> <span style="color:#008080">BODY</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">when</span> <span style="color:#008080">COND</span> <span style="color:#008080">BODY</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">or</span> <span style="color:#008080">CONDITIONS</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">and</span> <span style="color:#008080">CONDITIONS</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">not</span> <span style="color:#008080">OBJECT</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="基本数据类型之一--数字">基本数据类型之一 – 数字</h2>
<p><strong>elisp 里的对象都是有类型的，而且每一个对象它们知道自己是什么类型。</strong> 你得到一个变量名之后可以用一系列检测方法来测试这个变量是什么类型（好像没有什么方法来让它说出自己是什么类型的）。内建的 emacs 数据类型称为 primitive types，包括整数、浮点数、cons、符号 (symbol)、字符串、向量 (vector)、散列表 (hash-table)、subr（内建函数，比如 cons, if, and 之类）、byte-code function，和其它特殊类型，例如缓冲区（buffer）。</p>
<p>在开始前有必要先了解一下读入语法和输出形式。所谓读入语法是让 elisp 解释器明白输入字符所代表的对象，你不可能让 elisp 读入 <code>.#@!?</code> 这样奇怪的东西还能好好工作吧（perl 好像经常要受这样的折磨：)）。简单的来说，一种数据类型有（也可能没有，比如散列表）对应的规则来让解释器产生这种数据类型，比如 123 产生整数 123， <code>(a . b)</code> 产生一个 cons。所谓输出形式是解释器用产生一个字符串来表示一个数据对象。比如整数 123 的输出形式就是 123，cons cell <code>(a . b)</code> 的输出形式是 <code>(a . b)</code>。与读入语法不同的是，数据对象都有输出形式。比如散列表的输出可能是这样的：</p>
<pre tabindex="0"><code>#&lt;hash-table &#39;eql nil 0/65 0xa7344c8&gt;
</code></pre><p>通常一个对象的数据对象的输出形式和它的读入形式都是相同的。现在就先从简单的数据类型──数字开始吧。</p>
<p>emacs 的数字分为整数和浮点数（和 C 比没有双精度数 double）。1， 1.，+1, -1, 536870913, 0, -0 这些都是整数。整数的范围是和机器是有关的，一般来最小范围是在 -268435456 to 268435455（29 位，<code>-2**28</code> ~ <code>2**28-1</code>）。可以从 <code>most-positive-fixnum</code> 和 <code>most-negative-fixnum</code> 两个变量得到整数的范围。</p>
<p>你可以用多种进制来输入一个整数。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#099">#b101100</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">44</span>      <span style="color:#998;font-style:italic">; 二进制</span>
</span></span><span style="display:flex;"><span><span style="color:#099">#o54</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">44</span>          <span style="color:#998;font-style:italic">; 八进制</span>
</span></span><span style="display:flex;"><span><span style="color:#099">#x2c</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">44</span>          <span style="color:#998;font-style:italic">; 十六进制</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最神奇的是你可以用 2 到 36 之间任意一个数作为基数，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#099">#24r1k</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">44</span>        <span style="color:#998;font-style:italic">; 二十四进制</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之所以最大是 36，是因为只有 <code>0-9</code> 和 <code>a-z</code> 36 个字符来表示数字。但是我想基本上不会有人会用到 emacs 的这个特性。</p>
<p>1500.0, 15e2, 15.0e2, 1.5e3, 和 .15e4 都可以用来表示一个浮点数 1500.。遵循 IEEE 标准，elisp 也有一个特殊类型的值称为 NaN (not-a-number)。你可以用 <code>(/ 0.0 0.0)</code> 产生这个数。</p>
<h3 id="测试函数">测试函数</h3>
<p>整数类型测试函数是 integerp，浮点数类型测试函数是 floatp。数字类型测试用 numberp。你可以分别运行这几个例子来试验一下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">integerp</span> <span style="color:#099">1.</span>)                           <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">integerp</span> <span style="color:#099">1.0</span>)                          <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">floatp</span> <span style="color:#099">1.</span>)                             <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">floatp</span> <span style="color:#008080">-0.0e+NaN</span>)                      <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">numberp</span> <span style="color:#099">1</span>)                             <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>还提供一些特殊测试，比如测试是否是零的 <code>zerop</code> ，还有非负整数测试的 <code>wholenump</code> 。</p>
<p>注：elisp 测试函数一般都是用 p 来结尾，p 是 predicate 的第一个字母。如果函数名是一个单词，通常只是在这个单词后加一个 p，如果是多个单词，一般是加 -p。</p>
<h3 id="数的比较">数的比较</h3>
<p>常用的比较操作符号是我们在其它言中都很熟悉的，比如 <code>&lt;, &gt;, &gt;=, &lt;=</code>，不一样的是，由于赋值是使用 set 函数，所以 <code>=</code> 不再是一个赋值运算符了，而是测试数字相等符号。和其它语言类似， <strong>对于浮点数的相等测试都是不可靠的</strong> 。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#900;font-weight:bold">-</span> (<span style="color:#900;font-weight:bold">+</span> <span style="color:#099">1.0</span> <span style="color:#099">1.0e-3</span>) <span style="color:#099">1.0</span>))       <span style="color:#998;font-style:italic">; =&gt; 0.0009999999999998899</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">bar</span> <span style="color:#099">1.0e-3</span>)                       <span style="color:#998;font-style:italic">; =&gt; 0.001</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">foo</span> <span style="color:#008080">bar</span>)                             <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以一定要确定两个浮点数是否相同，是要在一定误差内进行比较。这里给出一个函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defvar</span> <span style="color:#008080">fuzz-factor</span> <span style="color:#099">1.0e-6</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">approx-equal</span> (<span style="color:#008080">x</span> <span style="color:#008080">y</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">or</span> (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">x</span> <span style="color:#099">0</span>) (<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">y</span> <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">&lt;</span> (<span style="color:#900;font-weight:bold">/</span> (<span style="color:#900;font-weight:bold">abs</span> (<span style="color:#900;font-weight:bold">-</span> <span style="color:#008080">x</span> <span style="color:#008080">y</span>))
</span></span><span style="display:flex;"><span>            (<span style="color:#900;font-weight:bold">max</span> (<span style="color:#900;font-weight:bold">abs</span> <span style="color:#008080">x</span>) (<span style="color:#900;font-weight:bold">abs</span> <span style="color:#008080">y</span>)))
</span></span><span style="display:flex;"><span>         <span style="color:#008080">fuzz-factor</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">approx-equal</span> <span style="color:#008080">foo</span> <span style="color:#008080">bar</span>)                  <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有一个测试数字是否相等的函数 <code>eql</code> ，这是函数不仅测试数字的值是否相等，还测试数字类型是否一致，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">=</span> <span style="color:#099">1.0</span> <span style="color:#099">1</span>)                               <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">eql</span> <span style="color:#099">1.0</span> <span style="color:#099">1</span>)                             <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>elisp 没有 <code>+=, -=, /=, *=</code> 这样的命令式语言里常见符号，如果你想实现类似功能的语句，只能用赋值函数 setq 来实现了。 <code>/=</code> 符号被用来作为不等于的测试了。</p>
<h3 id="数的转换">数的转换</h3>
<p>整数向浮点数转换是通过 float 函数进行的。而浮点数转换成整数有这样几个函数：</p>
<ul>
<li><code>truncate</code> 转换成靠近 0 的整数</li>
<li><code>floor</code> 转换成最接近的不比本身大的整数</li>
<li><code>ceiling</code> 转换成最接近的不比本身小的整数</li>
<li><code>round</code> 四舍五入后的整数，换句话说和它的差绝对值最小的整数</li>
</ul>
<p>很晕是吧。自己用 1.2, 1.7, -1.2, -1.7 对这四个函数操作一遍就知道区别了（可以直接看 info。按键顺序是 <code>C-h i m elisp RET m Numeric Conversions RET</code>。以后简写成 <code>info elisp - Numeric Conversions</code>）。</p>
<p>这里提一个问题，浮点数的范围是无穷大的，而整数是有范围的，如果用前面的函数转换 1e20 成一个整数会出现什么情况呢？试试就知道了。</p>
<h3 id="数的运算">数的运算</h3>
<p>四则运算没有什么好说的，就是 <code>+ - * /</code>。值得注意的是，和 C 语言类似，如果参数都是整数，作除法时要记住 <code>(/ 5 6)</code> 是会等于 0 的。如果参数中有浮点数，整数会自动转换成浮点数进行运算，所以 <code>(/ 5 6.0)</code> 的值才会是 5/6。</p>
<p>没有 <code>++</code> 和 <code>--</code> 操作了，类似的两个函数是 <code>1+</code> 和 <code>1-</code> 。可以用 <code>setq</code> 赋值来代替 <code>++</code> 和 <code>--</code>：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#099">10</span>)                           <span style="color:#998;font-style:italic">; =&gt; 10</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#900;font-weight:bold">1+</span> <span style="color:#008080">foo</span>))                     <span style="color:#998;font-style:italic">; =&gt; 11</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#900;font-weight:bold">1-</span> <span style="color:#008080">foo</span>))                     <span style="color:#998;font-style:italic">; =&gt; 10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注：可能有人看过有 incf 和 decf 两个实现 <code>++</code> 和 <code>--</code> 操作。这两个宏是可以用的。这两个宏是 Common Lisp 里的，emacs 有模拟的 Common Lisp 的库 cl。但是 RMS 认为最好不要使用这个库。但是你可以在你的 elisp 包中使用这两个宏，只要在文件头写上：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">eval-when-compile</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">require</span> <span style="color:#990073">&#39;cl</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于 incf 和 decf 是两个宏，所以这样写不会在运行里导入 cl 库。有点离题是，总之一句话，教主说不好的东西，我们最好不要用它。其它无所谓，只可惜了两个我最常用的函数 <code>remove-if</code> 和 <code>remove-if-not</code> 。不过如果你也用 emms 的话，可以在 emms-compat 里找到这两个函数的替代品。</p>
<p><code>abs</code> 取数的绝对值。</p>
<p>有两个取整的函数，一个是符号 <code>%</code> ，一个是函数 <code>mod</code> 。这两个函数有什么差别呢？一是 <code>%</code> 的第一个参数必须是整数，而 <code>mod</code> 的第一个参数可以是整数也可以是浮点数。二是即使对相同的参数，两个函数也不一定有相同的返回值：</p>
<pre tabindex="0"><code>(+ (% DIVIDEND DIVISOR)
   (* (/ DIVIDEND DIVISOR) DIVISOR))
</code></pre><p>和 DIVIDEND 是相同的。而：</p>
<pre tabindex="0"><code>(+ (mod DIVIDEND DIVISOR)
   (* (floor DIVIDEND DIVISOR) DIVISOR))
</code></pre><p>和 DIVIDEND 是相同的。</p>
<p>三角运算有函数： sin, cos, tan, asin, acos, atan。开方函数是 sqrt。</p>
<p>exp 是以 e 为底的指数运算，expt 可以指定底数的指数运算。log 默认底数是 e，但是也可以指定底数。log10 就是 (log x 10)。logb 是以 2 为底数运算，但是返回的是一个整数。这个函数是用来计算数的位。</p>
<p>random 可以产生随机数。可以用 <code>(random t)</code> 来产生一个新种子。虽然 emacs 每次启动后调用 random 总是产生相同的随机数，但是运行过程中，你不知道调用了多少次，所以使用时还是不需要再调用一次 <code>(random t)</code> 来产生新的种子。</p>
<p>位运算这样高级的操作我就不说了，自己看 <code>info elisp - Bitwise Operations on Integers</code> 吧。</p>
<h3 id="函数列表-1">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 测试函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">integerp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">floatp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">numberp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">zerop</span> <span style="color:#008080">NUMBER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">wholenump</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 比较函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">&gt;</span> <span style="color:#008080">NUM1</span> <span style="color:#008080">NUM2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">&lt;</span> <span style="color:#008080">NUM1</span> <span style="color:#008080">NUM2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">&gt;</span> <span style="color:#a61717;background-color:#e3d2d2">::</span> <span style="color:#008080">NUM1</span> <span style="color:#008080">NUM2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">&lt;=</span> <span style="color:#008080">NUM1</span> <span style="color:#008080">NUM2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">NUM1</span> <span style="color:#008080">NUM2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">eql</span> <span style="color:#008080">OBJ1</span> <span style="color:#008080">OBJ2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">/=</span> <span style="color:#008080">NUM1</span> <span style="color:#008080">NUM2</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 转换函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">float</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">truncate</span> <span style="color:#008080">ARG</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIVISOR</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">floor</span> <span style="color:#008080">ARG</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIVISOR</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">ceiling</span> <span style="color:#008080">ARG</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIVISOR</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">round</span> <span style="color:#008080">ARG</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIVISOR</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 运算</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">NUMBERS-OR-MARKERS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">NUMBER-OR-MARKER</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">MORE-NUMBERS-OR-MARKERS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">NUMBERS-OR-MARKERS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">/</span> <span style="color:#008080">DIVIDEND</span> <span style="color:#008080">DIVISOR</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">DIVISORS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">1+</span> <span style="color:#008080">NUMBER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">1-</span> <span style="color:#008080">NUMBER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">abs</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">%</span> <span style="color:#008080">X</span> <span style="color:#008080">Y</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">mod</span> <span style="color:#008080">X</span> <span style="color:#008080">Y</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">sin</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cos</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">tan</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">asin</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">acos</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">atan</span> <span style="color:#008080">Y</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">X</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">sqrt</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">exp</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">expt</span> <span style="color:#008080">ARG1</span> <span style="color:#008080">ARG2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">log</span> <span style="color:#008080">ARG</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BASE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">log10</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">logb</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 随机数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">random</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="变量列表">变量列表</h3>
<pre tabindex="0"><code>most-positive-fixnum
most-negative-fixnum
</code></pre><h2 id="基本数据类型之二--字符和字符串">基本数据类型之二 – 字符和字符串</h2>
<p>在 emacs 里字符串是有序的字符数组。和 c 语言的字符串数组不同，emacs 的字符串可以容纳任何字符，包括 <code>\0</code>:</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;abc\000abc&#34;</span>)                 <span style="color:#998;font-style:italic">; =&gt; &#34;abc^@abc&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于字符串有很多高级的属性，例如字符串的表示有单字节和多字节类型，字符串可以有文本属性（text property）等等。但是对于刚接触字符串，还是先学一些基本操作吧。</p>
<p>首先 <strong>构成字符串的字符其实就是一个整数</strong> 。一个字符 ‘A’ 就是一个整数 65。但是目前字符串中的字符被限制在 0-524287 之间。<strong>字符的读入语法是在字符前加上一个问号</strong>，比如 ?A 代表字符 ‘A’。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#008080">?A</span>                                      <span style="color:#998;font-style:italic">; =&gt; 65</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?a</span>                                      <span style="color:#998;font-style:italic">; =&gt; 97</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>对于标点来说，也可以用同样的语法，但是最好在前面加上转义字符 <code>\</code></strong> ，因为有些标点会有岐义，比如 <code>?\(</code>。 \ 必须用 ?\ 表示。控制字符，退格、制表符，换行符，垂直制表符，换页符，空格，回车，删除和 escape 表示为 <code>?\a</code>, <code>?\b</code>, <code>?\t</code>, <code>?\n</code>, <code>?\v</code>, <code>?\f</code>, <code>?\s</code>, <code>?\r</code>, <code>?\d</code>, 和 <code>?\e</code>。对于没有特殊意义的字符，加上转义字符 \ 是没有副作用的，比如 <code>?\+</code> 和 <code>?+</code> 是完全一样的。所以标点还是都用转义字符来表示吧。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#008080">?\a</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">7</span>                 <span style="color:#998;font-style:italic">; control-g, `C-g&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\b</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">8</span>                 <span style="color:#998;font-style:italic">; backspace, &lt;BS&gt;, `C-h&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\t</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">9</span>                 <span style="color:#998;font-style:italic">; tab, &lt;TAB&gt;, `C-i&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\n</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">10</span>                <span style="color:#998;font-style:italic">; newline, `C-j&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\v</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">11</span>                <span style="color:#998;font-style:italic">; vertical tab, `C-k&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\f</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">12</span>                <span style="color:#998;font-style:italic">; formfeed character, `C-l&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\r</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">13</span>                <span style="color:#998;font-style:italic">; carriage return, &lt;RET&gt;, `C-m&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\e</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">27</span>                <span style="color:#998;font-style:italic">; escape character, &lt;ESC&gt;, `C-[&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\s</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">32</span>                <span style="color:#998;font-style:italic">; space character, &lt;SPC&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\\</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">92</span>                <span style="color:#998;font-style:italic">; backslash character, `\&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\d</span> <span style="color:#008080">=&gt;</span> <span style="color:#099">127</span>               <span style="color:#998;font-style:italic">; delete character, &lt;DEL&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>控制字符可以有多种表示方式，比如 <code>C-i</code>，这些都是对的：</p>
<pre tabindex="0"><code>?\^I  ?\^i  ?\C-I  ?\C-i 
</code></pre><p>它们都对应数字 9。</p>
<p>meta 字符是用 修饰键（通常就是 Alt 键）输入的字符。之所以称为修饰键，是因为这样输入的字符就是在其修饰字符的第 27 位由 0 变成 1 而成，也就是如下操作：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">logior</span> (<span style="color:#008080">lsh</span> <span style="color:#099">1</span> <span style="color:#099">27</span>) <span style="color:#008080">?A</span>)                  <span style="color:#998;font-style:italic">; =&gt; 134217793</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">?\M-A</span>                                   <span style="color:#998;font-style:italic">; =&gt; 134217793</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>你可以用 <code>\M-</code> 代表 meta 键，加上修饰的字符就是新生成的字符。比如：<code>?\M-A</code>, <code>?\M-\C-b</code>. 后面这个也可以写成 <code>?\C-\M-b</code>。</p>
<p>如果你还记得前面说过字符串里的字符不能超过 524287 的话，这就可以看出字符串是不能放下一个 meta 字符的。所以按键序列在这时只能用 vector 来储存。</p>
<p>其它的修饰键也是类似的。emacs 用 <code>2**25</code> 位来表示 shift 键，<code>2**24</code> 对应 hyper，<code>2**23</code> 对应 super，<code>2**22</code> 对应 alt。</p>
<h3 id="测试函数-1">测试函数</h3>
<p>字符串测试使用 <code>stringp</code> ，没有 charp，因为字符就是整数。 <code>string-or-null-p</code> 当对象是一个字符或 nil 时返回 t。 <code>char-or-string-p</code> 测试是否是字符串或者字符类型。比较头疼的是 emacs 没有测试字符串是否为空的函数。这是我用的这个测试函数，使用前要测试字符串是否为 nil：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">string-emptyp</span> (<span style="color:#008080">str</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">not</span> (<span style="color:#900;font-weight:bold">string&lt;</span> <span style="color:#d14">&#34;&#34;</span> <span style="color:#008080">str</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="构造函数">构造函数</h3>
<p>产生一个字符串可以用 <code>make-string</code> 。这样生成的字符串包含的字符都是一样的。要生成不同的字符串可以用 <code>string</code> 函数。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">make-string</span> <span style="color:#099">5</span> <span style="color:#008080">?x</span>)                      <span style="color:#998;font-style:italic">; =&gt; &#34;xxxxx&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">string</span> <span style="color:#008080">?a</span> <span style="color:#008080">?b</span> <span style="color:#008080">?c</span>)                       <span style="color:#998;font-style:italic">; =&gt; &#34;abc&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在已有的字符串生成新的字符串的方法有 <code>substring, concat</code> 。 <code>substring</code> 的后两个参数是起点和终点的位置。如果终点越界或者终点比起点小都会产生一个错误。这个在使用 <code>substring</code> 时要特别小心。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">substring</span> <span style="color:#d14">&#34;0123456789&#34;</span> <span style="color:#099">3</span>)              <span style="color:#998;font-style:italic">; =&gt; &#34;3456789&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">substring</span> <span style="color:#d14">&#34;0123456789&#34;</span> <span style="color:#099">3</span> <span style="color:#099">5</span>)            <span style="color:#998;font-style:italic">; =&gt; &#34;34&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">substring</span> <span style="color:#d14">&#34;0123456789&#34;</span> <span style="color:#099">-3</span> <span style="color:#099">-1</span>)          <span style="color:#998;font-style:italic">; =&gt; &#34;78&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>concat</code> 函数相对简单，就是把几个字符串连接起来。</p>
<blockquote>
<p>:: 字符串的切片和拼接，编程必备！</p>
</blockquote>
<h3 id="字符串比较">字符串比较</h3>
<p><code>char-equal</code> 可以比较两个字符是否相等。与整数比较不同，这个函数还考虑了大小写。如果 <code>case-fold-search</code> 变量是 <code>t</code> 时，这个函数的字符比较是忽略大小写的。编程时要小心，因为通常 <code>case-fold-search</code> 都是 t，这样如果要考虑字符的大小写时就不能用 <code>char-equal</code> 函数了。</p>
<p>字符串比较使用 <code>string=</code> ，string-equal 是一个别名。</p>
<p><code>string&lt;</code> 是按字典序比较两个字符串， <code>string-less</code> 是它的别名。<strong>空字符串小于所有字符串，除了空字符串</strong>。前面 <code>string-emptyp</code> 就是用这个特性。当然直接用 <code>length</code> 检测字符串长度应该也可以，还可以省去检测字符串是否为空。没有 <del><code>string&gt;</code></del> 函数。</p>
<h3 id="转换函数">转换函数</h3>
<p>字符转换成字符串可以用 <code>char-to-string</code> 函数，字符串转换成字符可以用 <code>string-to-char</code> ，当然只是返回字符串的第一个字符。</p>
<p>数字和字符串之间的转换可以用 <code>number-to-string</code> 和 <code>string-to-number</code> 。其中 <code>string-to-number</code> 可以设置字符串的进制，可以从 2 到 16。 <code>number-to-string</code> 只能转换成 10 进制的数字。如果要输出八进制或者十六进制，可以用 <code>format</code> 函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">string-to-number</span> <span style="color:#d14">&#34;256&#34;</span>)                <span style="color:#998;font-style:italic">; =&gt; 256</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">number-to-string</span> <span style="color:#099">256</span>)                  <span style="color:#998;font-style:italic">; =&gt; &#34;256&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">format</span> <span style="color:#d14">&#34;%#o&#34;</span> <span style="color:#099">256</span>)                      <span style="color:#998;font-style:italic">; =&gt; &#34;0400&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">format</span> <span style="color:#d14">&#34;%#x&#34;</span> <span style="color:#099">256</span>)                      <span style="color:#998;font-style:italic">; =&gt; &#34;0x100&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果要输出成二进制，好像没有现成的函数了。calculator 库倒是可以，这是我写的函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">number-to-bin-string</span> (<span style="color:#458;font-weight:bold">number</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">require</span> <span style="color:#990073">&#39;calculator</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">calculator-output-radix</span> <span style="color:#990073">&#39;bin</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">calculator-radix-grouping-mode</span> <span style="color:#008080">nil</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">calculator-number-to-string</span> <span style="color:#458;font-weight:bold">number</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">number-to-bin-string</span> <span style="color:#099">256</span>)              <span style="color:#998;font-style:italic">; =&gt; &#34;100000000&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其它数据类型现在还没有学到，不过可以先了解一下吧。 <code>concat</code> 可以把一个字符构成的列表或者向量转换成字符串， <code>vconcat</code> 可以把一个字符串转换成一个向量， <code>append</code> 可以把一个字符串转换成一个列表。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">concat</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">?a</span> <span style="color:#008080">?b</span> <span style="color:#008080">?c</span> <span style="color:#008080">?d</span> <span style="color:#008080">?e</span>))              <span style="color:#998;font-style:italic">; =&gt; &#34;abcde&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">concat</span> <span style="color:#008080">[?a</span> <span style="color:#008080">?b</span> <span style="color:#008080">?c</span> <span style="color:#008080">?d</span> <span style="color:#008080">?e]</span>)               <span style="color:#998;font-style:italic">; =&gt; &#34;abcde&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">vconcat</span> <span style="color:#d14">&#34;abdef&#34;</span>)                       <span style="color:#998;font-style:italic">; =&gt; [97 98 100 101 102]</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">append</span> <span style="color:#d14">&#34;abcdef&#34;</span> <span style="color:#008080">nil</span>)                   <span style="color:#998;font-style:italic">; =&gt; (97 98 99 100 101 102)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>大小写转换使用的是 <code>downcase</code> 和 <code>upcase</code> 两个函数。这两个函数的参数既可以字符串，也可以是字符。<code>capitalize</code> 可以使字符串中单词的第一个字符大写，其它字符小写。 <del><code>upcase-initials</code> 只使第一个单词的第一个字符大写，其它字符小写。</del> 这两个函数的参数如果是一个字符，那么只让这个字符大写。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">downcase</span> <span style="color:#d14">&#34;The cat in the hat&#34;</span>)         <span style="color:#998;font-style:italic">; =&gt; &#34;the cat in the hat&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">downcase</span> <span style="color:#008080">?X</span>)                           <span style="color:#998;font-style:italic">; =&gt; 120</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">upcase</span> <span style="color:#d14">&#34;The cat in the hat&#34;</span>)           <span style="color:#998;font-style:italic">; =&gt; &#34;THE CAT IN THE HAT&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">upcase</span> <span style="color:#008080">?x</span>)                             <span style="color:#998;font-style:italic">; =&gt; 88</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">capitalize</span> <span style="color:#d14">&#34;The CAT in tHe hat&#34;</span>)       <span style="color:#998;font-style:italic">; =&gt; &#34;The Cat In The Hat&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">upcase-initials</span> <span style="color:#d14">&#34;The CAT in the hAt&#34;</span>)  <span style="color:#998;font-style:italic">; =&gt; &#34;The CAT In The HAt&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>💡 这里 <code>upcase-initials</code> 的作用应该是使单词的第一个字符大写，其它字符大小写保持不变。</p>
</blockquote>
<h3 id="格式化字符串">格式化字符串</h3>
<p><code>format</code> 类似于 C 语言里的 <code>printf</code> 可以实现对象的字符串化。数字的格式化和 <code>printf</code> 的参数差不多，值得一提的是 <code>&quot;%S&quot;</code> 这个格式化形式，它可以把对象的输出形式转换成字符串，这在调试时是很有用的。</p>
<h3 id="查找和替换">查找和替换</h3>
<p>字符串查找的核心函数是 <code>string-match</code> 。这个函数可以 <strong>从指定的位置对字符串进行正则表达式匹配</strong> ，如果匹配成功，则返回匹配的起点，如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;34&#34;</span> <span style="color:#d14">&#34;01234567890123456789&#34;</span>)    <span style="color:#998;font-style:italic">; =&gt; 3</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;34&#34;</span> <span style="color:#d14">&#34;01234567890123456789&#34;</span> <span style="color:#099">10</span>) <span style="color:#998;font-style:italic">; =&gt; 13</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意 <code>string-match</code> 的参数是一个 regexp。 emacs 好象没有内建的查找子串的函数。如果你想把 <code>string-match</code> 作为一个查找子串的函数，可以先用 <code>regexp-quote</code> 函数先处理一下子串。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;2*&#34;</span> <span style="color:#d14">&#34;232*3=696&#34;</span>)                <span style="color:#998;font-style:italic">; =&gt; 0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">string-match</span> (<span style="color:#008080">regexp-quote</span> <span style="color:#d14">&#34;2*&#34;</span>) <span style="color:#d14">&#34;232*3=696&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; 2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>事实上， <code>string-match</code> 不只是查找字符串，它更重要的功能是捕捉匹配的字符串。如果你对正则表达式不了解，可能需要先找一本书，先了解一下什么是正则表达式。 <code>string-match</code> 在查找的同时，还会记录下每个要捕捉的字符串的位置。这个位置可以在匹配后用 <code>match-data</code>、 <code>match-beginning</code> 和 <code>match-end</code> 等函数来获得。先看一下例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;3\\(4\\)&#34;</span> <span style="color:#d14">&#34;01234567890123456789&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">match-data</span>))                         <span style="color:#998;font-style:italic">; =&gt; (3 5 4 5)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后返回这个数字是什么意思呢？正则表达式捕捉的字符串按括号的顺序对应一个序号，整个模式对应序号 0，第一个括号对应序号 1，第二个括号对应序号 2，以此类推。所以 “3(4)” 这个正则表达式中有序号 0 和 1，最后 <code>match-data</code> 返回的一系列数字对应的分别是要捕捉字符串的起点和终点位置，也就是说子串 “34” 起点从位置 3 开始，到位置 5 结束，而捕捉的字符串 “4” 的起点是从 4 开始，到 5 结束。这些位置可以用 <code>match-beginning</code> 和 <code>match-end</code> 函数用对应的序号得到。要注意的是，起点位置是捕捉字符串的第一个字符的位置，而终点位置不是捕捉的字符串最后一个字符的位置，而是下一个字符的位置。这个性质对于循环是很方便的。比如要查找上面这个字符串中所有 34 出现的位置：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">start</span> <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">while</span> (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;34&#34;</span> <span style="color:#d14">&#34;01234567890123456789&#34;</span> <span style="color:#008080">start</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#900;font-weight:bold">princ</span> (<span style="color:#900;font-weight:bold">format</span> <span style="color:#d14">&#34;find at %d\n&#34;</span> (<span style="color:#008080">match-beginning</span> <span style="color:#099">0</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">start</span> (<span style="color:#008080">match-end</span> <span style="color:#099">0</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><p>查找会了，就要学习替换了。替换使用的函数是 <code>replace-match</code> 。这个函数既可以用于字符串的替换，也可以用于缓冲区的文本替换。对于字符串的替换， <code>replace-match</code> 只是按给定的序号把字符串中的那一部分用提供的字符串替换了而已：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">str</span> <span style="color:#d14">&#34;01234567890123456789&#34;</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;34&#34;</span> <span style="color:#008080">str</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">princ</span> (<span style="color:#008080">replace-match</span> <span style="color:#d14">&#34;x&#34;</span> <span style="color:#008080">nil</span> <span style="color:#008080">nil</span> <span style="color:#008080">str</span> <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">princ</span> <span style="color:#d14">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">princ</span> <span style="color:#008080">str</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出 <code>replace-match</code> 返回的字符串是替换后的新字符串，原字符串被没有改变。</p>
<p>如果你想挑战一下，想想怎样把上面这个字符串中所有的 34 都替换掉？如果想就使用同一个字符串来存储，可能对于固定的字符串，这个还容易一些，如果不是的话，就要花一些脑筋了，因为替换之后，新的字符串下一个搜索起点的位置就不能用 <code>(match-end 0)</code> 给出来的位置了，而是要扣除替换的字符串和被替换的字符串长度的差值。</p>
<p>emacs 对字符串的替换有一个函数 <code>replace-regexp-in-string</code> 。这个函数的实现方法是把每次匹配部分之前的子串收集起来，最后再把所有字符串连接起来。</p>
<p>单字符的替换有 <code>subst-char-in-string</code> 函数。但是 emacs 没有类似 perl 函数或者程序 tr 那样进行字符替换的函数。只能自己建表进行循环操作了。</p>
<h3 id="函数列表-2">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 测试函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">stringp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">string-or-null-p</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">char-or-string-p</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 构建函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">make-string</span> <span style="color:#008080">LENGTH</span> <span style="color:#008080">INIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">CHARACTERS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">substring</span> <span style="color:#008080">STRING</span> <span style="color:#008080">FROM</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">TO</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">concat</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">SEQUENCES</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 比较函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">char-equal</span> <span style="color:#008080">C1</span> <span style="color:#008080">C2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">string=</span> <span style="color:#008080">S1</span> <span style="color:#008080">S2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">string-equal</span> <span style="color:#008080">S1</span> <span style="color:#008080">S2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">string&lt;</span> <span style="color:#008080">S1</span> <span style="color:#008080">S2</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 转换函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">char-to-string</span> <span style="color:#008080">CHAR</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">string-to-char</span> <span style="color:#008080">STRING</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">number-to-string</span> <span style="color:#008080">NUMBER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">string-to-number</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BASE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">downcase</span> <span style="color:#008080">OBJ</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">upcase</span> <span style="color:#008080">OBJ</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">capitalize</span> <span style="color:#008080">OBJ</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">upcase-initials</span> <span style="color:#008080">OBJ</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">format</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">OBJECTS</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 查找与替换</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">string-match</span> <span style="color:#008080">REGEXP</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">START</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">replace-match</span> <span style="color:#008080">NEWTEXT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FIXEDCASE</span> <span style="color:#008080">LITERAL</span> <span style="color:#008080">STRING</span> <span style="color:#008080">SUBEXP</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">replace-regexp-in-string</span> <span style="color:#008080">REGEXP</span> <span style="color:#008080">REP</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FIXEDCASE</span> <span style="color:#008080">LITERAL</span> <span style="color:#008080">SUBEXP</span> <span style="color:#008080">START</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">subst-char-in-string</span> <span style="color:#008080">FROMCHAR</span> <span style="color:#008080">TOCHAR</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">INPLACE</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="基本数据类型之三--cons-cell-和列表">基本数据类型之三 – cons cell 和列表</h2>
<p>如果从概念上来说，cons cell 其实非常简单的，就是两个有顺序的元素。第一个叫 CAR，第二个就 CDR。CAR 和 CDR 名字来自于 Lisp。它最初在 IBM 704 机器上的实现。在这种机器有一种取址模式，使人可以访问一个存储地址中的“地址（address）”部分和“减量（decrement）”部分。CAR 指令用于取出地址部分，表示 (Contents of Address part of Register)，CDR 指令用于取出地址的减量部分 (Contents of the Decrement part of Register)。cons cell 也就是 construction of cells。car 函数用于取得 cons cell 的 CAR 部分，cdr 取得 cons cell 的 CDR 部分。cons cell 如此简单，但是它却能衍生出许多高级的数据结构，比如链表，树，关联表等等。</p>
<p>cons cell 的读入语法是用 <code>.</code> 分开两个部分，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">2</span>)                                <span style="color:#998;font-style:italic">; =&gt; (1 . 2)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">?a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">1</span>)                               <span style="color:#998;font-style:italic">; =&gt; (97 . 1)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#d14">&#34;a&#34;</span>)                              <span style="color:#998;font-style:italic">; =&gt; (1 . &#34;a&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">nil</span>)                              <span style="color:#998;font-style:italic">; =&gt; (1)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">nil</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">nil</span>)                            <span style="color:#998;font-style:italic">; =&gt; (nil)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意到前面的表达式中都有一个 <code>'</code> 号，这是什么意思呢？其实理解了 <code>eval-last-sexp</code> 的作用就能明白了。 <code>eval-last-sexp</code> 其实包含了两个步骤， <strong>一是读入前一个 S-表达式，二是对读入的 S-表达式求值</strong> 。这样如果读入的 S-表达式是一个 cons cell 的话，求值时会把这个 cons cell 的第一个元素作为一个函数来调用。而事实上，前面这些例子的第一个元素都不是一个函数，这样就会产生一个错误 invalid-function。之所以前面没有遇到这个问题，那是因为前面数字和字符串是一类特殊的 S-表达式，它们求值后和求值前是不变，称为 <strong>自求值表达式</strong> （self-evaluating form）。 <code>'</code> 号其实是一个特殊的函数 <code>quote</code> ，它的作用是 <strong>将它的参数返回而不作求值</strong> 。 <code>'(1 . 2)</code> 等价于 <code>(quote (1 . 2))</code>。为了证明 cons cell 的读入语法确实就是它的输出形式，可以看下面这个语句：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">read</span> <span style="color:#d14">&#34;(1 . 2)&#34;</span>)                        <span style="color:#998;font-style:italic">; =&gt; (1 . 2)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>列表包括了 cons cell。但是列表中有一个特殊的元素 - 空表 <code>nil</code> 。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#008080">nil</span>                                     <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>()                                     <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>空表不是一个 cons cell，因为它没有 CAR 和 CDR 两个部分，事实上空表里没有任何内容。但是为了编程的方便，可以认为 nil 的 CAR 和 CDR 都是 nil：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">nil</span>)                               <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">nil</span>)                               <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>按列表最后一个 cons cell 的 CDR 部分的类型分，可以把列表分为三类。如果它是 nil 的话，这个列表也称为“真列表”(true list)。如果既不是 nil 也不是一个 cons cell，则这个列表称为“点列表”(dotted list)。还有一种可能，它指向列表中之前的一个 cons cell，则称为环形列表 (circular list)。这里分别给出一个例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>)                                  <span style="color:#998;font-style:italic">; =&gt; (1 2 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">3</span>)                                <span style="color:#998;font-style:italic">; =&gt; (1 2 . 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#000;font-weight:bold">#1=</span>(<span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#000;font-weight:bold">#1#</span>))                     <span style="color:#998;font-style:italic">; =&gt; (1 2 3 . #1)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这个例子可以看出前两种列表的读入语法和输出形式都是相同的，而环形列表的读入语法是很古怪的，输出形式不能作为环形列表的读入形式。</p>
<p>如果把真列表最后一个 cons cell 的 nil 省略不写，也就是 <code>(1 . nil)</code> 简写成 <code>(1)</code> ，把 <code>( obj1 . ( obj2 . list))</code> 简写成 <code>(obj1 obj2 . list)</code> ，那么列表最后可以写成一个用括号括起的元素列表：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> (<span style="color:#099">2</span> <span style="color:#000;font-weight:bold">.</span> (<span style="color:#099">3</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">nil</span>)))                  <span style="color:#998;font-style:italic">; =&gt; (1 2 3)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>尽管这样写是清爽多了，但是，我觉得看一个列表时还是在脑子里反映的前面的形式，这样在和复杂的 cons cell 打交道时就不会搞不清楚这个 cons cell 的 CDR 是一个列表呢，还是一个元素或者是嵌套的列表。</p>
<h3 id="测试函数-2">测试函数</h3>
<p>测试一个对象是否是 cons cell 用 <code>consp</code> ，是否是列表用 <code>listp</code> 。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">consp</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">2</span>))                        <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">consp</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> (<span style="color:#099">2</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">nil</span>)))                <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">consp</span> <span style="color:#008080">nil</span>)                             <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">listp</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">2</span>))                        <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">listp</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">.</span> (<span style="color:#099">2</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">nil</span>)))                <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">listp</span> <span style="color:#008080">nil</span>)                             <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>没有内建的方法测试一个列表是不是一个真列表。通常如果一个函数需要一个真列表作为参数，都是在运行时发出错误，而不是进行参数检查，因为检查一个列表是真列表的代价比较高。</p>
<p>测试一个对象是否是 nil 用 null 函数。只有当对象是空表时，null 才返回空值。</p>
<h3 id="构造函数-1">构造函数</h3>
<p>生成一个 cons cell 可以用 <code>cons</code> 函数。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">cons</span> <span style="color:#099">1</span> <span style="color:#099">2</span>)                              <span style="color:#998;font-style:italic">; =&gt; (1 . 2)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">cons</span> <span style="color:#099">1</span> <span style="color:#000;font-weight:bold">&#39;</span>())                            <span style="color:#998;font-style:italic">; =&gt; (1)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也是在列表前面增加元素的方法。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span>))                       <span style="color:#998;font-style:italic">; =&gt; (a b)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">cons</span> <span style="color:#990073">&#39;x</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (x a b)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>值得注意的是前面这个例子的 foo 值并没有改变。事实上有一个宏 push 可以加入元素的同时改变列表的值：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">push</span> <span style="color:#990073">&#39;x</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (x a b)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (x a b)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成一个列表的函数是 <code>list</code> 。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">list</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>)                            <span style="color:#998;font-style:italic">; =&gt; (1 2 3)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可能这时你有一个疑惑，前面产生一个列表，我常用 <code>quote</code> （也就是 <code>'</code> 符号）这个函数，它和这个 <code>cons</code> 和 <code>list</code> 函数有什么区别呢？其实区别是很明显的，<code>quote</code> 是把参数直接返回不进行求值，而 <code>list</code> 和 <code>cons</code> 是对参数求值后再生成一个列表或者 cons cell。看下面这个例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#900;font-weight:bold">+</span> <span style="color:#099">1</span> <span style="color:#099">2</span>) <span style="color:#099">3</span>)                            <span style="color:#998;font-style:italic">; =&gt; ((+ 1 2) 3)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">list</span> (<span style="color:#900;font-weight:bold">+</span> <span style="color:#099">1</span> <span style="color:#099">2</span>) <span style="color:#099">3</span>)                        <span style="color:#998;font-style:italic">; =&gt; (3 3)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>前一个生成的列表的 CAR 部分是 <code>(+ 1 2)</code> 这个列表，而后一个是先对 <code>(+ 1 2)</code> 求值得到 <code>3</code> 后再生成列表。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/05-cons-cell.html#answer-list">思考题</a></p>
<p>如果你觉得你有点明白的话，我提一个问题考考你：怎样用 <code>list</code> 函数构造一个 <code>(a b c)</code> 这样的列表呢？</p>
</blockquote>
<p>前面提到在列表前端增加元素的方法是用 <code>cons</code> ，在列表后端增加元素的函数是用 <code>append</code> 。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">append</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span>) <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">c</span>))                    <span style="color:#998;font-style:italic">; =&gt; (a b c)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>append</code> 的功能可以认为它是把第一个参数最后一个列表的 <code>nil</code> 换成第二个参数，比如前面这个例子，第一个参数写成 cons cell 表示方式是 <code>(a . (b . nil))</code> ，把这个 <code>nil</code> 替换成 <code>(c)</code> 就成了 <code>(a . (b . (c)))</code> 。对于多个参数的情况也是一样的，依次把下一个参数替换新列表最后一个 nil 就是最后的结果了。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">append</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span>) <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">c</span>) <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">d</span>))               <span style="color:#998;font-style:italic">; =&gt; (a b c d)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>一般来说 <code>append</code> 的参数都要是列表，但是最后一个参数可以不是一个列表，这也不违背前面说的，因为 cons cell 的 CDR 部分本来就可以是任何对象：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">append</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span>) <span style="color:#990073">&#39;c</span>)                      <span style="color:#998;font-style:italic">; =&gt; (a b . c)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样得到的结果就不再是一个真列表了，如果再进行 append 操作就会产生一个错误。</p>
<p>如果你写过 c 的链表类型，可能就知道如果链表只保留一个指针，那么链表只能在一端增加元素。elisp 的列表类型也是类似的，用 cons 在列表前增加元素比用 append 要快得多。</p>
<p><code>append</code> 的参数不限于列表，还可以是字符串或者向量。前面字符串里已经提到可以把一个字符串转换成一个字符列表，同样可能把向量转换成一个列表：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">append</span> <span style="color:#008080">[a</span> <span style="color:#008080">b]</span> <span style="color:#d14">&#34;cd&#34;</span> <span style="color:#008080">nil</span>)                 <span style="color:#998;font-style:italic">; =&gt; (a b 99 100)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意前面最后一个参数 nil 是必要的，不然你可以想象得到的结果是什么 – <code>(a b . &quot;cd&quot;)</code>。</p>
<h3 id="把列表当数组用">把列表当数组用</h3>
<p>要得到列表或者 cons cell 里元素，唯一的方法是用 car 和 cdr 函数。很容易明白，car 就是取得 cons cell 的 CAR 部分，cdr 函数就是取得 cons cell 的 CDR 部分。通过这两个函数，我们就能访问 cons cell 和列表中的任何元素。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/05-cons-cell.html#answer-nthcdr">思考题</a></p>
<p>你如果知道 elisp 的函数如果定义，并知道 if 的使用方法，不妨自己写一个函数来取得一个列表的第 n 个 CDR。</p>
</blockquote>
<p>通过使用 elisp 提供的函数，我们事实上是可以把列表当数组来用。依惯例，我们用 car 来访问列表的第一个元素，cadr 来访问第二个元素，再往后就没有这样的函数了，可以用 nth 函数来访问：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">0</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span> <span style="color:#099">5</span>))                  <span style="color:#998;font-style:italic">; =&gt; 3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>获得列表一个区间的函数有 nthcdr、last 和 butlast。nthcdr 和 last 比较类似，它们都是返回列表后端的列表。nthcdr 函数返回第 n 个元素后的列表：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nthcdr</span> <span style="color:#099">2</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">0</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span> <span style="color:#099">5</span>))               <span style="color:#998;font-style:italic">; =&gt; (2 3 4 5)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>last 函数返回倒数 n 个长度的列表：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">last</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">0</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span> <span style="color:#099">5</span>) <span style="color:#099">2</span>)                 <span style="color:#998;font-style:italic">; =&gt; (4 5)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>butlast 和前两个函数不同，返回的除了倒数 n 个元素的列表。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">butlast</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">0</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span> <span style="color:#099">5</span>) <span style="color:#099">2</span>)              <span style="color:#998;font-style:italic">; =&gt; (0 1 2 3)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/05-cons-cell.html#answer-subseq">思考题</a></p>
<p>如何得到某个区间（比如从 3 到 5 之间）的列表（提示列表长度可以用 length 函数得到）：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">my-subseq</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">0</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span> <span style="color:#099">5</span>) <span style="color:#099">2</span> <span style="color:#099">5</span>)          <span style="color:#998;font-style:italic">; =&gt; (2 3 4)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>使用前面这几个函数访问列表是没有问题了。但是你也可以想象，链表这种数据结构是不适合随机访问的，代价比较高，如果你的代码中频繁使用这样的函数或者对一个很长的列表使用这样的函数，就应该考虑是不是应该用数组来实现。</p>
<p>直到现在为止，我们用到的函数都不会修改一个已有的变量。这是函数式编程的一个特点。只用这些函数编写的代码是很容易调试的，因为你不用去考虑一个变量在执行一个代码后就改变了，不用考虑变量的引用情况等等。下面就要结束这样轻松的学习了。</p>
<p>首先学习怎样修改一个 cons cell 的内容。首先 setcar 和 setcdr 可以修改一个 cons cell 的 CAR 部分和 CDR 部分。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span> <span style="color:#008080">c</span>))                     <span style="color:#998;font-style:italic">; =&gt; (a b c)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcar</span> <span style="color:#008080">foo</span> <span style="color:#990073">&#39;x</span>)                         <span style="color:#998;font-style:italic">; =&gt; x</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (x b c)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcdr</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">y</span> <span style="color:#008080">z</span>))                     <span style="color:#998;font-style:italic">; =&gt; (y z)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (x y z)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/05-cons-cell.html#answer-cirlist">思考题</a></p>
<p>好像很简单是吧。我出一个比较 bt 的一个问题，下面代码运行后 foo 是什么东西呢？</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span> <span style="color:#008080">c</span>))                     <span style="color:#998;font-style:italic">; =&gt; (a b c)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcdr</span> <span style="color:#008080">foo</span> <span style="color:#008080">foo</span>)
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>现在来考虑一下，怎样像数组那样直接修改列表。使用 setcar 和 nthcdr 的组合就可以实现了：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>))                     <span style="color:#998;font-style:italic">; =&gt; (1 2 3)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcar</span> <span style="color:#008080">foo</span> <span style="color:#990073">&#39;a</span>)                         <span style="color:#998;font-style:italic">; =&gt; a</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcar</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">foo</span>) <span style="color:#990073">&#39;b</span>)                   <span style="color:#998;font-style:italic">; =&gt; b</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcar</span> (<span style="color:#900;font-weight:bold">nthcdr</span> <span style="color:#099">2</span> <span style="color:#008080">foo</span>) <span style="color:#990073">&#39;c</span>)              <span style="color:#998;font-style:italic">; =&gt; c</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (a b c)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="把列表当堆栈用">把列表当堆栈用</h3>
<p>前面已经提到过可以用 push 向列表头端增加元素，在结合 pop 函数，列表就可以做为一个堆栈了。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#008080">nil</span>)                          <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">push</span> <span style="color:#990073">&#39;a</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (a)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">push</span> <span style="color:#990073">&#39;b</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (b a)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">pop</span> <span style="color:#008080">foo</span>)                               <span style="color:#998;font-style:italic">; =&gt; b</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (a)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="重排列表">重排列表</h3>
<p>如果一直用 push 往列表里添加元素有一个问题是这样得到的列表和加入的顺序是相反的。通常我们需要得到一个反向的列表。reverse 函数可以做到这一点：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span> <span style="color:#008080">c</span>))                     <span style="color:#998;font-style:italic">; =&gt; (a b c)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">reverse</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (c b a)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意的是使用 reverse 后 foo 值并没有改变。不要怪我太啰唆，如果你看到一个函数 nreverse，而且确实它能返回逆序的列表，不明所以就到处乱用，迟早会写出一个错误的函数。这个 nreverse 和前面的 reverse 差别就在于它是一个有破坏性的函数，也就是说它会修改它的参数。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nreverse</span> <span style="color:#008080">foo</span>)                          <span style="color:#998;font-style:italic">; =&gt; (c b a)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (a)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为什么现在 foo 指向的是列表的末端呢？如果你实现过链表就知道，逆序操作是可以在原链表上进行的，这样原来头部指针会变成链表的尾端。列表也是（应该是，我也没有看过实现）这个原理。使用 nreverse 的唯一的好处是速度快，省资源。所以如果你只是想得到逆序后的列表就放心用 nreverse，否则还是用 reverse 的好。</p>
<p>elisp 还有一些是具有破坏性的函数。最常用的就是 sort 函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">3</span> <span style="color:#099">2</span> <span style="color:#099">4</span> <span style="color:#099">1</span> <span style="color:#099">5</span>))                 <span style="color:#998;font-style:italic">; =&gt; (3 2 4 1 5)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">sort</span> <span style="color:#008080">foo</span> <span style="color:#990073">&#39;&lt;</span>)                           <span style="color:#998;font-style:italic">; =&gt; (1 2 3 4 5)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (3 4 5)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这一点请一定要记住，我就曾经在 sort 函数上犯了好几次错误。那如果我既要保留原列表，又要进行 sort 操作怎么办呢？可以用 copy-sequence 函数。这个函数只对列表进行复制，返回的列表的元素还是原列表里的元素，不会拷贝列表的元素。</p>
<p>nconc 和 append 功能相似，但是它会修改除最后一个参数以外的所有的参数，nbutlast 和 butlast 功能相似，也会修改参数。这些函数都是在效率优先时才使用。总而言之，以 n 开头的函数都要慎用。</p>
<h3 id="把列表当集合用">把列表当集合用</h3>
<p>列表可以作为无序的集合。合并集合用 append 函数。去除重复的 equal 元素用 delete-dups。查找一个元素是否在列表中，如果测试函数是用 eq，就用 memq，如果测试用 equal，可以用 member。删除列表中的指定的元素，测试函数为 eq 对应 delq 函数，equal 对应 delete。还有两个函数 remq 和 remove 也是删除指定元素。它们的差别是 delq 和 delete 可能会修改参数，而 remq 和 remove 总是返回删除后列表的拷贝。注意前面这是说的是可能会修改参数的值，也就是说可能不会，所以保险起见，用 delq 和 delete 函数要么只用返回值，要么用 setq 设置参数的值为返回值。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#008080">b</span> <span style="color:#008080">c</span>))                     <span style="color:#998;font-style:italic">; =&gt; (a b c)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">remq</span> <span style="color:#990073">&#39;b</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (a c)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (a b c)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delq</span> <span style="color:#990073">&#39;b</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (a c)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (a c)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delq</span> <span style="color:#990073">&#39;a</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; (c)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (a c)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="把列表当关联表">把列表当关联表</h3>
<p>用在 elisp 编程中，列表最常用的形式应该是作为一个关联表了。所谓关联表，就是可以用一个字符串（通常叫关键字，key）来查找对应值的数据结构。由列表实现的关联表有一个专门的名字叫 association list。尽管 elisp 里也有 hash table，但是 hash table 相比于 association list 至少这样几个缺点：</p>
<ul>
<li>hash table 里的关键字（key）是无序的，而 association list 的关键字 可以按想要的顺序排列</li>
<li>hash table 没有列表那样丰富的函数，只有一个 maphash 函数可以遍历列 表。而 association list 就是一个列表，所有列表函数都能适用</li>
<li>hash table 没有读入语法和输入形式，这对于调试和使用都带来很多不便</li>
</ul>
<p>所以 elisp 的 hash table 不是一个首要的数据结构，只要不对效率要求很高，通常直接用 association list。数组可以作为关联表，但是数组不适合作为与人交互使用数据结构（毕竟一个有意义的名字比纯数字的下标更适合人脑）。所以关联表的地位在 elisp 中就非比寻常了，emacs 为关联表专门用 c 程序实现了查找的相关函数以提高程序的效率。在 association list 中关键字是放在元素的 CAR 部分，与它对应的数据放在这个元素的 CDR 部分。根据比较方法的不同，有 assq 和 assoc 两个函数，它们分别对应查找使用 eq 和 equal 两种方法。例如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">assoc</span> <span style="color:#d14">&#34;a&#34;</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#d14">&#34;a&#34;</span> <span style="color:#099">97</span>) (<span style="color:#d14">&#34;b&#34;</span> <span style="color:#099">98</span>)))        <span style="color:#998;font-style:italic">; =&gt; (&#34;a&#34; 97)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">assq</span> <span style="color:#990073">&#39;a</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#008080">a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">97</span>) (<span style="color:#008080">b</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">98</span>)))          <span style="color:#998;font-style:italic">; =&gt; (a . 97)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通常我们只需要查找对应的数据，所以一般来说都要用 cdr 来得到对应的数据：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cdr</span> (<span style="color:#900;font-weight:bold">assoc</span> <span style="color:#d14">&#34;a&#34;</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#d14">&#34;a&#34;</span> <span style="color:#099">97</span>) (<span style="color:#d14">&#34;b&#34;</span> <span style="color:#099">98</span>))))  <span style="color:#998;font-style:italic">; =&gt; (97)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cdr</span> (<span style="color:#008080">assq</span> <span style="color:#990073">&#39;a</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#008080">a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">97</span>) (<span style="color:#008080">b</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">98</span>))))    <span style="color:#998;font-style:italic">; =&gt; 97</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>assoc-default 可以一步完成这样的操作：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">assoc-default</span> <span style="color:#d14">&#34;a&#34;</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#d14">&#34;a&#34;</span> <span style="color:#099">97</span>) (<span style="color:#d14">&#34;b&#34;</span> <span style="color:#099">98</span>)))          <span style="color:#998;font-style:italic">; =&gt; (97)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果查找用的键值（key）对应的数据也可以作为一个键值的话，还可以用 rassoc 和 rassq 来根据数据查找键值：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">rassoc</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">97</span>) <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#d14">&#34;a&#34;</span> <span style="color:#099">97</span>) (<span style="color:#d14">&#34;b&#34;</span> <span style="color:#099">98</span>)))     <span style="color:#998;font-style:italic">; =&gt; (&#34;a&#34; 97)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">rassq</span> <span style="color:#990073">&#39;97</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#008080">a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">97</span>) (<span style="color:#008080">b</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">98</span>)))        <span style="color:#998;font-style:italic">; =&gt; (a . 97)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果要修改关键字对应的值，最省事的作法就是用 cons 把新的键值对加到列表的头端。但是这会让列表越来越长，浪费空间。如果要替换已经存在的值，一个想法就是用 setcdr 来更改键值对应的数据。但是在更改之前要先确定这个键值在对应的列表里，否则会产生一个错误。另一个想法是用 assoc 查找到对应的元素，再用 delq 删除这个数据，然后用 cons 加到列表里：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#d14">&#34;a&#34;</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">97</span>) (<span style="color:#d14">&#34;b&#34;</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">98</span>)))     <span style="color:#998;font-style:italic">; =&gt; ((&#34;a&#34; . 97) (&#34;b&#34; . 98))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; update value by setcdr</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">bar</span> (<span style="color:#900;font-weight:bold">assoc</span> <span style="color:#d14">&#34;a&#34;</span> <span style="color:#008080">foo</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">setcdr</span> <span style="color:#008080">bar</span> <span style="color:#d14">&#34;this is a&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#d14">&#34;a&#34;</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#d14">&#34;this is a&#34;</span>) <span style="color:#008080">foo</span>))) <span style="color:#998;font-style:italic">; =&gt; &#34;this is a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                         <span style="color:#998;font-style:italic">; =&gt; ((&#34;a&#34; . &#34;this is a&#34;) (&#34;b&#34; . 98))</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; update value by delq and cons</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#d14">&#34;a&#34;</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">97</span>)
</span></span><span style="display:flex;"><span>                (<span style="color:#008080">delq</span> (<span style="color:#900;font-weight:bold">assoc</span> <span style="color:#d14">&#34;a&#34;</span> <span style="color:#008080">foo</span>) <span style="color:#008080">foo</span>))) <span style="color:#998;font-style:italic">; =&gt; ((&#34;a&#34; . 97) (&#34;b&#34; . 98))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果不对顺序有要求的话，推荐用后一种方法吧。这样代码简洁，而且让最近更新的元素放到列表前端，查找更快。</p>
<h3 id="把列表当树用">把列表当树用</h3>
<p>列表的第一个元素如果作为结点的数据，其它元素看作是子节点，就是一个树了。由于树的操作都涉及递归，现在还没有说到函数，我就不介绍了。（其实是我不太熟，就不班门弄斧了）。</p>
<h3 id="遍历列表">遍历列表</h3>
<p>遍历列表最常用的函数就是 mapc 和 mapcar 了。它们的第一个参数都是一个函数，这个函数只接受一个参数，每次处理一个列表里的元素。这两个函数唯一的差别是前者返回的还是输入的列表，而 mapcar 返回的函数返回值构成的列表：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">mapc</span> <span style="color:#990073">&#39;1+</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>))                     <span style="color:#998;font-style:italic">; =&gt; (1 2 3)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">mapcar</span> <span style="color:#990073">&#39;1+</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>))                   <span style="color:#998;font-style:italic">; =&gt; (2 3 4)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>另一个比较常用的遍历列表的方法是用 dolist。它的形式是：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">dolist</span> (<span style="color:#008080">var</span> <span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">[result]</span>) <span style="color:#008080">body...</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 var 是一个临时变量，在 body 里可以用来得到列表中元素的值。使用 dolist 的好处是不用写 lambda 函数。一般情况下它的返回值是 nil，但是你也可以指定一个值作为返回值（我觉得这个特性没有什么用，只省了一步而已）：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">dolist</span> (<span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">incf</span> <span style="color:#008080">foo</span>))                           <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">bar</span> <span style="color:#008080">nil</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">dolist</span> (<span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>) <span style="color:#008080">bar</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">push</span> (<span style="color:#0086b3">incf</span> <span style="color:#008080">foo</span>) <span style="color:#008080">bar</span>))                <span style="color:#998;font-style:italic">; =&gt; (4 3 2)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="其它常用函数">其它常用函数</h3>
<p>如果看过一些函数式语言教程的话，一定对 fold（或叫 accumulate、reduce）和 filter 这些函数记忆深刻。不过 elisp 里好像没有提供这样的函数。remove-if 和 remove-if-not 可以作 filter 函数，但是它们是 cl 里的，自己用用没有关系，不能强迫别人也跟着用，所以不能写到 elisp 里。如果不用这两个函数，也不用别人的函数的话，自己实现不妨用这样的方法：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-remove-if</span> (<span style="color:#008080">predicate</span> <span style="color:#458;font-weight:bold">list</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">delq</span> <span style="color:#008080">nil</span> (<span style="color:#900;font-weight:bold">mapcar</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">n</span>)
</span></span><span style="display:flex;"><span>                      (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">not</span> (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">predicate</span> <span style="color:#008080">n</span>)) <span style="color:#008080">n</span>))
</span></span><span style="display:flex;"><span>                    <span style="color:#458;font-weight:bold">list</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#900;font-weight:bold">evenp</span> (<span style="color:#008080">n</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">=</span> (<span style="color:#008080">%</span> <span style="color:#008080">n</span> <span style="color:#099">2</span>) <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">my-remove-if</span> <span style="color:#990073">&#39;evenp</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">0</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span> <span style="color:#099">5</span>))    <span style="color:#998;font-style:italic">; =&gt; (1 3 5)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>fold 的操作只能用变量加循环或 mapc 操作来代替了：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-fold-left</span> (<span style="color:#008080">op</span> <span style="color:#008080">initial</span> <span style="color:#458;font-weight:bold">list</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">dolist</span> (<span style="color:#008080">var</span> <span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">initial</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">initial</span> (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">op</span> <span style="color:#008080">initial</span> <span style="color:#008080">var</span>))))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">my-fold-left</span> <span style="color:#990073">&#39;+</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span>))          <span style="color:#998;font-style:italic">; =&gt; 10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里只是举个例子，事实上你不必写这样的函数，直接用函数里的遍历操作更好一些。</p>
<p>产生数列常用的方法是用 number-sequence（这里不禁用说一次，不要再用 loop 产生 tab-stop-list 了，你们 too old 了）。不过这个函数好像 在 emacs21 时好像还没有。</p>
<p>解析文本时一个很常用的操作是把字符串按分隔符分解，可以用 split-string 函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">split-string</span> <span style="color:#d14">&#34;key = val&#34;</span> <span style="color:#d14">&#34;\\s-*=\\s-*&#34;</span>)  <span style="color:#998;font-style:italic">; =&gt; (&#34;key&#34; &#34;val&#34;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>与 split-string 对应是把几个字符串用一个分隔符连接起来，这可以用 mapconcat 完成。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">mapconcat</span> <span style="color:#990073">&#39;identity</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#d14">&#34;a&#34;</span> <span style="color:#d14">&#34;b&#34;</span> <span style="color:#d14">&#34;c&#34;</span>) <span style="color:#d14">&#34;\t&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; &#34;a   b   c&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>identity 是一个特殊的函数，它会直接返回参数。mapconcat 第一个参数是一个函数，可以很灵活的使用。</p>
<h3 id="函数列表-3">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 列表测试</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">consp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">listp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">null</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 列表构造</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">cons</span> <span style="color:#008080">CAR</span> <span style="color:#008080">CDR</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">list</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">OBJECTS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">append</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">SEQUENCES</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 访问列表元素</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">X</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">caar</span> <span style="color:#008080">X</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cddr</span> <span style="color:#008080">X</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">cdar</span> <span style="color:#008080">X</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nth</span> <span style="color:#008080">N</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nthcdr</span> <span style="color:#008080">N</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">last</span> <span style="color:#008080">LIST</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">butlast</span> <span style="color:#008080">LIST</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 修改 cons cell</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcar</span> <span style="color:#008080">CELL</span> <span style="color:#008080">NEWCAR</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">setcdr</span> <span style="color:#008080">CELL</span> <span style="color:#008080">NEWCDR</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 列表操作</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">push</span> <span style="color:#008080">NEWELT</span> <span style="color:#008080">LISTNAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">pop</span> <span style="color:#008080">LISTNAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">reverse</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nreverse</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">sort</span> <span style="color:#008080">LIST</span> <span style="color:#008080">PREDICATE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">copy-sequence</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nconc</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">LISTS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">nbutlast</span> <span style="color:#008080">LIST</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 集合函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-dups</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">memq</span> <span style="color:#008080">ELT</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">member</span> <span style="color:#008080">ELT</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delq</span> <span style="color:#008080">ELT</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">delete</span> <span style="color:#008080">ELT</span> <span style="color:#008080">SEQ</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">remq</span> <span style="color:#008080">ELT</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">remove</span> <span style="color:#008080">ELT</span> <span style="color:#008080">SEQ</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 关联列表</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">assoc</span> <span style="color:#008080">KEY</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">assq</span> <span style="color:#008080">KEY</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">assoc-default</span> <span style="color:#008080">KEY</span> <span style="color:#008080">ALIST</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">TEST</span> <span style="color:#008080">DEFAULT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">rassoc</span> <span style="color:#008080">KEY</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">rassq</span> <span style="color:#008080">KEY</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 遍历函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">mapc</span> <span style="color:#008080">FUNCTION</span> <span style="color:#008080">SEQUENCE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">mapcar</span> <span style="color:#008080">FUNCTION</span> <span style="color:#008080">SEQUENCE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">dolist</span> (<span style="color:#008080">VAR</span> <span style="color:#008080">LIST</span> <span style="color:#008080">[RESULT]</span>) <span style="color:#008080">BODY...</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 其它</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">number-sequence</span> <span style="color:#008080">FROM</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">TO</span> <span style="color:#008080">INC</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">split-string</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">SEPARATORS</span> <span style="color:#008080">OMIT-NULLS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">mapconcat</span> <span style="color:#008080">FUNCTION</span> <span style="color:#008080">SEQUENCE</span> <span style="color:#008080">SEPARATOR</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">identity</span> <span style="color:#008080">ARG</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="问题解答">问题解答</h3>
<h4 id="用-list-生成-a-b-c">用 list 生成 (a b c)</h4>
<p>答案是 <code>(list 'a 'b 'c)</code>。很简单的一个问题。从这个例子可以看出为什么要想出 用 ’ 来输入列表。这就是程序员“懒”的美德呀！</p>
<h4 id="nthcdr-的一个实现">nthcdr 的一个实现</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-nthcdr</span> (<span style="color:#008080">n</span> <span style="color:#458;font-weight:bold">list</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#0086b3">or</span> (<span style="color:#458;font-weight:bold">null</span> <span style="color:#458;font-weight:bold">list</span>) (<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">n</span> <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">car</span> <span style="color:#458;font-weight:bold">list</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">my-nthcdr</span> (<span style="color:#900;font-weight:bold">1-</span> <span style="color:#008080">n</span>) (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#458;font-weight:bold">list</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样的实现看上去很简洁，但是一个最大的问题的 elisp 的递归是有限的，所以如果想这个函数没有问题，还是用循环还实现比较好。</p>
<h4 id="my-subseq-函数的定义">my-subseq 函数的定义</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-subseq</span> (<span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">from</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">to</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#458;font-weight:bold">null</span> <span style="color:#008080">to</span>) (<span style="color:#900;font-weight:bold">nthcdr</span> <span style="color:#008080">from</span> <span style="color:#458;font-weight:bold">list</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#900;font-weight:bold">butlast</span> (<span style="color:#900;font-weight:bold">nthcdr</span> <span style="color:#008080">from</span> <span style="color:#458;font-weight:bold">list</span>) (<span style="color:#900;font-weight:bold">-</span> (<span style="color:#900;font-weight:bold">length</span> <span style="color:#458;font-weight:bold">list</span>) <span style="color:#008080">to</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="setcdr-foo-foo-是什么怪东西">(setcdr foo foo) 是什么怪东西？</h4>
<p>可能你已经想到了，这就是传说中的环呀。这在 info elisp - Circular Objects 里有介绍。elisp 里用到这样的环状列表并不多见，但是也不是没有，org 和 session 那个 bug 就是由于一个环状列表造成的。</p>
<h2 id="基本数据类型之四--数组和序列">基本数据类型之四 – 数组和序列</h2>
<p>序列是列表和数组的统称，也就是说列表和数组都是序列。它们的共性是内部的元素都是有序的。elisp 里的数组包括字符串、向量、char-table 和布尔向量。它们的关系可以用下面图表示：</p>
<pre tabindex="0"><code>              _____________________________________________
              |                                             |
              |          Sequence                           |
              |  ______   ________________________________  |
              | |      | |                                | |
              | | List | |             Array              | |
              | |      | |    ________       ________     | |
              | |______| |   |        |     |        |    | |
              |          |   | Vector |     | String |    | |
              |          |   |________|     |________|    | |
              |          |  ____________   _____________  | |
              |          | |            | |             | | |
              |          | | Char-table | | Bool-vector | | |
              |          | |____________| |_____________| | |
              |          |________________________________| |
              |_____________________________________________|
</code></pre><p>组有这样一些特性：</p>
<ul>
<li>数组内的元素都对应一个下标，第一个元素下标为 0，接下来是 1。数组内 的元素可以在常数时间内访问。</li>
<li>数组在创建之后就无法改变它的长度。</li>
<li>数组是自求值的。</li>
<li>数组里的元素都可以用 aref 来访问，用 aset 来设置。</li>
</ul>
<p>向量可以看成是一种通用的数组，它的元素可以是任意的对象。而字符串是一种特殊的数组，它的元素只能是字符。如果元素是字符时，使用字符串相比向量更好，因为字符串需要的空间更少（只需要向量的 1/4），输出更直观，能用文本属性（text property），能使用 emacs 的 IO 操作。但是有时必须使用向量，比如存储按键序列。</p>
<p>由于 char-table 和 bool-vector 使用较少，而且较难理解，这里就不介绍了。</p>
<h3 id="测试函数-3">测试函数</h3>
<p>sequencep 用来测试一个对象是否是一个序列。arrayp 测试对象是否是数组。vectorp、char-table-p 和 bool-vector-p 分别测试对象是否是向量、char-table、bool-vector。</p>
<h3 id="序列的通用函数">序列的通用函数</h3>
<p>一直没有提到一个重要的函数 length，它可以得到序列的长度。但是这个函数只对真列表有效。对于一个点列表和环形列表这个函数就不适用了。点列表会出参数类型不对的错误，而环形列表就更危险，会陷入死循环。如果不确定参数类型，不妨用 safe-length。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">safe-length</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">b</span>))                  <span style="color:#998;font-style:italic">; =&gt; 1</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">safe-length</span> <span style="color:#000;font-weight:bold">&#39;#1=</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#000;font-weight:bold">#1#</span>))           <span style="color:#998;font-style:italic">; =&gt; 3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/06-array.html#answer-cirlistp">思考题</a></p>
<p>写一个函数来检测列表是否是一个环形列表。由于现在还没有介绍 let 绑定和循环，不过如果会函数定义，还是可以用递归来实现的。</p>
</blockquote>
<p>取得序列里第 n 个元素可以用 elt 函数。但是我建议，对于已知类型的序列，还是用对应的函数比较好。也就是说，如果是列表就用 nth，如果是数组就用 aref。这样一方面是省去 elt 内部的判断，另一方面读代码时能很清楚知道序列的类型。</p>
<p>copy-sequence 在前面已经提到了。不过同样 copy-sequence 不能用于点列表和环形列表。对于点列表可以用 copy-tree 函数。环形列表就没有办法复制了。 好在这样的数据结构很少用到。</p>
<h3 id="数组操作">数组操作</h3>
<p>创建字符串已经说过了。创建向量可以用 vector 函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">vector</span> <span style="color:#990073">&#39;foo</span> <span style="color:#099">23</span> <span style="color:#008080">[bar</span> <span style="color:#008080">baz]</span> <span style="color:#d14">&#34;rats&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>当然也可以直接用向量的读入语法创建向量，但是由于数组是自求值的，所以这样得到的向量和原来是一样的，也就是说参数不进行求值，看下面的例子就明白了：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; (a b)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">[foo]</span>                                   <span style="color:#998;font-style:italic">; =&gt; [foo]</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">vector</span> <span style="color:#008080">foo</span>)                            <span style="color:#998;font-style:italic">; =&gt; [(a b)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用 make-vector 可以生成元素相同的向量。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">make-vector</span> <span style="color:#099">9</span> <span style="color:#990073">&#39;Z</span>)                      <span style="color:#998;font-style:italic">; =&gt; [Z Z Z Z Z Z Z Z Z]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>fillarray 可以把整个数组用某个元素填充。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">fillarray</span> (<span style="color:#008080">make-vector</span> <span style="color:#099">3</span> <span style="color:#990073">&#39;Z</span>) <span style="color:#099">5</span>)        <span style="color:#998;font-style:italic">; =&gt; [5 5 5]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>aref 和 aset 可以用于访问和修改数组的元素。如果使用下标超出数组长度的话，会产生一个错误。所以要先确定数组的长度才能用这两个函数。</p>
<p>vconcat 可以把多个序列用 vconcat 连接成一个向量。但是这个序列必须是真列表。这也是把列表转换成向量的方法。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">vconcat</span> <span style="color:#008080">[A</span> <span style="color:#008080">B</span> <span style="color:#008080">C]</span> <span style="color:#d14">&#34;aa&#34;</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">foo</span> (<span style="color:#099">6</span> <span style="color:#099">7</span>)))     <span style="color:#998;font-style:italic">; =&gt; [A B C 97 97 foo (6 7)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>把向量转换成列表可以用 append 函数，这在前一节中已经提到。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/06-array.html#answer-tr">思考题</a></p>
<p>如果知道 elisp 的 let 绑定和循环的使用方法，不妨试试实现一个 elisp 的 tr 函数，它接受三个参数，一是要操作的字符串，另外两个分别是要替换的字符集，和对应的替换后的字符集（当它是空集时，删除字符串中所有对应的字符）。</p>
</blockquote>
<h3 id="函数列表-4">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 测试函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">sequencep</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">arrayp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">vectorp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">char-table-p</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">bool-vector-p</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 序列函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">SEQUENCE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">safe-length</span> <span style="color:#008080">LIST</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">elt</span> <span style="color:#008080">SEQUENCE</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">copy-sequence</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">copy-tree</span> <span style="color:#008080">TREE</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">VECP</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 数组函数</span>
</span></span><span style="display:flex;"><span>(<span style="color:#458;font-weight:bold">vector</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">OBJECTS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-vector</span> <span style="color:#008080">LENGTH</span> <span style="color:#008080">INIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">ARRAY</span> <span style="color:#008080">IDX</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">aset</span> <span style="color:#008080">ARRAY</span> <span style="color:#008080">IDX</span> <span style="color:#008080">NEWELT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">vconcat</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">SEQUENCES</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">append</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">SEQUENCES</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="问题解答-1">问题解答</h3>
<h4 id="测试列表是否是环形列表">测试列表是否是环形列表</h4>
<p>这个算法是从 safe-length 定义中得到的。你可以直接看它的源码。下面是我写的函数。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">circular-list-p</span> (<span style="color:#458;font-weight:bold">list</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">consp</span> <span style="color:#458;font-weight:bold">list</span>)
</span></span><span style="display:flex;"><span>       (<span style="color:#008080">circular-list-p-1</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#458;font-weight:bold">list</span>) <span style="color:#458;font-weight:bold">list</span> <span style="color:#099">0</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">circular-list-p-1</span> (<span style="color:#008080">tail</span> <span style="color:#008080">halftail</span> <span style="color:#008080">len</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">eq</span> <span style="color:#008080">tail</span> <span style="color:#008080">halftail</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#008080">t</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">consp</span> <span style="color:#008080">tail</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">circular-list-p-1</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">tail</span>)
</span></span><span style="display:flex;"><span>                           (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">=</span> (<span style="color:#008080">%</span> <span style="color:#008080">len</span> <span style="color:#099">2</span>) <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>                               (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">halftail</span>)
</span></span><span style="display:flex;"><span>                             <span style="color:#008080">halftail</span>)
</span></span><span style="display:flex;"><span>                           (<span style="color:#900;font-weight:bold">1+</span> <span style="color:#008080">len</span>))
</span></span><span style="display:flex;"><span>      <span style="color:#008080">nil</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="转换字符的-tr-函数">转换字符的 tr 函数</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-tr</span> (<span style="color:#008080">str</span> <span style="color:#008080">from</span> <span style="color:#008080">to</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">=</span> (<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">to</span>) <span style="color:#099">0</span>)                 <span style="color:#998;font-style:italic">; 空字符串</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">from</span> (<span style="color:#900;font-weight:bold">append</span> <span style="color:#008080">from</span> <span style="color:#008080">nil</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">concat</span>
</span></span><span style="display:flex;"><span>         (<span style="color:#008080">delq</span> <span style="color:#008080">nil</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#900;font-weight:bold">mapcar</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">c</span>)
</span></span><span style="display:flex;"><span>                         (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">member</span> <span style="color:#008080">c</span> <span style="color:#008080">from</span>)
</span></span><span style="display:flex;"><span>                             <span style="color:#008080">nil</span> <span style="color:#008080">c</span>))
</span></span><span style="display:flex;"><span>                       (<span style="color:#900;font-weight:bold">append</span> <span style="color:#008080">str</span> <span style="color:#008080">nil</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> (<span style="color:#008080">table</span> <span style="color:#008080">newstr</span> <span style="color:#008080">pair</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">;; 构建转换表</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#0086b3">dotimes</span> (<span style="color:#008080">i</span> (<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">from</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#0086b3">push</span> (<span style="color:#458;font-weight:bold">cons</span> (<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">from</span> <span style="color:#008080">i</span>) (<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">to</span> <span style="color:#008080">i</span>)) <span style="color:#008080">table</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#0086b3">dotimes</span> (<span style="color:#008080">i</span> (<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">str</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#0086b3">push</span>
</span></span><span style="display:flex;"><span>         (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">pair</span> (<span style="color:#900;font-weight:bold">assoc</span> (<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">str</span> <span style="color:#008080">i</span>) <span style="color:#008080">table</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">pair</span>)
</span></span><span style="display:flex;"><span>           (<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">str</span> <span style="color:#008080">i</span>))
</span></span><span style="display:flex;"><span>         <span style="color:#008080">newstr</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">concat</span> (<span style="color:#900;font-weight:bold">nreverse</span> <span style="color:#008080">newstr</span>) <span style="color:#008080">nil</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里用到的 dotimes 函数相当于一个 C 里的 for 循环。如果改写成 while 循环，相当于：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> (<span style="color:#008080">var</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">while</span> (<span style="color:#900;font-weight:bold">&lt;</span> <span style="color:#008080">var</span> <span style="color:#900;font-weight:bold">count</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#008080">body</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">var</span> (<span style="color:#900;font-weight:bold">1+</span> <span style="color:#008080">var</span>)))
</span></span><span style="display:flex;"><span>  <span style="color:#008080">result</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这个例子也可以看出，由于列表具有丰富的函数和可变长度，使列表比数组使用更方便，而且效率往往更高。</p>
<h2 id="基本数据类型之五--符号">基本数据类型之五 – 符号</h2>
<p>符号是有名字的对象。可能这么说有点抽象。作个不恰当的比方，符号可以看作是 C 语言里的指针。通过符号你可以得到和这个符号相关联的信息，比如值，函数，属性列表等等。</p>
<p>首先必须知道的是符号的命名规则。符号名字可以含有任何字符。大多数的符号名字只含有字母、数字和标点“-+=*/”。这样的名字不需要其它标点。名字前缀要足够把符号名和数字区分开来，如果需要的话，可以在前面用 \ 表示为符号，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbolp</span> <span style="color:#990073">&#39;+1</span>)                           <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbolp</span> <span style="color:#990073">&#39;\+1</span>)                          <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-name</span> <span style="color:#990073">&#39;\+1</span>)                      <span style="color:#998;font-style:italic">; =&gt; &#34;+1&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其它字符 <code>_~!@$%^&amp;:&lt;&gt;{}?</code> 用的比较少。但是也可以直接作为符号的名字。任何其它字符都可以用 \ 转义后用在符号名字里。但是和字符串里字符表示不同，\ 转义后只是表示其后的字符，比如 \t 代表的字符 t，而不是制表符。如果要在符号名里使用制表符，必须在 \ 后加上制表符本身。</p>
<p>符号名是区分大小写的。这里有一些符号名的例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#008080">foo</span>                 <span style="color:#998;font-style:italic">; 名为 `foo&#39; 的符号</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">FOO</span>                 <span style="color:#998;font-style:italic">; 名为 `FOO&#39; 的符号，和 `foo&#39; 不同</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">char-to-string</span>      <span style="color:#998;font-style:italic">; 名为 `char-to-string&#39; 的符号</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">1+</span>                  <span style="color:#998;font-style:italic">; 名为 `1+&#39; 的符号 （不是整数 `+1&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">\+1</span>                 <span style="color:#998;font-style:italic">; 名为 `+1&#39; 的符号 （可读性很差的名字）</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">\(*\ 1\ 2\)</span>         <span style="color:#998;font-style:italic">; 名为 `(* 1 2)&#39; 的符号 （更差劲的名字）.</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">+-*/_~!@$%^&amp;=:&lt;&gt;{}</span>  <span style="color:#998;font-style:italic">; 名为 `+-*/_~!@$%^&amp;=:&lt;&gt;{}&#39; 的符号。</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic">;   这些字符无须转义</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建符号">创建符号</h3>
<p>一个名字如何与数据对应上呢？这就要了解一下符号是如何创建的了。符号名要有唯一性，所以一定会有一个表与名字关联，这个表在 elisp 里称为 obarray。从这个名字可以看出这个表是用数组类型，事实上是一个向量。当 emacs 创建一个符号时，首先会对这个名字求 hash 值以得到一个在 obarray 这个向量中查找值所用的下标。hash 是查找字符串的很有效的方法。这里强调的是 obarray 不是一个特殊的数据结构，就是一个一般的向量。全局变量 obarray 里 emacs 所有变量、函数和其它符号所使用的 obarray（注意不同语境中 obarray 的含义不同。前一个 obarray 是变量名，后一个 obarray 是数据类型名）。也可以自己建立向量，把这个向量作为 obarray 来使用。这是一种代替散列的一种方法。它比直接使用散列有这样一些好处：</p>
<ul>
<li>符号不仅可以有一个值，还可以用属性列表，后者又可以相当于一个关联列表。这样有很高的扩展性，而且可以表达更高级的数据结构。</li>
<li>emacs 里有一些函数可以接受 obarray 作为参数，比如补全相关的函数。</li>
</ul>
<p>当 lisp 读入一个符号时，通常会先查找这个符号是否在 obarray 里出现过，如果没有则会把这个符号加入到 obarray 里。这样查找并加入一个符号的过程称为是 intern。intern 函数可以查找或加入一个名字到 obarray 里，返回对应的符号。默认是全局的 obarray，也可以指定一个 obarray。intern-soft 与 intern 不同的是，当名字不在 obarray 里时，intern-soft 会返回 nil，而 intern 会加入到 obarray 里。为了不污染 obarray，我下面的例子中尽量在 foo 这个 obarray 里进行。一般来说，去了 foo 参数，则会在 obarray 里进行。其结果应该是相同的：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">make-vector</span> <span style="color:#099">10</span> <span style="color:#099">0</span>))           <span style="color:#998;font-style:italic">; =&gt; [0 0 0 0 0 0 0 0 0 0]</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>)                 <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>)                      <span style="color:#998;font-style:italic">; =&gt; abc</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>)                 <span style="color:#998;font-style:italic">; =&gt; abc</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>lisp 每读入一个符号都会 intern 到 obarray 里，如果想避免，可以用在符号名前加上 <code>#:</code>：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abc&#34;</span>)                     <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span><span style="color:#990073">&#39;abc</span>                                    <span style="color:#998;font-style:italic">; =&gt; abc</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abc&#34;</span>)                     <span style="color:#998;font-style:italic">; =&gt; abc</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abcd&#34;</span>)                    <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&#39;</span><span style="color:#990073">#:abcd</span>                                 <span style="color:#998;font-style:italic">; =&gt; abcd</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abcd&#34;</span>)                    <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果想除去 obarray 里的符号，可以用 unintern 函数。unintern 可以用符号名或符号作参数在指定的 obarray 里去除符号，成功去除则返回 t，如果没有查找到对应的符号则返回 nil：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>)                 <span style="color:#998;font-style:italic">; =&gt; abc</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">unintern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>)                    <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>)                 <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>和 hash-table 一样，obarray 也提供一个 mapatoms 函数来遍历整个 obarray。比如要计算 obarray 里所有的符号数量：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#900;font-weight:bold">count</span> <span style="color:#099">0</span>)                          <span style="color:#998;font-style:italic">; =&gt; 0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">count-syms</span> (<span style="color:#008080">s</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#900;font-weight:bold">count</span> (<span style="color:#900;font-weight:bold">1+</span> <span style="color:#900;font-weight:bold">count</span>)))              <span style="color:#998;font-style:italic">; =&gt; count-syms</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">mapatoms</span> <span style="color:#990073">&#39;count-syms</span>)                  <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">count</span>                                   <span style="color:#998;font-style:italic">; =&gt; 28371</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">obarray</span>)                        <span style="color:#998;font-style:italic">; =&gt; 1511</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/07-symbol.html#answer-obarray">思考题</a></p>
<p>由前面的例子可以看出 elisp 中的向量长度都是有限的，而 obarray 里的符号有成千上万个。那这些符号是怎样放到 obarray 里的呢？</p>
</blockquote>
<h3 id="符号的组成">符号的组成</h3>
<p>每个符号可以对应四个组成部分，一是符号的名字，可以用 symbol-name 访问。二是符号的值。符号的值可以通过 set 函数来设置，用 symbol-value 来访问。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">set</span> (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>) <span style="color:#d14">&#34;I&#39;m abc&#34;</span>)      <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m abc&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-value</span> (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>))       <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m abc&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可能大家最常见到 setq 函数，而 set 函数确很少见到。setq 可以看成是一个宏，它可以让你用 (setq sym val) 代替 (set (quote sym) val)。事实上这也是它名字的来源 (q 代表 quoted)。但是 setq 只能设置 obarray 里的变量，前面这个例子中就只能用 set 函数。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/07-symbol.html#answer-remove">思考题</a></p>
<p>参考 assoc-default 的代码，写一个函数从一个关联列表中除去一个关键字对应的元素。这个函数可以直接修改关联列表符号的值。要求可以传递一个参数作为测试关键字是否相同的函数。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#008080">?a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">a</span>) (<span style="color:#008080">?A</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">c</span>) (<span style="color:#008080">?B</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">d</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">remove-from-list</span> <span style="color:#990073">&#39;foo</span> <span style="color:#008080">?b</span> <span style="color:#990073">&#39;char-equal</span>)  <span style="color:#998;font-style:italic">; =&gt; ((97 . a) (65 . c))</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; ((97 . a) (65 . c))</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>如果一个符号的值已经有设置过的话，则 boundp 测试返回 t，否则为 nil。对于 boundp 测试返回 nil 的符号，使用符号的值会引起一个变量值为 void 的错误。</p>
<p>符号的第三个组成部分是函数。它可以用 symbol-function 来访问，用 fset 来设置</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">fset</span> (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>) (<span style="color:#900;font-weight:bold">symbol-function</span> <span style="color:#990073">&#39;car</span>)) <span style="color:#998;font-style:italic">; =&gt; #&lt;subr car&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">funcall</span> (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>) <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#008080">b</span>))            <span style="color:#998;font-style:italic">; =&gt; a</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>类似的，可以用 fboundp 测试一个符号的函数部分是否有设置。</p>
<p>符号的第四个组成部分是属性列表 (property list)。通常属性列表用于存储和符号相关的信息，比如变量和函数的文档，定义的文件名和位置，语法类型。属性名和值可以是任意的 lisp 对象，但是通常名字是符号，可以用 get 和 put 来访问和修改属性值，用 symbol-plist 得到所有的属性列表：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">put</span> (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>) <span style="color:#990073">&#39;doc</span> <span style="color:#d14">&#34;this is abc&#34;</span>)      <span style="color:#998;font-style:italic">; =&gt; &#34;this is abc&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">get</span> (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>) <span style="color:#990073">&#39;doc</span>)                    <span style="color:#998;font-style:italic">; =&gt; &#34;this is abc&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-plist</span> (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#008080">foo</span>))                <span style="color:#998;font-style:italic">; =&gt; (doc &#34;this is abc&#34;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关联列表和属性列表很相似。符号的属性列表在内部表示上是用 (prop1 value1 prop2 value2 …) 的形式，和关联列表也是很相似的。属性列表在查找和这个符号相关的信息时，要比直接用关联列表要简单快捷的多。所以变量的文档等信息都是放在符号的属性列表里。但是关联表在头端加入元素是很快的，而且它可以删除表里的元素。而属性列表则不能删除一个属性。</p>
<p>如果已经把属性列表取出，那么还可以用 plist-get 和 plist-put 的方法来访问和设置属性列表</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">plist-get</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">foo</span> <span style="color:#099">4</span>) <span style="color:#990073">&#39;foo</span>)               <span style="color:#998;font-style:italic">; =&gt; 4</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">plist-get</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">foo</span> <span style="color:#099">4</span> <span style="color:#008080">bad</span>) <span style="color:#990073">&#39;bar</span>)           <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">my-plist</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">bar</span> <span style="color:#008080">t</span> <span style="color:#008080">foo</span> <span style="color:#099">4</span>))          <span style="color:#998;font-style:italic">; =&gt; (bar t foo 4)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">my-plist</span> (<span style="color:#008080">plist-put</span> <span style="color:#008080">my-plist</span> <span style="color:#990073">&#39;foo</span> <span style="color:#099">69</span>)) <span style="color:#998;font-style:italic">; =&gt; (bar t foo 69)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">my-plist</span> (<span style="color:#008080">plist-put</span> <span style="color:#008080">my-plist</span> <span style="color:#990073">&#39;quux</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">a</span>))) <span style="color:#998;font-style:italic">; =&gt; (bar t foo 69 quux (a))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/07-symbol.html#answer-plist">思考题</a></p>
<p>你能不能用已经学过的函数来实现 plist-get 和 plist-put？</p>
</blockquote>
<h3 id="函数列表-5">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbolp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">intern-soft</span> <span style="color:#008080">NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBARRAY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">intern</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBARRAY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">unintern</span> <span style="color:#008080">NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBARRAY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">mapatoms</span> <span style="color:#008080">FUNCTION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBARRAY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-name</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-value</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">boundp</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">set</span> <span style="color:#008080">SYMBOL</span> <span style="color:#008080">NEWVAL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">SYM</span> <span style="color:#008080">VAL</span> <span style="color:#008080">SYM</span> <span style="color:#008080">VAL</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-function</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">fset</span> <span style="color:#008080">SYMBOL</span> <span style="color:#008080">DEFINITION</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">fboundp</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-plist</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">get</span> <span style="color:#008080">SYMBOL</span> <span style="color:#008080">PROPNAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">put</span> <span style="color:#008080">SYMBOL</span> <span style="color:#008080">PROPNAME</span> <span style="color:#008080">VALUE</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="问题解答-2">问题解答</h3>
<h4 id="obarray-里符号数为什么大于向量长度">obarray 里符号数为什么大于向量长度</h4>
<p>其实这和散列的的实现是一样的。obarray 里的每一个元素通常称为 bucket。 一个 bucket 是可以容纳多个相同 hash 值的字符串和它们的数据。我们可以用 这样的方法来模拟一下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">hash-string</span> (<span style="color:#008080">str</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">hash</span> <span style="color:#099">0</span>) <span style="color:#008080">c</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#0086b3">dotimes</span> (<span style="color:#008080">i</span> (<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">str</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">c</span> (<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">str</span> <span style="color:#008080">i</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">&gt;</span> <span style="color:#008080">c</span> <span style="color:#099">#o140</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">c</span> (<span style="color:#900;font-weight:bold">-</span> <span style="color:#008080">c</span> <span style="color:#099">40</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">hash</span> (<span style="color:#900;font-weight:bold">+</span> (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">hash</span> (<span style="color:#008080">lsh</span> <span style="color:#008080">hash</span> <span style="color:#099">3</span>))
</span></span><span style="display:flex;"><span>                    (<span style="color:#008080">lsh</span> <span style="color:#008080">hash</span> <span style="color:#099">-28</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#008080">c</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#008080">hash</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">len</span> <span style="color:#099">10</span>) <span style="color:#008080">str</span> <span style="color:#008080">hash</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">make-vector</span> <span style="color:#008080">len</span> <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">dotimes</span> (<span style="color:#008080">i</span> (<span style="color:#900;font-weight:bold">1+</span> <span style="color:#008080">len</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">str</span> (<span style="color:#008080">char-to-string</span> (<span style="color:#900;font-weight:bold">+</span> <span style="color:#008080">?a</span> <span style="color:#008080">i</span>))
</span></span><span style="display:flex;"><span>          <span style="color:#008080">hash</span> (<span style="color:#008080">%</span> (<span style="color:#008080">hash-string</span> <span style="color:#008080">str</span>) <span style="color:#008080">len</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">message</span> <span style="color:#d14">&#34;I put %s in slot %d&#34;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#008080">str</span> <span style="color:#008080">hash</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">eq</span> (<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">foo</span> <span style="color:#008080">hash</span>) <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#008080">str</span> <span style="color:#008080">foo</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">message</span> <span style="color:#d14">&#34;I found %S is already taking the slot: %S&#34;</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#900;font-weight:bold">aref</span> <span style="color:#008080">foo</span> <span style="color:#008080">hash</span>) <span style="color:#008080">foo</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">intern</span> <span style="color:#008080">str</span> <span style="color:#008080">foo</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Now I&#39;am in the slot too: %S&#34;</span> <span style="color:#008080">foo</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><p>在我这里的输出是</p>
<pre tabindex="0"><code>I put a in slot 7
I put b in slot 8
I put c in slot 9
I put d in slot 0
I put e in slot 1
I put f in slot 2
I put g in slot 3
I put h in slot 4
I put i in slot 5
I put j in slot 6
I put k in slot 7
I found a is already taking the slot: [d e f g h i j a b c]
Now I&#39;am in the slot too: [d e f g h i j k b c]
</code></pre><p>当然，这个 hash-string 和实际 obarray 里用的 hash-string 只是算法上是 相同的，但是由于数据类型和 c 不是完全相同，所以对于长一点的字符串结果 可能不一样，我只好用单个字符来演示一下。</p>
<h4 id="根据关键字删除关联列表中的元素">根据关键字删除关联列表中的元素</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">remove-from-list</span> (<span style="color:#008080">list-var</span> <span style="color:#008080">key</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">test</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">prev</span> (<span style="color:#900;font-weight:bold">symbol-value</span> <span style="color:#008080">list-var</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#008080">tail</span> <span style="color:#008080">found</span> <span style="color:#008080">value</span> <span style="color:#900;font-weight:bold">elt</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#0086b3">or</span> <span style="color:#008080">test</span> (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">test</span> <span style="color:#990073">&#39;equal</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">test</span> (<span style="color:#900;font-weight:bold">caar</span> <span style="color:#008080">prev</span>) <span style="color:#008080">key</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#900;font-weight:bold">set</span> <span style="color:#008080">list-var</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">prev</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">tail</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">prev</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">while</span> (<span style="color:#0086b3">and</span> <span style="color:#008080">tail</span> (<span style="color:#900;font-weight:bold">not</span> <span style="color:#008080">found</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#900;font-weight:bold">elt</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">tail</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">test</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#900;font-weight:bold">elt</span>) <span style="color:#008080">key</span>)
</span></span><span style="display:flex;"><span>            (<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>              (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">found</span> <span style="color:#008080">t</span>)
</span></span><span style="display:flex;"><span>              (<span style="color:#008080">setcdr</span> <span style="color:#008080">prev</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">tail</span>)))
</span></span><span style="display:flex;"><span>          (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">tail</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">tail</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#008080">prev</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">prev</span>)))))
</span></span><span style="display:flex;"><span>    (<span style="color:#900;font-weight:bold">symbol-value</span> <span style="color:#008080">list-var</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意这个函数的参数 list-var 是一个符号，所以这个函数不能直接传递一个列表。这和 add-to-list 的参数是一样的。</p>
<h4 id="plist-get-和-plist-put-的实现">plist-get 和 plist-put 的实现</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-plist-get</span> (<span style="color:#008080">plist</span> <span style="color:#008080">prop</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">cadr</span> (<span style="color:#008080">memq</span> <span style="color:#008080">plist</span> <span style="color:#008080">prop</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-plist-put</span> (<span style="color:#008080">plist</span> <span style="color:#008080">prop</span> <span style="color:#008080">val</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">tail</span> (<span style="color:#008080">memq</span> <span style="color:#008080">prop</span> <span style="color:#008080">plist</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">tail</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">setcar</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">tail</span>) <span style="color:#008080">val</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">setcdr</span> (<span style="color:#900;font-weight:bold">last</span> <span style="color:#008080">plist</span>) (<span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">prop</span> <span style="color:#008080">val</span>))))
</span></span><span style="display:flex;"><span>  <span style="color:#008080">plist</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>my-plist-put 函数没有 plist-put 那样 robust，如果属性列表是 ‘(bar t foo) 这样的话，这个函数就会出错。而且加入一个属性的时间复杂度比 plist 更高（memq 和 last 都是 O(n)），不过可以用循环来达到相同的时间复杂度。</p>
<h2 id="求值规则">求值规则</h2>
<p>至此，elisp 中最常见的数据类型已经介绍完了。我们可以真正开始学习怎样写一个 elisp 程序。如果想深入了解一下 lisp 是如何工作的，不妨先花些时间看看 lisp 的求值过程。当然忽略这一部分也是可以的，因为我觉得这个求值规则是那么自然，以至于你会认为它就是应该这样的。</p>
<p>求值是 lisp 解释器的核心，理解了求值过程也就学会了 lisp 编程的一半。正因为这样，我有点担心自己说得不清楚或者理解错误，会误导了你。所以如果真想深入了解的话，还是自己看 info elisp - Evaluation 这一章吧。</p>
<p>一个要求值的 lisp 对象被称为表达式（form）。所有的表达式可以分为三种：符号、列表和其它类型（废话）。下面一一说明各种表达式的求值规则。</p>
<p>第一种表达式是最简单的，自求值表达式。前面说过数字、字符串、向量都是自求值表达式。还有两个特殊的符号 t 和 nil 也可以看成是自求值表达式。</p>
<p>第二种表达式是符号。符号的求值结果就是符号的值。如果它没有值，就会出现 void-variable 的错误。</p>
<p>第三种表达式是列表表达式。而列表表达式又可以根据第一个元素分为函数调用、宏调用和特殊表达式（special form）三种。列表的第一个表达式如果是一个符号，解释器会查找这个表达式的函数值。如果函数值是另一个符号，则会继续查找这个符号的函数值。这称为“symbol function indirection”。最后直到某个符号的函数值是一个 lisp 函数（lambda 表达式）、byte-code 函数、原子函数（primitive function）、宏、特殊表达式或 autoload 对象。如果不是这些类型，比如某个符号的函数值是前面出现的某个符号导致无限循环，或者某个符号函数值为空，都会导致一个错误 invalid-function。</p>
<p>这个函数显示 indirection function</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-function</span> <span style="color:#990073">&#39;car</span>)                  <span style="color:#998;font-style:italic">; =&gt; #&lt;subr car&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">fset</span> <span style="color:#990073">&#39;first</span> <span style="color:#990073">&#39;car</span>)                      <span style="color:#998;font-style:italic">; =&gt; car</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">fset</span> <span style="color:#990073">&#39;erste</span> <span style="color:#990073">&#39;first</span>)                    <span style="color:#998;font-style:italic">; =&gt; first</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">erste</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>))                        <span style="color:#998;font-style:italic">; =&gt; 1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于第一个元素是 lisp 函数对象、byte-code 对象和原子函数时，这个列表也称为函数调用（funtion call）。对这样的列表求值时，先对列表中其它元素先求值，求值的结果作为函数调用的真正参数。然后使用 apply 函数用这些参数调用函数。如果函数是用 lisp 写的，可以理解为把参数和变量绑定到函数后，对函数体顺序求值，返回最后一个 form 的值。</p>
<p>如果第一个元素是一个宏对象，列表里的其它元素不会立即求值，而是根据宏定义进行扩展。如果扩展后还是一个宏调用，则会继续扩展下去，直到扩展的结果不再是一个宏调用为止。例如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defmacro</span> <span style="color:#900;font-weight:bold">cadr</span> (<span style="color:#008080">x</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">list</span> <span style="color:#990073">&#39;car</span> (<span style="color:#458;font-weight:bold">list</span> <span style="color:#990073">&#39;cdr</span> <span style="color:#008080">x</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样 <code>(cadr (assq 'handler list))</code> 扩展后成为 <code>(car (cdr (assq 'handler list)))</code>。</p>
<p>第一个元素如果是一个特殊表达式时，它的参数可能并不会全求值。这些特殊表达式通常是用于控制结构或者变量绑定。每个特殊表达式都有对应的求值规则。这在下面会提到。</p>
<p>最后用这个伪代码来说明一下 elisp 中的求值规则：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> (<span style="color:#900;font-weight:bold">eval</span> <span style="color:#900;font-weight:bold">exp</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">cond</span>
</span></span><span style="display:flex;"><span>   ((<span style="color:#900;font-weight:bold">numberp</span> <span style="color:#900;font-weight:bold">exp</span>) <span style="color:#900;font-weight:bold">exp</span>)
</span></span><span style="display:flex;"><span>   ((<span style="color:#900;font-weight:bold">stringp</span> <span style="color:#900;font-weight:bold">exp</span>) <span style="color:#900;font-weight:bold">exp</span>)
</span></span><span style="display:flex;"><span>   ((<span style="color:#900;font-weight:bold">arrayp</span> <span style="color:#900;font-weight:bold">exp</span>) <span style="color:#900;font-weight:bold">exp</span>)
</span></span><span style="display:flex;"><span>   ((<span style="color:#900;font-weight:bold">symbolp</span> <span style="color:#900;font-weight:bold">exp</span>) (<span style="color:#900;font-weight:bold">symbol-value</span> <span style="color:#900;font-weight:bold">exp</span>))
</span></span><span style="display:flex;"><span>   ((<span style="color:#008080">special-form-p</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#900;font-weight:bold">exp</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">eval-special-form</span> <span style="color:#900;font-weight:bold">exp</span>))
</span></span><span style="display:flex;"><span>   ((<span style="color:#900;font-weight:bold">fboundp</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#900;font-weight:bold">exp</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#900;font-weight:bold">apply</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#900;font-weight:bold">exp</span>) (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#900;font-weight:bold">exp</span>)))
</span></span><span style="display:flex;"><span>   (<span style="color:#008080">t</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#458;font-weight:bold">error</span> <span style="color:#d14">&#34;Unknown expression type -- EVAL %S&#34;</span> <span style="color:#900;font-weight:bold">exp</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="变量">变量</h2>
<p>在此之前，我们已经见过 elisp 中的两种变量，全局变量和 let 绑定的局部变量。它们相当于其它语言中的全局变量和局部变量。</p>
<p>关于 let 绑定的变量，有两点需要补充的。当同一个变量名既是全局变量也是局部变量，或者用 let 多层绑定，只有最里层的那个变量是有效的，用 setq 改变的也只是最里层的变量，而不影响外层的变量。比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;I&#39;m global variable!&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">foo</span> <span style="color:#099">5</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">message</span> <span style="color:#d14">&#34;foo value is: %S&#34;</span> <span style="color:#008080">foo</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> (<span style="color:#008080">foo</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;I&#39;m local variable!&#34;</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">message</span> <span style="color:#008080">foo</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">message</span> <span style="color:#d14">&#34;foo value is still: %S&#34;</span> <span style="color:#008080">foo</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#008080">foo</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>另外需要注意一点的是局部变量的绑定不能超过一定的层数，也就是说，你不能把 foo 用 let 绑定 10000 层。当然普通的函数是不可能写成这样的，但是递归函数就不一定了。限制层数的变量在 max-specpdl-size 中定义。如果你写的递归函数有这个需要的话，可以先设置这个变量的值。</p>
<p>emacs 有一种特殊的局部变量 ── buffer-local 变量。</p>
<h3 id="buffer-local-变量">buffer-local 变量</h3>
<p>emacs 能有如此丰富的模式，各个缓冲区之间能不相互冲突，很大程度上要归功于 buffer-local 变量。</p>
<p>声明一个 buffer-local 的变量可以用 make-variable-buffer-local 或用 make-local-variable。这两个函数的区别在于前者是相当于在所有变量中都产生一个 buffer-local 的变量。而后者只在声明时所在的缓冲区内产生一个局部变量，而其它缓冲区仍然使用的是全局变量。一般来说推荐使用 make-local-variable。</p>
<p>为了方便演示，下面的代码我假定你是在 <code>*scratch*</code> 缓冲区里运行。我使用另一个一般都会有的缓冲区 <code>*Messages*</code> 作为测试。先介绍两个用到的函数（ with-current-buffer 其实是一个宏）。</p>
<p>with-current-buffer 的使用形式是</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">with-current-buffer</span> <span style="color:#008080">buffer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#008080">body</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 buffer 可以是一个缓冲区对象，也可以是缓冲区的名字。它的作用是使其中的 body 表达式在指定的缓冲区里执行。</p>
<p>get-buffer 可以用缓冲区的名字得到对应的缓冲区对象。如果没有这样名字的缓冲区会返回 nil。</p>
<p>下面是使用 buffer-local 变量的例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;I&#39;m global variable!&#34;</span>)       <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m global variable!&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-local-variable</span> <span style="color:#990073">&#39;foo</span>)              <span style="color:#998;font-style:italic">; =&gt; foo</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m global variable!&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;I&#39;m buffer-local variable!&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m buffer-local variable!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                  <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m buffer-local variable!&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">with-current-buffer</span> <span style="color:#d14">&#34;*Messages*&#34;</span> <span style="color:#008080">foo</span>)  <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m global variable!&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这个例子中可以看出，当一个符号作为全局变量时有一个值的话，用 make-local-variable 声明为 buffer-local 变量时，这个变量的值还是全局变量的值。这时候全局的值也称为缺省值。你可以用 default -value 来访问这个符号的全局变量的值</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">default-value</span> <span style="color:#990073">&#39;foo</span>)                    <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m global variable!&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果一个变量是 buffer-local，那么在这个缓冲区内使用用 setq 就只能用改变当前缓冲区里这个变量的值。setq-default 可以修改符号作为全局变量的值。通常在 .emacs 里经常使用 setq-default，这样可以防止修改的是导入 .emacs 文件对应的缓冲区里的 buffer-local 变量，而不是设置全局的值。</p>
<p>测试一个变量是不是 buffer-local 可以用 local-variable-p</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">local-variable-p</span> <span style="color:#990073">&#39;foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">local-variable-p</span> <span style="color:#990073">&#39;foo</span> (<span style="color:#008080">get-buffer</span> <span style="color:#d14">&#34;*Messages*&#34;</span>)) <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果要在当前缓冲区里得到其它缓冲区的 buffer-local 变量可以用 buffer-local-value</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">with-current-buffer</span> <span style="color:#d14">&#34;*Messages*&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">buffer-local-value</span> <span style="color:#990073">&#39;foo</span> (<span style="color:#008080">get-buffer</span> <span style="color:#d14">&#34;*scratch*&#34;</span>)))
</span></span><span style="display:flex;"><span>                    <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m buffer local variable!&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="变量的作用域">变量的作用域</h3>
<p>我们现在已经学习这样几种变量：</p>
<ul>
<li>全局变量</li>
<li>buffer-local 变量</li>
<li>let 绑定局部变量</li>
</ul>
<p>如果还要考虑函数的参数列表声明的变量，也就是 4 种类型的变量。那这种变量的作用范围 (scope) 和生存期（extent）分别是怎样的呢？</p>
<p>作用域（scope）是指变量在代码中能够访问的位置。emacs lisp 这种绑定称为 indefinite scope。indefinite scope 也就是说可以在任何位置都可能访问一个变量名。而 lexical scope（词法作用域）指局部变量只能作用在函数中和一个块里（block）。</p>
<p>比如 let 绑定和函数参数列表的变量在整个表达式内都是可见的，这有别于其它语言词法作用域的变量。先看下面这个例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">binder</span> (<span style="color:#008080">x</span>)                      <span style="color:#998;font-style:italic">; `x&#39; is bound in `binder&#39;.</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">foo</span> <span style="color:#099">5</span>))                             <span style="color:#998;font-style:italic">; `foo&#39; is some other function.</span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">user</span> ()                         <span style="color:#998;font-style:italic">; `x&#39; is used &#34;free&#34; in `user&#39;.</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">x</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">foo</span> (<span style="color:#000;font-weight:bold">ignore</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">user</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">binder</span> <span style="color:#099">10</span>)                            <span style="color:#998;font-style:italic">; =&gt; (10)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于词法作用域的语言，在 user 函数里无论如何是不能访问 binder 函数中绑定的 x。但是在 elisp 中可以。</p>
<p>生存期是指程序运行过程中，变量什么时候是有效的。全局变量和 buffer-local 变量都是始终存在的，前者只能当关闭 emacs 或者用 unintern 从 obarray 里除去时才能消除。而 buffer-local 的变量也只能关闭缓冲区或者用 kill-local-variable 才会消失。而对于局部变量，emacs lisp 使用的方式称为动态生存期：只有当绑定了这个变量的表达式运行时才是有效的。这和 C 和 Pascal 里的 Local 和 automatic 变量是一样的。与此相对的是 indefinite extent，变量即使离开绑定它的表达式还能有效。比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">make-add</span> (<span style="color:#008080">n</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">function</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">m</span>) (<span style="color:#900;font-weight:bold">+</span> <span style="color:#008080">n</span> <span style="color:#008080">m</span>))))      <span style="color:#998;font-style:italic">; Return a function.</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">fset</span> <span style="color:#990073">&#39;add2</span> (<span style="color:#008080">make-add</span> <span style="color:#099">2</span>))               <span style="color:#998;font-style:italic">; Define function `add2&#39;</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#998;font-style:italic">;   with `(make-add 2)&#39;.</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">add2</span> <span style="color:#099">4</span>)                                <span style="color:#998;font-style:italic">; Try to add 2 to 4.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其它 Lisp 方言中有闭包，但是 emacs lisp 中没有。</p>
<p>说完这些概念，可能你还是一点雾水。我给一个判断变量是否有效的方法吧：</p>
<ol>
<li>看看包含这个变量的 form 中是否有 let 绑定这个局部变量。如果这个 form 不是在定义一个函数，则跳到第 3 步。</li>
<li>如果是在定义函数，则不仅要看这个函数的参数中是否有这个变量，而且还要看所有直接或间接调用这个函数的函数中是否有用 let 绑定或者参数列表里有这个变量名。这就没有办法确定了，所以你永远无法判断一个函数中出现的没有用 let 绑定，也不在参数列表中的变量是否是没有定义过的。但是一般来说这不是一个好习惯。</li>
<li>看这个变量是否是一个全局变量或者是 buffer-local 变量。</li>
</ol>
<p>对于在一个函数中绑定一个变量，而在另一个函数中还在使用，manual 里认为这两个种情况下是比较好的：</p>
<ul>
<li>这个变量只有相关的几个函数中使用，在一个文件中放在一起。这个变量起程序里通信的作用。而且需要写好注释告诉其它程序员怎样使用它。</li>
<li>如果这个变量是定义明确、有很好文档作用的，可能让所有函数使用它，但是不要设置它。比如 case-fold-search。（我怎么觉得这里是用全局变量呢。）</li>
</ul>
<blockquote>
<p><a href="http://smacs.github.io/elisp/09-variable.html#anwser-scope">思考题</a></p>
<p>先在 <code>*scratch*</code> 缓冲区里运行了 <code>(kill-local-variable 'foo)</code> 后，运行几次下面的表达式，你能预测它们结果吗？</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span> (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;I&#39;m local variable!&#34;</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">foo</span> <span style="color:#d14">&#34;I&#39;m local variable!&#34;</span>))
</span></span><span style="display:flex;"><span>   (<span style="color:#900;font-weight:bold">set</span> (<span style="color:#008080">make-local-variable</span> <span style="color:#990073">&#39;foo</span>) <span style="color:#d14">&#34;I&#39;m buffer-local variable!&#34;</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> <span style="color:#d14">&#34;This is a variable!&#34;</span>)
</span></span><span style="display:flex;"><span>   (<span style="color:#008080">message</span> <span style="color:#008080">foo</span>))
</span></span><span style="display:flex;"><span> (<span style="color:#008080">message</span> <span style="color:#008080">foo</span>))
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h3 id="其它函数">其它函数</h3>
<p>一个符号如果值为空，直接使用可能会产生一个错误。可以用 boundp 来测试一个变量是否有定义。这通常用于 elisp 扩展的移植（用于不同版本或 XEmacs）。对于一个 buffer-local 变量，它的缺省值可能是没有定义的，这时用 default-value 函数可能会出错。这时就先用 default-boundp 先进行测试。</p>
<p>使一个变量的值重新为空，可以用 makunbound。要消除一个 buffer-local 变量用函数 kill-local-variable。可以用 kill-all-local-variables 消除所有的 buffer-local 变量。但是有属性 permanent-local 的不会消除，带有这些标记的变量一般都是和缓冲区模式无关的，比如输入法。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; =&gt; &#34;I&#39;m local variable!&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">boundp</span> <span style="color:#990073">&#39;foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">default-boundp</span> <span style="color:#990073">&#39;foo</span>)                   <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">makunbound</span> <span style="color:#990073">&#39;foo</span>)                       <span style="color:#998;font-style:italic">; =&gt; foo</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>                                     <span style="color:#998;font-style:italic">; This will signal an error</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">default-boundp</span> <span style="color:#990073">&#39;foo</span>)                   <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">kill-local-variable</span> <span style="color:#990073">&#39;foo</span>)              <span style="color:#998;font-style:italic">; =&gt; foo</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="变量名习惯">变量名习惯</h3>
<p>对于变量的命名，有一些习惯，这样可以从变量名就能看出变量的用途：</p>
<ul>
<li>hook 一个在特定情况下调用的函数列表，比如关闭缓冲区时，进入某个模式时。</li>
<li>function 值为一个函数</li>
<li>functions 值为一个函数列表</li>
<li>flag 值为 nil 或 non-nil</li>
<li>predicate 值是一个作判断的函数，返回 nil 或 non-nil</li>
<li>program 或 -command 一个程序或 shell 命令名</li>
<li>form 一个表达式</li>
<li>forms 一个表达式列表。</li>
<li>map 一个按键映射（keymap）</li>
</ul>
<h3 id="函数列表-6">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">make-local-variable</span> <span style="color:#008080">VARIABLE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-variable-buffer-local</span> <span style="color:#008080">VARIABLE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">with-current-buffer</span> <span style="color:#008080">BUFFER</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-buffer</span> <span style="color:#008080">NAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">default-value</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">local-variable-p</span> <span style="color:#008080">VARIABLE</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BUFFER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">buffer-local-value</span> <span style="color:#008080">VARIABLE</span> <span style="color:#008080">BUFFER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">boundp</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">default-boundp</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">makunbound</span> <span style="color:#008080">SYMBOL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">kill-local-variable</span> <span style="color:#008080">VARIABLE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">kill-all-local-variables</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="变量列表-1">变量列表</h3>
<pre tabindex="0"><code>max-specpdl-size
</code></pre><h3 id="问题解答-3">问题解答</h3>
<h4 id="同一个表达式运行再次结果不同">同一个表达式运行再次结果不同？</h4>
<p>运行第一次时，foo 缺省值为 “I’m local variable!&quot;，而 buffer-local 值为 “This is a variable!&quot;。第一个和第二个 message 都会显示 “This is a variable!&quot;。运行第二次时，foo 缺省值和 buffer-local 值都成了 “I’m local variable!&quot;，而第一次 message 显示 “This is a variable!&quot;，第二次 显示 “I’m local variable!&quot;。这是由于 make-local-variable 在这个符号是 否已经是 buffer-local 变量时有不同表现造成的。如果已经是一个 buffer-local 变量，则它什么也不做，而如果不是，则会生成一个 buffer-local 变量，这时在这个表达式内的所有 foo 也被重新绑定了。希望你 写的函数能想到一点。</p>
<h2 id="函数和命令">函数和命令</h2>
<p>在 elisp 里类似函数的对象很多，比如：</p>
<ul>
<li>函数。这里的函数特指用 lisp 写的函数。</li>
<li>原子函数（primitive）。用 C 写的函数，比如 car、append。</li>
<li>lambda 表达式</li>
<li>特殊表达式</li>
<li>宏 (macro)。宏是用 lisp 写的一种结构，它可以把一种 lisp 表达式转换成等价的另一个表达式。</li>
<li>命令。命令能用 command-execute 调用。函数也可以是命令。</li>
</ul>
<p>以上这些用 functionp 来测试都会返回 t。</p>
<p>我们已经学过如何定义一个函数。但是这些函数的参数个数都是确定。但是你可以看到 emacs 里有很多函数是接受可选参数，比如 random 函数。还有一些函数可以接受不确定的参数，比如加减乘除。这样的函数在 elisp 中是如何定义的呢？</p>
<h3 id="参数列表的语法">参数列表的语法</h3>
<p>这是参数列表的方法形式：</p>
<pre tabindex="0"><code>(REQUIRED-VARS...
 [&amp;optional OPTIONAL-VARS...]
 [&amp;rest REST-VAR])
</code></pre><p>它的意思是说，你必须把必须提供的参数写在前面，可选的参数写在后面，最后用一个符号表示剩余的所有参数。比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">foo</span> (<span style="color:#008080">var1</span> <span style="color:#008080">var2</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">opt1</span> <span style="color:#008080">opt2</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#900;font-weight:bold">rest</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">var1</span> <span style="color:#008080">var2</span> <span style="color:#008080">opt1</span> <span style="color:#008080">opt2</span> <span style="color:#900;font-weight:bold">rest</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">foo</span> <span style="color:#099">1</span> <span style="color:#099">2</span>)                               <span style="color:#998;font-style:italic">; =&gt; (1 2 nil nil nil)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">foo</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span>)                             <span style="color:#998;font-style:italic">; =&gt; (1 2 3 nil nil)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">foo</span> <span style="color:#099">1</span> <span style="color:#099">2</span> <span style="color:#099">3</span> <span style="color:#099">4</span> <span style="color:#099">5</span> <span style="color:#099">6</span>)                       <span style="color:#998;font-style:italic">; =&gt; (1 2 3 4 (5 6))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从这个例子可以看出，当可选参数没有提供时，在函数体里，对应的参数值都是 nil。同样调用函数时没有提供剩余参数时，其值也为 nil，但是一旦提供了剩余参数，则所有参数是以列表的形式放在对应变量里。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/10-function.html#answer-arg">思考题</a></p>
<p>写一个函数测试两个浮点数是否相等，设置一个可选参数，如果提供这个参数，则用这个参数作为测试误差，否则用 1.0e-6 作为误差。</p>
</blockquote>
<h3 id="关于文档字符串">关于文档字符串</h3>
<p>最好为你的函数都提供一个文档字符串。关于文档字符串有一些规范，最好遵守这些约定。</p>
<p>字符串的第一行最好是独立的。因为 apropos 命令只能显示第一行的文档。所以最好用一行（一两个完整的句子）总结这个函数的目的。</p>
<p>文档的缩进最好要根据最后的显示的效果来调用。因为引号之类字符会多占用一个字符，所以在源文件里缩进最好看，不一定显示的最好。</p>
<p>如果你想要让你的函数参数显示的与函数定义的不同（比如提示用户如何调用这个函数），可以在文档最后一行，加上一行：</p>
<pre tabindex="0"><code>\(fn ARGLIST)
</code></pre><p>注意这一行前面要有一个空行，这一行后不能再有空行。比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">foo</span> (<span style="color:#008080">var1</span> <span style="color:#008080">var2</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">opt1</span> <span style="color:#008080">opt2</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#900;font-weight:bold">rest</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;You should call the function like:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">\(fn v1 v2)&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">var1</span> <span style="color:#008080">var2</span> <span style="color:#008080">opt1</span> <span style="color:#008080">opt2</span> <span style="color:#900;font-weight:bold">rest</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>还有一些有特殊标记功能的符号，比如 ``’<code>引起的符号名可以生成一个链接，这样可以在</code><em>Help</em> <code>中更方便的查看相关变量或函数的文档。</code>{major-mode-map}` 可以显示扩展成这个模式按键的说明，例如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">foo</span> ()
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;A simple document string to show how to use `&#39; and \\=\\{}.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">You can press this button `help&#39; to see the document of
</span></span></span><span style="display:flex;"><span><span style="color:#d14">function \&#34;help\&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">This is keybind of text-mode(substitute from \\=\\{text-mode-map}):
</span></span></span><span style="display:flex;"><span><span style="color:#d14">\\{text-mode-map}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">See also `substitute-command-keys&#39; and `documentation&#39;&#34;</span>
</span></span><span style="display:flex;"><span>  )
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="调用函数">调用函数</h3>
<p>通常函数的调用都是用 eval 进行的，但是有时需要在运行时才决定使用什么函数，这时就需要用 funcall 和 apply 两个函数了。这两个函数都是把其余的参数作为函数的参数进行调用。那这两个函数有什么参数呢？唯一的区别就在于 funcall 是直接把参数传递给函数，而 apply 的最后一个参数是一个列表，传入函数的参数把列表进行一次平铺后再传给函数，看下面这个例子就明白了</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#990073">&#39;list</span> <span style="color:#990073">&#39;x</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">y</span>) <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">z</span>))               <span style="color:#998;font-style:italic">; =&gt; (x (y) (z))</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">apply</span> <span style="color:#990073">&#39;list</span> <span style="color:#990073">&#39;x</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">y</span> ) <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">z</span>))                <span style="color:#998;font-style:italic">; =&gt; (x (y) z)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/10-function.html#answer-apply">思考题</a></p>
<p>如果一个 list 作为一个树的结构，任何是 cons cell 的元素都是一个内部节点（不允许有 dotted list 出现），任何不是 cons cell 的元素都是树的叶子。请写一个函数，调用的一个类似 mapcar 的函数，调用一个函数遍历树的叶子，并收集所有的结果，返回一个结构相同的树，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">tree-mapcar</span> <span style="color:#990073">&#39;1+</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">1</span> (<span style="color:#099">2</span> (<span style="color:#099">3</span> <span style="color:#099">4</span>)) (<span style="color:#099">5</span>)))    <span style="color:#998;font-style:italic">; =&gt; (2 (3 (4 5)) (6))</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h3 id="宏">宏</h3>
<p>前面在已经简单介绍过宏。宏的调用和函数是很类似的，它的求值和函数差不多，但是有一个重要的区别是，宏的参数是出现在最后扩展后的表达式中，而函数参数是求值后才传递给这个函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defmacro</span> <span style="color:#008080">foo</span> (<span style="color:#008080">arg</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">list</span> <span style="color:#990073">&#39;message</span> <span style="color:#d14">&#34;%d %d&#34;</span> <span style="color:#008080">arg</span> <span style="color:#008080">arg</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">bar</span> (<span style="color:#008080">arg</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;%d %d&#34;</span> <span style="color:#008080">arg</span> <span style="color:#008080">arg</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">i</span> <span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">bar</span> (<span style="color:#0086b3">incf</span> <span style="color:#008080">i</span>)))                       <span style="color:#998;font-style:italic">; =&gt; &#34;2 2&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">i</span> <span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">foo</span> (<span style="color:#0086b3">incf</span> <span style="color:#008080">i</span>)))                       <span style="color:#998;font-style:italic">; =&gt; &#34;2 3&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也许你对前面这个例子 foo 里为什么要用 list 函数很不解。其实宏可以这样看，如果把宏定义作一个表达式来运行，最后把参数用调用时的参数替换，这样就得到了宏调用最后用于求值的表达式。这个过程称为扩展。可以用 macroexpand 函数进行模拟</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">macroexpand</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">foo</span> (<span style="color:#0086b3">incf</span> <span style="color:#008080">i</span>))) <span style="color:#998;font-style:italic">; =&gt; (message &#34;%d %d&#34; (incf i) (incf i))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面用 macroexpand 得到的结果就是用于求值的表达式。</p>
<p>使用 macroexpand 可以使宏的编写变得容易一些。但是如果不能进行 debug 是很不方便的。在宏定义里可以引入 declare 表达式，它可以增加一些信息。目前只支持两类声明：debug 和 indent。debug 可选择的类型很多，具体参考 info elisp - Edebug 一章，一般情况下用 t 就足够了。indent 的类型比较简单，它可以使用这样几种类型：</p>
<ul>
<li>nil 也就是一般的方式缩进</li>
<li>defun 类似 def 的结构，把第二行作为主体，对主体里的表达式使用同样的缩进</li>
<li>整数 表示从第 n 个表达式后作为主体。比如 if 设置为 2，而 when 设置为 1</li>
<li>符号 这个是最坏情况，你要写一个函数自己处理缩进。</li>
</ul>
<p>看 when 的定义就能知道 declare 如何使用了</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defmacro</span> <span style="color:#0086b3">when</span> (<span style="color:#0086b3">cond</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">body</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">declare</span> (<span style="color:#008080">indent</span> <span style="color:#099">1</span>) (<span style="color:#008080">debug</span> <span style="color:#008080">t</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">list</span> <span style="color:#990073">&#39;if</span> <span style="color:#0086b3">cond</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#990073">&#39;progn</span> <span style="color:#008080">body</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>实际上，declare 声明只是设置这个符号的属性列表</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">symbol-plist</span> <span style="color:#990073">&#39;when</span>)    <span style="color:#998;font-style:italic">; =&gt; (lisp-indent-function 1 edebug-form-spec t)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/10-function.html#answer-declare">思考题</a></p>
<p>一个比较常用的结构是当 buffer 是可读情况下，绑定 inhibit-read-only 值为 t 来强制插入字符串。请写一个这样的宏，处理好缩进和调用。</p>
</blockquote>
<p>从前面宏 when 的定义可以看出直接使用 list，cons，append 构造宏是很麻烦的。为了使记号简洁，lisp 中有一个特殊的宏 “`&quot;，称为 backquote。在这个宏里，所有的表达式都是引起（quote）的，如果要让一个表达式不引起（也就是列表中使用的是表达式的值），需要在前面加 “,”，如果要让一个列表作为整个列表的一部分（slice），可以用 “,@&quot;。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">`</span>(<span style="color:#008080">a</span> <span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">of</span> <span style="color:#000;font-weight:bold">,</span>(<span style="color:#900;font-weight:bold">+</span> <span style="color:#099">2</span> <span style="color:#099">3</span>) <span style="color:#008080">elements</span>)          <span style="color:#998;font-style:italic">; =&gt; (a list of 5 elements)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">some-list</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#099">2</span> <span style="color:#099">3</span>))                 <span style="color:#998;font-style:italic">; =&gt; (2 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">`</span>(<span style="color:#099">1</span> <span style="color:#000;font-weight:bold">,</span><span style="color:#008080">some-list</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">,@</span><span style="color:#008080">some-list</span>)           <span style="color:#998;font-style:italic">; =&gt; (1 (2 3) 4 2 3)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>有了这些标记，前面 when 这个宏可以写成</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defmacro</span> <span style="color:#0086b3">when</span> (<span style="color:#0086b3">cond</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">body</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">`</span>(<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">,</span><span style="color:#0086b3">cond</span>
</span></span><span style="display:flex;"><span>       (<span style="color:#000;font-weight:bold">progn</span> <span style="color:#000;font-weight:bold">,@</span><span style="color:#008080">body</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>值得注意的是这个 backquote 本身就是一个宏，从这里可以看出宏除了减少重复代码这个作用之外的另一个用途：定义新的控制结构，甚至增加新的语法特性。</p>
<h3 id="命令">命令</h3>
<p>emacs 运行时就是处于一个命令循环中，不断从用户那得到按键序列，然后调用对应命令来执行。lisp 编写的命令都含有一个 interactive 表达式。这个表达式指明了这个命令的参数。比如下面这个命令</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">hello-world</span> (<span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span> <span style="color:#d14">&#34;sWhat you name? &#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Hello, %s&#34;</span> <span style="color:#008080">name</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在你可以用 M-x 来调用这个命令。让我们来看看 interactive 的参数是什么意思。这个字符串的第一个字符（也称为代码字符）代表参数的类型，比如这里 s 代表参数的类型是一个字符串，而其后的字符串是用来提示的字符串。如果这个命令有多个参数，可以在这个提示字符串后使用换行符分开，比如：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">hello-world</span> (<span style="color:#008080">name</span> <span style="color:#0086b3">time</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span> <span style="color:#d14">&#34;sWhat you name? \nnWhat the time? &#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Good %s, %s&#34;</span>
</span></span><span style="display:flex;"><span>           (<span style="color:#0086b3">cond</span> ((<span style="color:#900;font-weight:bold">&lt;</span> <span style="color:#0086b3">time</span> <span style="color:#099">13</span>) <span style="color:#d14">&#34;morning&#34;</span>)
</span></span><span style="display:flex;"><span>                 ((<span style="color:#900;font-weight:bold">&lt;</span> <span style="color:#0086b3">time</span> <span style="color:#099">19</span>) <span style="color:#d14">&#34;afternoon&#34;</span>)
</span></span><span style="display:flex;"><span>                 (<span style="color:#008080">t</span> <span style="color:#d14">&#34;evening&#34;</span>))
</span></span><span style="display:flex;"><span>           <span style="color:#008080">name</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>interactive 可以使用的代码字符很多，虽然有一定的规则，比如字符串用 s，数字用 n，文件用 f，区域用 r，但是还是很容易忘记，用的时候看 interactive 函数的文档还是很有必要的。但是不是所有时候都参数类型都能使用代码字符，而且一个好的命令，应该尽可能的让提供默认参数以让用户少花时间在输入参数上，这时，就有可能要自己定制参数。</p>
<p>首先学习和代码字符等价的几个函数。s 对应的函数是 read-string。比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">read-string</span> <span style="color:#d14">&#34;What your name? &#34;</span> <span style="color:#008080">user-full-name</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>n 对应的函数是 read-number，文件对应 read-file-name。很容易记对吧。其实大部分代码字符都是有这样对应的函数或替换的方法（见下表）。</p>
<table>
<thead>
<tr>
<th>代码字符</th>
<th>代替的表达式</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>(completing-read prompt obarray ‘fboundp t)</td>
</tr>
<tr>
<td>b</td>
<td>(read-buffer prompt nil t)</td>
</tr>
<tr>
<td>B</td>
<td>(read-buffer prompt)</td>
</tr>
<tr>
<td>c</td>
<td>(read-char prompt)</td>
</tr>
<tr>
<td>C</td>
<td>(read-command prompt)</td>
</tr>
<tr>
<td>d</td>
<td>(point)</td>
</tr>
<tr>
<td>D</td>
<td>(read-directory-name prompt)</td>
</tr>
<tr>
<td>e</td>
<td>(read-event)</td>
</tr>
<tr>
<td>f</td>
<td>(read-file-name prompt nil nil t)</td>
</tr>
<tr>
<td>F</td>
<td>(read-file-name prompt)</td>
</tr>
<tr>
<td>G</td>
<td>暂时不知道和 f 的差别</td>
</tr>
<tr>
<td>k</td>
<td>(read-key-sequence prompt)</td>
</tr>
<tr>
<td>K</td>
<td>(read-key-sequence prompt nil t)</td>
</tr>
<tr>
<td>m</td>
<td>(mark)</td>
</tr>
<tr>
<td>n</td>
<td>(read-number prompt)</td>
</tr>
<tr>
<td>N</td>
<td>(if current-prefix-arg (prefix-numeric-value current-prefix-arg) (read-number prompt))</td>
</tr>
<tr>
<td>p</td>
<td>(prefix-numeric-value current-prefix-arg)</td>
</tr>
<tr>
<td>P</td>
<td>current-prefix-arg</td>
</tr>
<tr>
<td>r</td>
<td>(region-beginning) (region-end)</td>
</tr>
<tr>
<td>s</td>
<td>(read-string prompt)</td>
</tr>
<tr>
<td>S</td>
<td>(completing-read prompt obarray nil t)</td>
</tr>
<tr>
<td>v</td>
<td>(read-variable prompt)</td>
</tr>
<tr>
<td>x</td>
<td>(read-from-minibuffer prompt nil nil t)</td>
</tr>
<tr>
<td>X</td>
<td>(eval (read-from-minibuffer prompt nil nil t))</td>
</tr>
<tr>
<td>z</td>
<td>(read-coding-system prompt)</td>
</tr>
<tr>
<td>Z</td>
<td>(and current-prefix-arg (read-coding-system prompt))</td>
</tr>
</tbody>
</table>
<p>知道这些表达式如何用于 interactive 表达式里呢？简而言之，如果 interactive 的参数是一个表达式，则这个表达式求值后的列表元素对应于这个命令的参数。请看这个例子：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">read-hiden-file</span> (<span style="color:#008080">file</span> <span style="color:#008080">arg</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span>
</span></span><span style="display:flex;"><span>   (<span style="color:#458;font-weight:bold">list</span> (<span style="color:#008080">read-file-name</span> <span style="color:#d14">&#34;Choose a hiden file: &#34;</span> <span style="color:#d14">&#34;~/&#34;</span> <span style="color:#008080">nil</span> <span style="color:#008080">nil</span> <span style="color:#008080">nil</span>
</span></span><span style="display:flex;"><span>                         (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>                           (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;^\\.&#34;</span> (<span style="color:#008080">file-name-nondirectory</span> <span style="color:#008080">name</span>))))
</span></span><span style="display:flex;"><span>         <span style="color:#008080">current-prefix-arg</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;%s, %S&#34;</span> <span style="color:#008080">file</span> <span style="color:#008080">arg</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>第一个参数是读入一个以 “.” 开头的文件名，第二个参数为当前的前缀参数（prefix argument），它可以用 C-u 或 C-u 加数字提供。list 把这两个参数构成一个列表。这就是命令一般的自定义设定参数的方法。</p>
<p>需要注意的是 current-prefix-arg 这个变量。这个变量当一个命令被调用，它就被赋与一个值，你可以用 C-u 就能改变它的值。在命令运行过程中，它的值始终都存在。即使你的命令不用参数，你也可以访问它</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">foo</span> ()
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;%S&#34;</span> <span style="color:#008080">current-prefix-arg</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>用 C-u foo 调用它，你可以发现它的值是 (4)。那为什么大多数命令还单独为它设置一个参数呢？这是因为命令不仅是用户可以调用，很可能其它函数也可以调用，单独设置一个参数可以方便的用参数传递的方法调用这个命令。事实上所有的命令都可以不带参数，而使用前面介绍的方法在命令定义的部分读入需要的参数，但是为了提高命令的可重用性和代码的可读性，还是把参数分离到 interactive 表达式里好。</p>
<p>从现在开始可能会遇到很多函数，它们的用法有的简单，有的却复杂的要用大段篇幅来解释。我可能就会根据需要来解释一两个函数，就不一一介绍了。自己看 info elisp，用 i 来查找对应的函数。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/10-function.html#answer-switch-mode">思考题</a></p>
<p>写一个命令用来切换 major-mode。要求用户输入一个 major-mode 的名字，就切换到这个 major-mode，而且要提供一种补全的办法，去除所有不是 major-mode 的符号，这样用户需要输入少量词就能找到对应的 major-mode。</p>
</blockquote>
<h3 id="函数列表-7">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">functionp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">apply</span> <span style="color:#008080">FUNCTION</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">ARGUMENTS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">FUNCTION</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">ARGUMENTS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defmacro</span> <span style="color:#008080">NAME</span> <span style="color:#008080">ARGLIST</span> <span style="color:#008080">[DOCSTRING]</span> <span style="color:#008080">[DECL]</span> <span style="color:#008080">BODY...</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">macroexpand</span> <span style="color:#008080">FORM</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ENVIRONMENT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">declare</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">SPECS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">`</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">interactive</span> <span style="color:#008080">ARGS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-string</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">INITIAL-INPUT</span> <span style="color:#008080">HISTORY</span> <span style="color:#008080">DEFAULT-VALUE</span>
</span></span><span style="display:flex;"><span>             <span style="color:#008080">INHERIT-INPUT-METHOD</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-file-name</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIR</span> <span style="color:#008080">DEFAULT-FILENAME</span> <span style="color:#008080">MUSTMATCH</span>
</span></span><span style="display:flex;"><span>                <span style="color:#008080">INITIAL</span> <span style="color:#008080">PREDICATE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">completing-read</span> <span style="color:#008080">PROMPT</span> <span style="color:#008080">COLLECTION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">PREDICATE</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008080">REQUIRE-MATCH</span> <span style="color:#008080">INITIAL-INPUT</span> <span style="color:#008080">HIST</span> <span style="color:#008080">DEF</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008080">INHERIT-INPUT-METHOD</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-buffer</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DEF</span> <span style="color:#008080">REQUIRE-MATCH</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">read-char</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">PROMPT</span> <span style="color:#008080">INHERIT-INPUT-METHOD</span> <span style="color:#008080">SECONDS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-command</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DEFAULT-VALUE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-directory-name</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIR</span> <span style="color:#008080">DEFAULT-DIRNAME</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#008080">MUSTMATCH</span> <span style="color:#008080">INITIAL</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-event</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">PROMPT</span> <span style="color:#008080">INHERIT-INPUT-METHOD</span> <span style="color:#008080">SECONDS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-key-sequence</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">CONTINUE-ECHO</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#008080">DONT-DOWNCASE-LAST</span> <span style="color:#008080">CAN-RETURN-SWITCH-FRAME</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#008080">COMMAND-LOOP</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-number</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DEFAULT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">prefix-numeric-value</span> <span style="color:#008080">RAW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-from-minibuffer</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">INITIAL-CONTENTS</span> <span style="color:#008080">KEYMAP</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#008080">READ</span> <span style="color:#008080">HIST</span> <span style="color:#008080">DEFAULT-VALUE</span> <span style="color:#008080">INHERIT-INPUT-METHOD</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">read-coding-system</span> <span style="color:#008080">PROMPT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DEFAULT-CODING-SYSTEM</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="变量列表-2">变量列表</h3>
<pre tabindex="0"><code>current-prefix-arg
</code></pre><h3 id="问题解答-4">问题解答</h3>
<h4 id="可选误差的浮点数比较">可选误差的浮点数比较</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">approx-equal</span> (<span style="color:#008080">x</span> <span style="color:#008080">y</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">err</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">err</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">err</span> (<span style="color:#900;font-weight:bold">abs</span> <span style="color:#008080">err</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">err</span> <span style="color:#099">1.0e-6</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">or</span> (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">x</span> <span style="color:#099">0</span>) (<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">y</span> <span style="color:#099">0</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">&lt;</span> (<span style="color:#900;font-weight:bold">/</span> (<span style="color:#900;font-weight:bold">abs</span> (<span style="color:#900;font-weight:bold">-</span> <span style="color:#008080">x</span> <span style="color:#008080">y</span>))
</span></span><span style="display:flex;"><span>            (<span style="color:#900;font-weight:bold">max</span> (<span style="color:#900;font-weight:bold">abs</span> <span style="color:#008080">x</span>) (<span style="color:#900;font-weight:bold">abs</span> <span style="color:#008080">y</span>)))
</span></span><span style="display:flex;"><span>         <span style="color:#008080">err</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个应该是很简单的一个问题。</p>
<h4 id="遍历树的函数">遍历树的函数</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">tree-mapcar</span> (<span style="color:#008080">func</span> <span style="color:#008080">tree</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">consp</span> <span style="color:#008080">tree</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">mapcar</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">child</span>)
</span></span><span style="display:flex;"><span>                (<span style="color:#008080">tree-mapcar</span> <span style="color:#008080">func</span> <span style="color:#008080">child</span>))
</span></span><span style="display:flex;"><span>              <span style="color:#008080">tree</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">func</span> <span style="color:#008080">tree</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个函数可能对于树算法比较熟悉的人一点都不难，就当练手吧。</p>
<h4 id="宏-with-inhibit-read-only-t">宏 with-inhibit-read-only-t</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defmacro</span> <span style="color:#008080">with-inhibit-read-only-t</span> (<span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">body</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">declare</span> (<span style="color:#008080">indent</span> <span style="color:#099">0</span>) (<span style="color:#008080">debug</span> <span style="color:#008080">t</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#990073">&#39;let</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#008080">inhibit-read-only</span> <span style="color:#008080">t</span>))
</span></span><span style="display:flex;"><span>                   <span style="color:#008080">body</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果用 backquote 来改写一个就会发现这个宏会很容易写，而且更容易读了。</p>
<h4 id="切换-major-mode-的命令">切换 major-mode 的命令</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defvar</span> <span style="color:#008080">switch-major-mode-history</span> <span style="color:#008080">nil</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">switch-major-mode</span> (<span style="color:#008080">mode</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span>
</span></span><span style="display:flex;"><span>   (<span style="color:#458;font-weight:bold">list</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#900;font-weight:bold">intern</span>
</span></span><span style="display:flex;"><span>     (<span style="color:#008080">completing-read</span> <span style="color:#d14">&#34;Switch to mode: &#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#008080">obarray</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">s</span>)
</span></span><span style="display:flex;"><span>                                (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">fboundp</span> <span style="color:#008080">s</span>)
</span></span><span style="display:flex;"><span>                                     (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;-mode$&#34;</span> (<span style="color:#900;font-weight:bold">symbol-name</span> <span style="color:#008080">s</span>))))
</span></span><span style="display:flex;"><span>                      <span style="color:#008080">t</span> <span style="color:#008080">nil</span> <span style="color:#990073">&#39;switch-major-mode-history</span>))))
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">switch-major-mode-history</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#458;font-weight:bold">cons</span> (<span style="color:#900;font-weight:bold">symbol-name</span> <span style="color:#008080">major-mode</span>) <span style="color:#008080">switch-major-mode-history</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">mode</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是我常用的一个命令之一。这个实现也是一个使用 minibuffer 历史的例子。</p>
<h2 id="正则表达式">正则表达式</h2>
<p>如果你不懂正则表达式，而你还想进一步学习编程的话，那你应该停下手边的事情，先学学正则表达式。即使你不想学习编程，也不喜欢编程，学习一点正则表达式，也可能让你的文本编辑效率提高很多。</p>
<p>在这里，我不想详细介绍正则表达式，因为我觉得这类的文档已经很多了，比我写得好的文章多的是。如果你找不到一个好的入门教程，我建议你不妨看看 perlretut。我想说的是和 emacs 有关的正则表达式的内容，比如，和 Perl 正则表达式的差异、语法表格（syntax table）和字符分类（category）等。</p>
<h3 id="与-perl-正则表达式比较">与 Perl 正则表达式比较</h3>
<p>Perl 是文本处理的首选语言。它内置强大而简洁的正则表达式，许多程序也都兼容 Perl 的正则表达式。说实话，就简洁而言，我对 emacs 的正则表达式是非常反感的，那么多的反斜线经常让我抓狂。首先，emacs 里的反斜线构成的特殊结构（backslash construct）出现是相当频繁的。在 Perl 正则表达式里，<code>()[]{}|</code> 都是特殊字符，而 emacs 它们不是这样。所以它们匹配字符时是不用反斜线，而作为特殊结构时就要用反斜线。而事实上<code>()|</code>作为字符来匹配的情形远远小于作为捕捉字符串和作或运算的情形概率小。而 emacs 的正则表达式又没有 Perl 那种简洁的记号，完全用字符串来表示，这样使得一个正则表达式常常一眼看去全是 <code>\\</code>。</p>
<p>到底要用多少个<code>\</code>？ 经常会记不住在 emacs 的正则表达式中应该用几个 \。有一个比较好的方法，首先想想没有引号引起时的正则表达式是怎样。比如对于特殊字符 <code>$</code> 要用 <code>\$</code>，对于反斜线结构是 <code>\(</code>, <code>\{</code>，<code>\|</code> 等等。知道这个怎样写之后，再把所有 <code>\</code> 替换成 <code>\\</code>，这就是最后写到双引号里形式。所以要匹配一个 <code>\</code>，应该用 <code>\\</code>，而写在引号里就应该用 <code>\\\\</code> 来匹配。</p>
<p>emacs 里匹配的对象不仅包括字符串，还有 buffer，所以有一些对字符串和 buffer 有区分的结构。比如 <code>$</code> 对于字符串是匹配字符串的末尾，而在 buffer 里是行尾。而 <code>\'</code> 匹配的是字符串和 buffe 的末尾。对应 <code>^</code> 和 ``` 也是这样。</p>
<p>emacs 对字符有很多种分类方法，在正则表达式里也可以使用。比如按语法类型分类，可以用 “\s” 结构匹配一类语法分类的字符，最常用的比如匹配空格的 <code>\s-</code> 和匹配词的 <code>\sw</code>（等价于 <code>\w</code>）。这在 Perl 里是没有的。另外 emacs 里字符还对应一个或多个分类（category），比如所有汉字在分类 <code>c</code> 里。这样可以用 <code>\cc</code> 来匹配一个汉字。这在 Perl 里也有类似的分类。除此之外，还有一些预定义的字符分类，可以用 <code>[:class:]</code> 的形式，比如 <code>[:digit:]</code> 匹配 0-9 之间的数，<code>[:ascii:]</code> 匹配所有 ASCII 字符等等。在 Perl 里只定义几类最常用的字符集，比如 <code>\d</code>, <code>\s</code>, <code>\w</code>，但是我觉得非常实用。比 emacs 这样长的标记好用的多。</p>
<p>另外在用 <code>[]</code> 表示一个字符集时，emacs 里不能用 <code>\</code> 进行转义，事实上 <code>\</code> 在这里不是一个特殊字符。所以 emacs 里的处理方法是，把特殊字符提前或放在后面，比如如果要在字符集里包括 <code>]</code> 的话，要把 <code>]</code> 放在第一位。而如果要包括 <code>-</code>，只能放在最后一位，如果要包括 <code>^</code> 不能放在第一位。如果只想匹配一个 <code>^</code>，就只能用 <code>\^</code> 的形式。比较拗口，希望下面这个例子能帮你理解</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">str</span> <span style="color:#d14">&#34;abc]-^]123&#34;</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;[]^0-9-]+&#34;</span> <span style="color:#008080">str</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">match-string</span> <span style="color:#099">0</span> <span style="color:#008080">str</span>))                 <span style="color:#998;font-style:italic">; =&gt; &#34;]-^]123&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后提示一下，emacs 提供一个很好的正则表达式调试工具：<code>M-x re-builder</code>。它能显示 buffer 匹配正则表达式的字符串，并用不同颜色显示捕捉的字符串。</p>
<h3 id="语法表格和分类表格简介">语法表格和分类表格简介</h3>
<p>语法表格指的是 emacs 为每个字符都指定了语法功能，这为解析函数，复杂的移动命令等等提供了各种语法结构的起点和终点。语法表使用的数据结构是一种称为字符表（char-table）的数组，它能以字符作为下标（还记得 emacs 里的字符就是整数吗）来得到对应的值。语法表里一个字符对应一个语法分类的列表。每一个分类都有一个助记字符（mnemonic character）。一共有哪几类分类呢？</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>助记符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>空白（whitespace）</td>
<td>- 或 ’ '</td>
<td></td>
</tr>
<tr>
<td>词（word）</td>
<td>w</td>
<td></td>
</tr>
<tr>
<td>符号（symbol）</td>
<td>_</td>
<td>这是除 word 之外其它用于变量和命令名的字符。</td>
</tr>
<tr>
<td>标点（punctuation）</td>
<td>.</td>
<td></td>
</tr>
<tr>
<td>open 和 close</td>
<td>( 和 )</td>
<td>一般是括号 ()[]{}</td>
</tr>
<tr>
<td>字符串引号（string quote）</td>
<td>&quot;</td>
<td></td>
</tr>
<tr>
<td>转义符（escape-syntax）</td>
<td>|用于转义序列，比如 C 和 Lisp 字符串中的 \。</td>
<td></td>
</tr>
<tr>
<td>字符引号（character quote）</td>
<td>/</td>
<td></td>
</tr>
<tr>
<td>paired delimiter</td>
<td>$</td>
<td>只有 TeX 模式中使用</td>
</tr>
<tr>
<td>expression prefix</td>
<td>'</td>
<td></td>
</tr>
<tr>
<td>注释开始和注释结束</td>
<td>&lt; 和 &gt;</td>
<td></td>
</tr>
<tr>
<td>inherit standard syntax</td>
<td>@</td>
<td></td>
</tr>
<tr>
<td>generic comment delimiter</td>
<td>!</td>
<td></td>
</tr>
</tbody>
</table>
<p>语法表格可以继承，所以基本上所有语法表格都是从 standard-syntax-table 继承而来，作少量修改，加上每个模式特有的语法构成就行了。一般来说记住几类重要的分类就行了，比如，空白包括空格，制表符，换行符，换页符。词包括所有的大小写字母，数字。符号一般按使用的模式而定，比如 C 中包含 <code>_</code>，而 Lisp 中是 <code>$&amp;*+-_&lt;&gt;</code>。可以用 <code>M-x describe-syntax</code> 来查看所有字符的语法分类。</p>
<p>字符分类（category）是另一种分类方法，每个分类都有一个名字，对应一个从 ``到 <code>~</code> 的 ASCII 字符。可以用 <code>M-x describe-categories</code> 查看所有字符的分类。每一种分类都有说明，我就不详细解释了。</p>
<h3 id="几个常用的函数">几个常用的函数</h3>
<p>如果你要匹配的字符串中含有很多特殊字符，而你又想用正则表达式进行匹配，可以使用 regexp-quote 函数，它可以让字符串中的特殊字符自动转义。</p>
<p>一般多个可选词的匹配可以用或运算连接起来，但是这有两个不好的地方，一是要写很长的正则表达式，还含有很多反斜线，不好看，容易出错，也不好修改，二是效率很低。这时可以使用 regexp-opt 还产生一个更好的正则表达式</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">regexp-opt</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#d14">&#34;foobar&#34;</span> <span style="color:#d14">&#34;foobaz&#34;</span> <span style="color:#d14">&#34;foo&#34;</span>)) <span style="color:#998;font-style:italic">; =&gt; &#34;foo\\(?:ba[rz]\\)?&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="函数列表-8">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">regexp-quote</span> <span style="color:#008080">STRING</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">regexp-opt</span> <span style="color:#008080">STRINGS</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">PAREN</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="命令列表">命令列表</h3>
<pre tabindex="0"><code>describe-syntax
describe-categories
</code></pre><h2 id="操作对象之一--缓冲区">操作对象之一 – 缓冲区</h2>
<p>缓冲区（buffer）是用来保存要编辑文本的对象。通常缓冲区都是和文件相关联的，但是也有很多缓冲区没有对应的文件。emacs 可以同时打开多个文件，也就是说能同时有很多个缓冲区存在，但是在任何时候都只有一个缓冲区称为当前缓冲区（current buffer）。即使在 lisp 编程中也是如此。许多编辑和移动的命令只能针对当前缓冲区。</p>
<h3 id="缓冲区的名字">缓冲区的名字</h3>
<p>emacs 里的所有缓冲区都有一个不重复的名字。所以和缓冲区相关的函数通常都是可以接受一个缓冲区对象或一个字符串作为缓冲区名查找对应的缓冲区。下面的函数列表中如果参数是 BUFFER-OR-NAME 则是能同时接受缓冲区对象和缓冲区名的函数，否则只能接受一种参数。有一个习惯是名字以空格开头的缓冲区是临时的，用户不需要关心的缓冲区。所以现在一般显示缓冲区列表的命令都不会显示这样的变量，除非这个缓冲区关联一个文件。</p>
<p>要得到缓冲区的名字，可以用 buffer-name 函数，它的参数是可选的，如果不指定参数，则返回当前缓冲区的名字，否则返回指定缓冲区的名字。更改一个缓冲区的名字用 rename-buffer，这是一个命令，所以你可以用 M-x 调用来修改当前缓冲区的名字。如果你指定的名字与现有的缓冲区冲突，则会产生一个错误，除非你使用第二个可选参数以产生一个不相同的名字，通常是在名字后加上 <code>&lt;序号&gt;</code> 的方式使名字变得不同。你也可以用 generate-new-buffer-name 来产生一个唯一的缓冲区名。</p>
<h3 id="当前缓冲区">当前缓冲区</h3>
<p>当前缓冲区可以用 current-buffer 函数得到。当前缓冲区不一定是显示在屏幕上的那个缓冲区，你可以用 set-buffer 来指定当前缓冲区。但是需要注意的是，当命令返回到命令循环时，光标所在的缓冲区 会自动成为当前缓冲区。这也是单独在 <code>*scratch*</code> 中执行 set-buffer 后并不能改变当前缓冲区，而必须使用 progn 语句同时执行多个语句才能改变当前缓冲区的原因</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">set-buffer</span> <span style="color:#d14">&#34;*Messages*&#34;</span>)   <span style="color:#998;font-style:italic">; =&gt; #&lt;buffer *Messages*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">message</span> (<span style="color:#008080">buffer-name</span>))                  <span style="color:#998;font-style:italic">; =&gt; &#34;*scratch*&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#d14">&#34;*Messages*&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> (<span style="color:#008080">buffer-name</span>)))               <span style="color:#998;font-style:italic">; &#34;*Messages*&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是你不能依赖命令循环来把当前缓冲区设置成使用 set-buffer 之前的。因为这个命令很可以会被另一个程序员来调用。你也不能直接用 set-buffer 设置成原来的缓冲区，比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> (<span style="color:#008080">buffer-read-only</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">obuf</span> (<span style="color:#008080">current-buffer</span>)))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#000;font-weight:bold">...</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#008080">obuf</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为 set-buffer 不能处理错误或退出情况。正确的作法是使用 save-current-buffer、with-current-buffer 和 save-excursion 等方法。save-current-buffer 能保存当前缓冲区，执行其中的表达式，最后恢复为原来的缓冲区。如果原来的缓冲区被关闭了，则使用最后使用的那个当前缓冲区作为语句返回后的当前缓冲区。lisp 中很多以 with 开头的宏，这些宏通常是在不改变当前状态下，临时用另一个变量代替现有变量执行语句。比如 with-current-buffer 使用另一个缓冲区作为当前缓冲区，语句执行结束后恢复成执行之前的那个缓冲区</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">with-current-buffer</span> <span style="color:#008080">BUFFER-OR-NAME</span>
</span></span><span style="display:flex;"><span>   <span style="color:#008080">body</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>相当于</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">save-current-buffer</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#008080">BUFFER-OR-NAME</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#008080">body</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>save-excursion 与 save-current-buffer 不同之处在于，它不仅保存当前缓冲区，还保存了当前的位置和 mark。在 <code>*scratch*</code> 缓冲区中运行下面两个语句就能看出它们的差别了</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">save-current-buffer</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#d14">&#34;*scratch*&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#d14">&#34;*Messages*&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">save-excursion</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#d14">&#34;*scratch*&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-buffer</span> <span style="color:#d14">&#34;*Messages*&#34;</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建和关闭缓冲区">创建和关闭缓冲区</h3>
<p>产生一个缓冲区必须用给这个缓冲区一个名字，所以两个能产生新缓冲区的函数都是以一个字符串为参数：get-buffer-create 和 generate-new-buffer。这两个函数的差别在于前者如果给定名字的缓冲区已经存在，则返回这个缓冲区对象，否则新建一个缓冲区，名字为参数字符串，而后者在给定名字的缓冲区存在时，会使用加上后缀 <code>&lt;N&gt;</code>（N 是一个整数，从 2 开始） 的名字创建新的缓冲区。</p>
<p>关闭一个缓冲区可以用 kill-buffer。当关闭缓冲区时，如果要用户确认是否要关闭缓冲区，可以加到 kill-buffer-query-functions 里。如果要做一些善后处理，可以用 kill-buffer-hook。</p>
<p>通常一个接受缓冲区作为参数的函数都需要参数所指定的缓冲区是存在的。如果要确认一个缓冲区是否依然还存在可以使用 buffer-live-p。</p>
<p>要对所有缓冲区进行某个操作，可以用 buffer-list 获得所有缓冲区的列表。</p>
<p>如果你只是想使用一个临时的缓冲区，而不想先建一个缓冲区，使用结束后又需要关闭这个缓冲区，可以用 with-temp-buffer 这个宏。从这个宏的名字可以看出，它所做的事情是先新建一个临时缓冲区，并把这个缓冲区作为当前缓冲区，使用结束后，关闭这个缓冲区，并恢复之前的缓冲区为当前缓冲区。</p>
<h3 id="在缓冲区内移动">在缓冲区内移动</h3>
<p>在学会移动函数之前，先要理解两个概念：位置（position）和标记（mark）。位置是指某个字符在缓冲区内的下标，它从 1 开始。更准确的说位置是在两个字符之间，所以有在位置之前的字符和在位置之后的字符之说。但是通常我们说在某个位置的字符都是指在这个位置之后的字符。</p>
<p>标记和位置的区别在于位置会随文本插入和删除而改变位置。一个标记包含了缓冲区和位置两个信息。在插入和删除缓冲区里的文本时，所有的标记都会检查一遍，并重新设置位置。这对于含有大量标记的缓冲区处理是很花时间的，所以当你确认某个标记不用的话应该释放这个标记。</p>
<p>创建一个标记使用函数 make-marker。这样产生的标记不会指向任何地方。你需要用 set-marker 命令来设置标记的位置和缓冲区</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">make-marker</span>))             <span style="color:#998;font-style:italic">; =&gt; #&lt;marker in no buffer&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-marker</span> <span style="color:#008080">foo</span> (<span style="color:#008080">point</span>))             <span style="color:#998;font-style:italic">; =&gt; #&lt;marker at 3594 in *scratch*&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以用 point-marker 直接得到 point 处的标记。或者用 copy-marker 复制一个标记或者直接用位置生成一个标记</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">point-marker</span>)                       <span style="color:#998;font-style:italic">; =&gt; #&lt;marker at 3516 in *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">copy-marker</span> <span style="color:#099">20</span>)                     <span style="color:#998;font-style:italic">; =&gt; #&lt;marker at 20 in *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">copy-marker</span> <span style="color:#008080">foo</span>)                    <span style="color:#998;font-style:italic">; =&gt; #&lt;marker at 3502 in *scratch*&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果要得一个标记的内容，可以用 marker-position，marker-buffer</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">marker-position</span> <span style="color:#008080">foo</span>)                <span style="color:#998;font-style:italic">; =&gt; 3502</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">marker-buffer</span> <span style="color:#008080">foo</span>)                  <span style="color:#998;font-style:italic">; =&gt; #&lt;buffer *scratch*&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>位置就是一个整数，而标记在一般情况下都是以整数的形式使用，所以很多接受整数运算的函数也可以接受标记为参数。比如加减乘。</p>
<p>和缓冲区相关的变量，有的可以用变量得到，比如缓冲区关联的文件名，有的只能用函数来得到，比如 point。point 是一个特殊的缓冲区位置，许多命令在这个位置进行文本插入。每个缓冲区都有一个 point 值，它总是比函数 point-min 大，比另一个函数 point-max 返回值小。注意，point-min 的返回值不一定是 1，point-max 的返回值也不定是比缓冲区大小函数 buffer-size 的返回值大 1 的数，因为 emacs 可以把一个缓冲区缩小（narrow）到一个区域，这时 point-min 和 point-max 返回值就是这个区域的起点和终点位置。所以要得到 point 的范围，只能用这两个函数，而不能用 1 和 buffer-size 函数。</p>
<p>和 point 类似，有一个特殊的标记称为 “the mark”。它指定了一个区域的文本用于某些命令，比如 kill-region，indent-region。可以用 mark 函数返回当前 mark 的值。如果使用 transient-mark-mode，而且 mark-even-if-inactive 值是 nil 的话，在 mark 没有激活时（也就是 mark-active 的值为 nil），调用 mark 函数会产生一个错误。如果传递一个参数 force 才能返回当前缓冲区 mark 的位置。mark-marker 能返回当前缓冲区的 mark，这不是 mark 的拷贝，所以设置它的值会改变当前 mark 的值。set-mark 可以设置 mark 的值，并激活 mark。每个缓冲区还维护一个 mark-ring，这个列表里保存了 mark 的前一个值。当一个命令修改了 mark 的值时，通常要把旧的值放到 mark-ring 里。可以用 push-mark 和 pop-mark 加入或删除 mark-ring 里的元素。当缓冲区里 mark 存在且指向某个位置时，可以用 region-beginning 和 region-end 得到 point 和 mark 中较小的和较大的值。当然如果使用 transient-mark-mode 时，需要激活 mark，否则会产生一个错误。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/12-buffer.html#answer-mark">思考题</a></p>
<p>写一个命令，对于使用 transient-mark-mode 时，当选中一个区域时显示区域 的起点和终点，否则显示 point-min 和 point-max 的位置。如果不使用 transient-mark-mode，则显示 point 和 mark 的位置。</p>
</blockquote>
<p>按单个字符位置来移动的函数主要使用 goto-char 和 forward-char、backward-char。前者是按缓冲区的绝对位置移动，而后者是按 point 的偏移位置移动比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))                   <span style="color:#998;font-style:italic">; 跳到缓冲区开始位置</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">forward-char</span> <span style="color:#099">10</span>)                         <span style="color:#998;font-style:italic">; 向前移动 10 个字符</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">forward-char</span> <span style="color:#099">-10</span>)                        <span style="color:#998;font-style:italic">; 向后移动 10 个字符</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可能有一些写 elisp 的人没有读文档或者贪图省事，就在写的 elisp 里直接用 beginning-of-buffer 和 end-of-buffer 来跳到缓冲区的开头和末尾，这其实是不对的。因为这两个命令还做了其它事情，比如设置标记等等。同样，还有一些函数都是不推荐在 elisp 中使用的，如果你准备写一个要发布 elisp，还是要注意一下。</p>
<p>按词移动使用 forward-word 和 backward-word。至于什么是词，这就要看语法表格的定义了。</p>
<p>按行移动使用 forward-line。没有 backward-line。forward-line 每次移动都是移动到行首的。所以，如果要移动到当前行的行首，使用 (forward-line 0)。如果不想移动就得到行首和行尾的位置，可以用 line-beginning-position 和 line-end-position。得到当前行的行号可以用 line-number-at-pos。需要注意的是这个行号是从当前状态下的行号，如果使用 narrow-to-region 或者用 widen 之后都有可能改变行号。</p>
<p>由于 point 只能在 point-min 和 point-max 之间，所以 point 位置测试有时是很重要的，特别是在循环条件测试里。常用的测试函数是 bobp（beginning of buffer predicate）和 eobp（end of buffer predicate）。对于行位置测试使用 bolp（beginning of line predicate）和 eolp（end of line predicate）。</p>
<h3 id="缓冲区的内容">缓冲区的内容</h3>
<p>要得到整个缓冲区的文本，可以用 buffer-string 函数。如果只要一个区间的文本，使用 buffer-substring 函数。point 附近的字符可以用 char-after 和 char-before 得到。point 处的词可以用 current-word 得到，其它类型的文本，比如符号，数字，S 表达式等等，可以用 thing-at-point 函数得到。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/12-buffer.html#answer-marksexp">思考题</a></p>
<p>参考 thing-at-point 写一个命令标记光标处的 S 表达式。这个命令和 mark-sexp 不同的是，它能从整个 S 表达式的开始标记。</p>
</blockquote>
<h3 id="修改缓冲区的内容">修改缓冲区的内容</h3>
<p>要修改缓冲区的内容，最常见的就是插入、删除、查找、替换了。下面就分别介绍这几种操作。</p>
<p>插入文本最常用的命令是 insert。它可以插入一个或者多个字符串到当前缓冲区的 point 后。也可以用 insert-char 插入单个字符。插入另一个缓冲区的一个区域使用 insert-buffer-substring。</p>
<p>删除一个或多个字符使用 delete-char 或 delete-backward-char。删除一个区间使用 delete-region。如果既要删除一个区间又要得到这部分的内容使用 delete-and-extract-region，它返回包含被删除部分的字符串。</p>
<p>最常用的查找函数是 re-search-forward 和 re-search-backward。这两个函数参数如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">re-search-forward</span> <span style="color:#008080">REGEXP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BOUND</span> <span style="color:#008080">NOERROR</span> <span style="color:#008080">COUNT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">re-search-backward</span> <span style="color:#008080">REGEXP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BOUND</span> <span style="color:#008080">NOERROR</span> <span style="color:#008080">COUNT</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 BOUND 指定查找的范围，默认是 point-max（对于 re-search-forward）或 point-min（对于 re-search-backward），NOERROR 是当查找失败后是否要产生一个错误，一般来说在 elisp 里都是自己进行错误处理，所以这个一般设置为 t，这样在查找成功后返回区配的位置，失败后会返回 nil。COUNT 是指定查找匹配的次数。</p>
<p>替换一般都是在查找之后进行，也是使用 replace-match 函数。和字符串的替换不同的是不需要指定替换的对象了。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/12-buffer.html#answer-replace">思考题</a></p>
<p>从 OpenOffice 字处理程序里拷贝到 emacs 里的表格通常都是每一个单元格就是一行的。写一个命令，让用户输入表格的列数，把选中区域转换成用制表符分隔的表格。</p>
</blockquote>
<h3 id="函数列表-9">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">buffer-name</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BUFFER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">rename-buffer</span> <span style="color:#008080">NEWNAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">UNIQUE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">generate-new-buffer-name</span> <span style="color:#008080">NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">IGNORE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">current-buffer</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-buffer</span> <span style="color:#008080">BUFFER-OR-NAME</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">save-current-buffer</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">with-current-buffer</span> <span style="color:#008080">BUFFER-OR-NAME</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">save-excursion</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-buffer-create</span> <span style="color:#008080">NAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">generate-new-buffer</span> <span style="color:#008080">NAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">kill-buffer</span> <span style="color:#008080">BUFFER-OR-NAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">buffer-live-p</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">buffer-list</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FRAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">with-temp-buffer</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-marker</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-marker</span> <span style="color:#008080">MARKER</span> <span style="color:#008080">POSITION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BUFFER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">point-marker</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">copy-marker</span> <span style="color:#008080">MARKER</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">TYPE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">marker-position</span> <span style="color:#008080">MARKER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">marker-buffer</span> <span style="color:#008080">MARKER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">point</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">point-min</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">point-max</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">buffer-size</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BUFFER</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">mark</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FORCE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">mark-marker</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-mark</span> <span style="color:#008080">POS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">push-mark</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">LOCATION</span> <span style="color:#008080">NOMSG</span> <span style="color:#008080">ACTIVATE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">pop-mark</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">region-beginning</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">region-end</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">goto-char</span> <span style="color:#008080">POSITION</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">forward-char</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">backward-char</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">beginning-of-buffer</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">end-of-buffer</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">forward-word</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">backward-word</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ARG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">forward-line</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">line-beginning-position</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">line-end-position</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">N</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">line-number-at-pos</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">POS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">narrow-to-region</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">widen</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">bobp</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">eobp</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">bolp</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">eolp</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">buffer-string</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">buffer-substring</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">char-after</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">POS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">char-before</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">POS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">current-word</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">STRICT</span> <span style="color:#008080">REALLY-WORD</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">thing-at-point</span> <span style="color:#008080">THING</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">insert</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">ARGS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">insert-char</span> <span style="color:#008080">CHARACTER</span> <span style="color:#008080">COUNT</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">INHERIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">insert-buffer-substring</span> <span style="color:#008080">BUFFER</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-char</span> <span style="color:#008080">N</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">KILLFLAG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-backward-char</span> <span style="color:#008080">N</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">KILLFLAG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-region</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-and-extract-region</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">re-search-forward</span> <span style="color:#008080">REGEXP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BOUND</span> <span style="color:#008080">NOERROR</span> <span style="color:#008080">COUNT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">re-search-backward</span> <span style="color:#008080">REGEXP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">BOUND</span> <span style="color:#008080">NOERROR</span> <span style="color:#008080">COUNT</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="问题解答-5">问题解答</h3>
<h4 id="可选择区域也可不选择区域的命令">可选择区域也可不选择区域的命令</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">show-region</span> (<span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span>
</span></span><span style="display:flex;"><span>   (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#0086b3">or</span> (<span style="color:#458;font-weight:bold">null</span> <span style="color:#008080">transient-mark-mode</span>)
</span></span><span style="display:flex;"><span>           <span style="color:#008080">mark-active</span>)
</span></span><span style="display:flex;"><span>       (<span style="color:#458;font-weight:bold">list</span> (<span style="color:#008080">region-beginning</span>) (<span style="color:#008080">region-end</span>))
</span></span><span style="display:flex;"><span>     (<span style="color:#458;font-weight:bold">list</span> (<span style="color:#008080">point-min</span>) (<span style="color:#008080">point-max</span>))))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Region start from %d to %d&#34;</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是通常那种如果选择区域则对这个区域应用命令，否则对整个缓冲区应用命令的方法。我喜欢用 transient-mark-mode，因为它让这种作用于区域的命令更灵活。当然也有人反对，无所谓了，emacs 本身就是很个性化的东西。</p>
<h4 id="标记整个-s-表达式">标记整个 S 表达式</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">mark-whole-sexp</span> ()
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">bound</span> (<span style="color:#008080">bounds-of-thing-at-point</span> <span style="color:#990073">&#39;sexp</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">bound</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">goto-char</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">bound</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">set-mark</span> (<span style="color:#008080">point</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">goto-char</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">bound</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">message</span> <span style="color:#d14">&#34;No sexp found at point!&#34;</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><p>学习过程中应该可以看看其它一些函数是怎样实现的，从这些源代码中常常能学到很多有用的技巧和方法。比如要标记整个 S 表达式，联想到 thing-at-point 能得到整个 S 表达式，那自然能得到整个 S 表达式的起点和终点了。所以看看 thing-at-point 的实现，一个很简单的函数，一眼就能发现其中最关键的函数是 bounds-of-thing-at-point，它能返回某个语法实体（syntactic entity）的起点和终点。这样这个命令就很容易就能写出来了。从这个命令中还应该注意到的是对于错误应该很好的处理，让用户明白发生什么错了。比如这里，如果当前光标下没有 S 表达式时，bound 变量为 nil，如果不进行判断，会出现错误：</p>
<pre tabindex="0"><code>Wrong type argument: integer-or-marker-p, nil
</code></pre><p>加上这个判断，用户就明白发生什么事了。</p>
<h4 id="oowriter-表格转换">oowriter 表格转换</h4>
<p>实现这个目的有多种方法：</p>
<ol>
<li>一行一行移动，删除回车，替换成制表符</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">oowrite-table-convert</span> (<span style="color:#008080">col</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span> <span style="color:#d14">&#34;nColumns of table: \nr&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">col</span> (<span style="color:#900;font-weight:bold">1-</span> <span style="color:#008080">col</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">save-excursion</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">save-restriction</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">narrow-to-region</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">while</span> (<span style="color:#900;font-weight:bold">not</span> (<span style="color:#008080">eobp</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#0086b3">dotimes</span> (<span style="color:#008080">i</span> <span style="color:#008080">col</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">forward-line</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">backward-delete-char</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">insert-char</span> <span style="color:#008080">?\t</span> <span style="color:#099">1</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">forward-line</span> <span style="color:#099">1</span>)))))
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>用 subst-char-in-region 函数直接替换</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">oowrite-table-convert</span> (<span style="color:#008080">col</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span> <span style="color:#d14">&#34;nColumns of table: \nr&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">save-excursion</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">save-restriction</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">narrow-to-region</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">while</span> (<span style="color:#900;font-weight:bold">not</span> (<span style="color:#008080">eobp</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">subst-char-in-region</span>
</span></span><span style="display:flex;"><span>         (<span style="color:#008080">point</span>) (<span style="color:#000;font-weight:bold">progn</span> (<span style="color:#008080">forward-line</span> <span style="color:#008080">col</span>) (<span style="color:#900;font-weight:bold">1-</span> (<span style="color:#008080">point</span>)))
</span></span><span style="display:flex;"><span>         <span style="color:#008080">?\n</span> <span style="color:#008080">?\t</span>)))))
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>用 re-search-forward 和 replace-match 查找替</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">oowrite-table-convert</span> (<span style="color:#008080">col</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span> <span style="color:#d14">&#34;nColumns of table: \nr&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> (<span style="color:#008080">start</span> <span style="color:#008080">bound</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">save-excursion</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">save-restriction</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">narrow-to-region</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">while</span> (<span style="color:#900;font-weight:bold">not</span> (<span style="color:#008080">eobp</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">start</span> (<span style="color:#008080">point</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">forward-line</span> <span style="color:#008080">col</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">bound</span> (<span style="color:#008080">copy-marker</span> (<span style="color:#900;font-weight:bold">1-</span> (<span style="color:#008080">point</span>))))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">goto-char</span> <span style="color:#008080">start</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">while</span> (<span style="color:#008080">re-search-forward</span> <span style="color:#d14">&#34;\n&#34;</span> <span style="color:#008080">bound</span> <span style="color:#008080">t</span>)
</span></span><span style="display:flex;"><span>            (<span style="color:#008080">replace-match</span> <span style="color:#d14">&#34;\t&#34;</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">goto-char</span> (<span style="color:#900;font-weight:bold">1+</span> <span style="color:#008080">bound</span>)))))))
</span></span></code></pre></td></tr></table>
</div>
</div><p>之所以要给出这三种方法，是想借此说明 elisp 编程其实要实现一个目的通常有 很多种方法，选择一种适合的方法。比如这个问题较好的方法是使用第二种方法， 前提是你要知道有 subst-char-in-region 这个函数，这就要求你对 emacs 提供 的内置的函数比较熟悉了，没有别的办法，只有自己多读 elisp manual，如果你 真想学习 elisp 的话，读 manual 还是值得的，我每读一遍都会有一些新的发 现。如果你不知道这个函数，只知道常用的函数，那么相比较而言，第一种方法 是比较容易想到，也比较容易实现的。但是事实上第三种方法才是最重要的方法， 因为这个方法是适用范围最广的。试想一下你如果不是替换两个字符，而是字符 串的话，前面两种方法都没有办法使用了，而这个方法只要稍微修改就能用了。</p>
<p>另外，需要特别说明的是这个命令中 bound 使用的是一个标记而不是一个位置， 如果替换的字符串和删除的字符串是相同长度的，当前用什么都可以，否则就要 注意了，因为在替换之后，边界就有可能改变。这也是写查找替换的函数中很容 易出现的一个错误。解决的办法，一是像我这样用一个标记来记录边界位置。另 一种就是用 narrow-to-region 的方法，先把缓冲区缩小到查找替换的区域，结 束后用 widen 展开。当然为了省事，可以直接用 save-restriction。</p>
<h2 id="操作对象之二--窗口">操作对象之二 – 窗口</h2>
<p>首先还是要定义一下什么是窗口（window）。窗口是屏幕上用于显示一个缓冲区 的部分。和它要区分开来的一个概念是 frame。frame 是 Emacs 能够使用屏幕的 部分。可以用窗口的观点来看 frame 和窗口，一个 frame 里可以容纳多个（至 少一个）窗口，而 Emacs 可以有多个 frame。（可能需要和通常所说的窗口的概 念要区分开来，一般来说，我们所说的其它程序的窗口更类似于 Emacs 的一个 frame，所以也有人认为这里 window 译为窗格更好一些。但是窗格这个词是一个 生造出来的词，我还是用窗口比较顺一些，大家自己注意就行了。）在任何时候， 都有一个被选中的 frame，而在这个 frame 里有一个被选中的窗口，称为选择的 窗口（selected window）。</p>
<h3 id="分割窗口">分割窗口</h3>
<p>刚启动时，emacs 都是只有一个 frame 一个窗口。多个窗口都是用分割窗口的函 数生成的。分割窗口的内建函数是 split-window。这个函数的参数如下：</p>
<pre tabindex="0"><code>(split-window &amp;optional window size horizontal)
</code></pre><p>这个函数的功能是把当前或者指定窗口进行分割，默认分割方式是水平分割，可 以将参数中的 horizontal 设置为 non-nil 的值，变成垂直分割。如果不指定 大小，则分割后两个窗口的大小是一样的。分割后的两个窗口里的缓冲区是同 一个缓冲区。使用这个函数后，光标仍然在原窗口，而返回的新窗口对象：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">selected-window</span>)                       <span style="color:#998;font-style:italic">; =&gt; #&lt;window 136 on *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">split-window</span>)                          <span style="color:#998;font-style:italic">; =&gt; #&lt;window 138 on *scratch*&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意的是，窗口的分割也需要用树的结构来看分割后的窗口，比如这样一个过程：</p>
<pre tabindex="0"><code>    +---------------+         +---------------+
    |               |         |      |        |
    | win1          |         | win1 | win2   |
    |               |   --&gt;   |      |        |
    |               |         |      |        |
    +---------------+         +---------------+
                                     |
                                     v
    +---------------+         +---------------+
    | win1   |      |         |       |       |
    |        | win2 |         | win1  | win2  |
    |--------|      |   &lt;--   |-------|       |
    | 3 | 4  |      |         | win3  |       |
    |   |    |      |         |       |       |
    +---------------+         +---------------+
</code></pre><p>可以看成是这样一种结构：</p>
<pre tabindex="0"><code>(win1) -&gt;  (win1 win2) -&gt; ((win1 win3) win2) -&gt; ((win1 (win3 win4)) win2)
</code></pre><p>事实上可以用 window-tree 函数得到当前窗口的结构，如果忽略 minibuffer 对应的窗口，得到的应该类似这样的一个结果：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">nil</span> (<span style="color:#099">0</span> <span style="color:#099">0</span> <span style="color:#099">170</span> <span style="color:#099">42</span>)
</span></span><span style="display:flex;"><span>     (<span style="color:#008080">t</span> (<span style="color:#099">0</span> <span style="color:#099">0</span> <span style="color:#099">85</span> <span style="color:#099">42</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a61717;background-color:#e3d2d2">#</span><span style="color:#008080">&lt;win</span> <span style="color:#008080">3&gt;</span>
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">nil</span> (<span style="color:#099">0</span> <span style="color:#099">21</span> <span style="color:#099">85</span> <span style="color:#099">42</span>) <span style="color:#a61717;background-color:#e3d2d2">#</span><span style="color:#008080">&lt;win</span> <span style="color:#008080">8&gt;</span> <span style="color:#a61717;background-color:#e3d2d2">#</span><span style="color:#008080">&lt;win</span> <span style="color:#008080">10&gt;</span>))
</span></span><span style="display:flex;"><span>     <span style="color:#a61717;background-color:#e3d2d2">#</span><span style="color:#008080">&lt;win</span> <span style="color:#008080">6&gt;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>window-tree 返回值的第一个元素代表子窗口的分割方式，nil 表示水平分割， t 表示垂直分割。第二个元素代表整个结构的大小，这四个数字可以看作是左上 和右下两个顶点的坐标。其余元素是子窗口。每个子窗口也是同样的结构。所以 把前面这个列表还原成窗口排列应该是这样：</p>
<pre tabindex="0"><code>     (0,0) +-------------------+
           |         |         |
           | win 3   |  win6   |
           |         |         |
    (0,21) |---------|         |
           |    |    |         |
           | 8  | 10 |         |
           |    |    |         |
           +-------------------+ (170, 42)
                   (85, 42)
</code></pre><p>由上面的图可以注意到由 window-tree 返回的结果一些窗口的大小不能确定， 比较上面的 win 8 和 win 10 只能知道它们合并起来的大小，不能确定它们分 别的宽度是多少。</p>
<h3 id="删除窗口">删除窗口</h3>
<p>如果要让一个窗口不显示在屏幕上，要使用 delete-window 函数。如果没有指定 参数，删除的窗口是当前选中的窗口，如果指定了参数，删除的是这个参数对应 的窗口。删除的窗口多出来的空间会自动加到它的邻接的窗口中。如果要删除除 了当前窗口之外的窗口，可以用 delete-other-windows 函数。</p>
<p>当一个窗口不可见之后，这个窗口对象也就消失了</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">selected-window</span>))            <span style="color:#998;font-style:italic">; =&gt; #&lt;window 90 on *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-window</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">windowp</span> <span style="color:#008080">foo</span>)                           <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-live-p</span> <span style="color:#008080">foo</span>)                     <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="窗口配置">窗口配置</h3>
<p>窗口配置 (window configuration) 包含了 frame 中所有窗口的位置信息：窗口 大小，显示的缓冲区，缓冲区中光标的位置和 mark，还有 fringe，滚动条等等。 用 current-window-configuration 得到当前窗口配置，用 set-window-configuration 来还原</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">current-window-configuration</span>))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; do sth to make some changes on windows</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-window-configuration</span> <span style="color:#008080">foo</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="选择窗口">选择窗口</h3>
<p>可以用 selected-window 得到当前光标所在的窗口</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">selected-window</span>)                       <span style="color:#998;font-style:italic">; =&gt; #&lt;window 104 on *scratch*&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以用 select-window 函数使某个窗口变成选中的窗口</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">selected-window</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Original window: %S&#34;</span> <span style="color:#008080">foo</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">other-window</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Current window: %S&#34;</span> (<span style="color:#008080">selected-window</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">select-window</span> <span style="color:#008080">foo</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">message</span> <span style="color:#d14">&#34;Back to original window: %S&#34;</span> <span style="color:#008080">foo</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>两个特殊的宏可以保存窗口位置执行语句：save-selected-window 和 with-selected-window。它们的作用是在执行语句结束后选择的窗口仍留在执行 语句之前的窗口。with-selected-window 和 save-selected-window 几乎相同， 只不过 save-selected-window 选择了其它窗口。这两个宏不会保存窗口的位置 信息，如果执行语句结束后，保存的窗口已经消失，则会选择最后一个选择的窗 口。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; 让另一个窗口滚动到缓冲区开始</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">save-selected-window</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">select-window</span> (<span style="color:#008080">next-window</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>当前 frame 里所有的窗口可以用 window-list 函数得到。可以用 next-window 来得到在 window-list 里排在某个 window 之后的窗口。对应的用 previous-window 得到排在某个 window 之前的窗口。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">selected-window</span>)                       <span style="color:#998;font-style:italic">; =&gt; #&lt;window 245 on *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-list</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt; (#&lt;window 245 on *scratch*&gt; #&lt;window 253 on *scratch*&gt; #&lt;window 251 on *info*&gt;)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-window</span>)                           <span style="color:#998;font-style:italic">; =&gt; #&lt;window 253 on *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-window</span> (<span style="color:#008080">next-window</span>))             <span style="color:#998;font-style:italic">; =&gt; #&lt;window 251 on *info*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-window</span> (<span style="color:#008080">next-window</span> (<span style="color:#008080">next-window</span>))) <span style="color:#998;font-style:italic">; =&gt; #&lt;window 245 on *scratch*&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>walk-windows 可以遍历窗口，相当于 (mapc proc (window-list))。 get-window-with-predicate 用于查找符合某个条件的窗口。</p>
<h3 id="窗口大小信息">窗口大小信息</h3>
<p>窗口是一个长方形区域，所以窗口的大小信息包括它的高度和宽度。用来度量窗 口大小的单位都是以字符数来表示，所以窗口高度为 45 指的是这个窗口可以容 纳 45 行字符，宽度为 140 是指窗口一行可以显示 140 个字符。</p>
<p>mode line 和 header line 都包含在窗口的高度里，所以有 window-height 和 window-body-height 两个函数，后者返回把 mode-line 和 header line 排除后 的高度。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">window-height</span>)                         <span style="color:#998;font-style:italic">; =&gt; 45</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-body-height</span>)                    <span style="color:#998;font-style:italic">; =&gt; 44</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>滚动条和 fringe 不包括在窗口的亮度里，window-width 返回窗口的宽度</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">window-width</span>)                          <span style="color:#998;font-style:italic">; =&gt; 72</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以用 window-edges 返回各个顶点的坐标信息</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">window-edges</span>)                          <span style="color:#998;font-style:italic">; =&gt; (0 0 73 45)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>window-edges 返回的位置信息包含了滚动条、fringe、mode line、header line 在内，window-inside-edges 返回的就是窗口的文本区域的位置</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">window-inside-edges</span>)                   <span style="color:#998;font-style:italic">; =&gt; (1 0 73 44)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果需要的话也可以得到用像素表示的窗口位置信息</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">window-pixel-edges</span>)                    <span style="color:#998;font-style:italic">; =&gt; (0 0 511 675)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-inside-pixel-edges</span>)             <span style="color:#998;font-style:italic">; =&gt; (7 0 511 660)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/13-window.html#answer-save-winconf">思考题</a></p>
<p>current-window-configuration 可以将当前窗口的位置信 息保存到一个变量中以便将来恢复窗口。但是这个对象没有读入形式，所以不 能保存到文件中。请写一个函数可以把当前窗口的位置信息生成一个列表，然 后用一个函数就能从这个列表恢复窗口。提示：这个列表结构用窗口的分割顺 序表示。比如用这样一个列表表示对应的窗口：</p>
<pre tabindex="0"><code>;; +---------------+
;; |   |   |       |
;; |-------|       |
;; |       |       |
;; +---------------+
;; =&gt;
(horizontal 73
            (vertical 22
                      (horizontal 36 win win)
                      win)
            win)
</code></pre></blockquote>
<h3 id="窗口对应的缓冲区">窗口对应的缓冲区</h3>
<p>窗口对应的缓冲区可以用 window-buffer 函数得到：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">window-buffer</span>)                         <span style="color:#998;font-style:italic">; =&gt; #&lt;buffer *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-buffer</span> (<span style="color:#008080">next-window</span>))           <span style="color:#998;font-style:italic">; =&gt; #&lt;buffer *info*&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>缓冲区对应的窗口也可以用 get-buffer-window 得到。如果有多个窗口显示同一 个缓冲区，那这个函数只能返回其中的一个，由 window-list 决定。如果要得到 所有的窗口，可以用 get-buffer-window-list</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">get-buffer-window</span> (<span style="color:#008080">get-buffer</span> <span style="color:#d14">&#34;*scratch*&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt; #&lt;window 268 on *scratch*&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-buffer-window-list</span> (<span style="color:#008080">get-buffer</span> <span style="color:#d14">&#34;*scratch*&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt; (#&lt;window 268 on *scratch*&gt; #&lt;window 270 on *scratch*&gt;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>让某个窗口显示某个缓冲区可以用 set-window-buffer 函数。 让选中窗口显示某个缓冲区也可以用 switch-to-buffer，但是一般不要在 elisp 编程中用这个命令，如果需要让某个缓冲区成为当前缓冲区使用 set-buffer 函数，如果要让当前窗口显示某个缓冲区，使用 set-window-buffer 函数。</p>
<p>让一个缓冲区可见可以用 display-buffer。默认的行为是当缓冲区已经显示在某 个窗口中时，如果不是当前选中窗口，则返回那个窗口，如果是当前选中窗口， 且如果传递的 not-this-window 参数为 non-nil 时，会新建一个窗口，显示缓 冲区。如果没有任何窗口显示这个缓冲区，则新建一个窗口显示缓冲区，并返回 这个窗口。display-buffer 是一个比较高级的命令，用户可以通过一些变量来改 变这个命令的行为。比如控制显示的 pop-up-windows， display-buffer-reuse-frames，pop-up-frames，控制新建窗口高度的 split-height-threshold，even-window-heights，控制显示的 frame 的 special-display-buffer-names，special-display-regexps， special-display-function，控制是否应该显示在当前选中窗口 same-window-buffer-names，same-window-regexps 等等。如果这些还不能满 足你的要求（事实上我觉得已经太复杂了），你还可以自己写一个函数，将 display-buffer-function 设置成这个函数。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/13-window.html#answer-winconf">思考题</a></p>
<p>前一个思考题只能还原窗口，不能还原缓冲区。请修改一下使它能保存缓冲区信息，还原时让对应的窗口显示对应的缓冲区。</p>
</blockquote>
<h3 id="改变窗口显示区域">改变窗口显示区域</h3>
<p>每个窗口会保存一个显示缓冲区的起点位置，这个位置对应于窗口左上角光标在 缓冲区里的位置。可以用 window-start 函数得到某个窗口的起点位置。可以通 过 set-window-start 来改变显示起点位置。可以通过 pos-visible-in-window-p 来检测缓冲区中某个位置是否是可见的。 但是直接通过 set-window-start 来控制显示比较容易出现错误，因为 set-window-start 并不会改变 point 所在的位置，在窗口调用 redisplay 函 数之后 point 会跳到相应的位置。如果你确实有这个需要，我建议还是用： (with-selected-window window (goto-char pos)) 来代替。</p>
<h3 id="函数列表-10">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">windowp</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">split-window</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span> <span style="color:#008080">SIZE</span> <span style="color:#008080">HORFLAG</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">selected-window</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-tree</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FRAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-window</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-other-windows</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">current-window-configuration</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FRAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-window-configuration</span> <span style="color:#008080">CONFIGURATION</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">other-window</span> <span style="color:#008080">ARG</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ALL-FRAMES</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">save-selected-window</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">with-selected-window</span> <span style="color:#008080">WINDOW</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">BODY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-list</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FRAME</span> <span style="color:#008080">MINIBUF</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-window</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span> <span style="color:#008080">MINIBUF</span> <span style="color:#008080">ALL-FRAMES</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">previous-window</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span> <span style="color:#008080">MINIBUF</span> <span style="color:#008080">ALL-FRAMES</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">walk-windows</span> <span style="color:#008080">PROC</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">MINIBUF</span> <span style="color:#008080">ALL-FRAMES</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-window-with-predicate</span> <span style="color:#008080">PREDICATE</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">MINIBUF</span> <span style="color:#008080">ALL-FRAMES</span> <span style="color:#008080">DEFAULT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-height</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-body-height</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-width</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-edges</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-inside-edges</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-pixel-edges</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-inside-pixel-edges</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-buffer</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-buffer-window</span> <span style="color:#008080">BUFFER-OR-NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FRAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-buffer-window-list</span> <span style="color:#008080">BUFFER-OR-NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">MINIBUF</span> <span style="color:#008080">FRAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-window-buffer</span> <span style="color:#008080">WINDOW</span> <span style="color:#008080">BUFFER-OR-NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">KEEP-MARGINS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">switch-to-buffer</span> <span style="color:#008080">BUFFER-OR-NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">NORECORD</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">display-buffer</span> <span style="color:#008080">BUFFER-OR-NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">NOT-THIS-WINDOW</span> <span style="color:#008080">FRAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">window-start</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WINDOW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-window-start</span> <span style="color:#008080">WINDOW</span> <span style="color:#008080">POS</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">NOFORCE</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="问题解答-6">问题解答</h3>
<h4 id="保存窗口位置信息">保存窗口位置信息</h4>
<p>这是我的答案。欢迎提出改进意见</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#008080">tree</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#008080">windowp</span> <span style="color:#008080">tree</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#990073">&#39;win</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">dir</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">tree</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">children</span> (<span style="color:#900;font-weight:bold">cddr</span> <span style="color:#008080">tree</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#458;font-weight:bold">list</span> (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">dir</span> <span style="color:#990073">&#39;vertical</span> <span style="color:#990073">&#39;horizontal</span>)
</span></span><span style="display:flex;"><span>            (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">dir</span>
</span></span><span style="display:flex;"><span>                (<span style="color:#008080">my-window-height</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">children</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#008080">my-window-width</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">children</span>)))
</span></span><span style="display:flex;"><span>            (<span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">children</span>))
</span></span><span style="display:flex;"><span>            (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">&gt;</span> (<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">children</span>) <span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>                (<span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#008080">dir</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#008080">nil</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">children</span>))))
</span></span><span style="display:flex;"><span>              (<span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">children</span>)))))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-window-width</span> (<span style="color:#008080">win</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#008080">windowp</span> <span style="color:#008080">win</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">window-width</span> <span style="color:#008080">win</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">edge</span> (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">win</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">-</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">edge</span>) (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">edge</span>)))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-window-height</span> (<span style="color:#008080">win</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#008080">windowp</span> <span style="color:#008080">win</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">window-height</span> <span style="color:#008080">win</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">edge</span> (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">win</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">-</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#008080">edge</span>) (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">edge</span>)))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-list-to-window-tree</span> (<span style="color:#008080">conf</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">when</span> (<span style="color:#900;font-weight:bold">listp</span> <span style="color:#008080">conf</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> (<span style="color:#008080">newwin</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">newwin</span> (<span style="color:#008080">split-window</span> <span style="color:#008080">nil</span> (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">conf</span>)
</span></span><span style="display:flex;"><span>                                 (<span style="color:#900;font-weight:bold">eq</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">conf</span>) <span style="color:#990073">&#39;horizontal</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">my-list-to-window-tree</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">conf</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">select-window</span> <span style="color:#008080">newwin</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">my-list-to-window-tree</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#008080">conf</span>)))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-restore-window-configuration</span> (<span style="color:#008080">winconf</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">delete-other-windows</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">my-list-to-window-tree</span> <span style="color:#008080">winconf</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-current-window-configuration</span> ()
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#900;font-weight:bold">car</span> (<span style="color:#008080">window-tree</span>))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; test code here</span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">my-current-window-configuration</span>))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; do sth to change windows</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">my-restore-window-configuration</span> <span style="color:#008080">foo</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="改进的保存窗口信息的函数">改进的保存窗口信息的函数</h4>
<p>由于缓冲区对象也是没有读入形式的，所以返回的列表里只能用缓冲区名来代表 缓冲区，只要没有修改过缓冲区的名字，就能正确的还原缓冲区。如果对于访问 文件的缓冲区，使用文件名可能是更好的想法。保存信息只要对 my-window-tree-to-list 函数做很小的修改就能用了。而恢复窗口则要做较大 改动。my-list-to-window-tree 加了一个函数参数，这样这个函数的可定制性 更高一些。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#008080">tree</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#008080">windowp</span> <span style="color:#008080">tree</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">buffer-name</span> (<span style="color:#008080">window-buffer</span> <span style="color:#008080">tree</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">dir</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">tree</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">children</span> (<span style="color:#900;font-weight:bold">cddr</span> <span style="color:#008080">tree</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#458;font-weight:bold">list</span> (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">dir</span> <span style="color:#990073">&#39;vertical</span> <span style="color:#990073">&#39;horizontal</span>)
</span></span><span style="display:flex;"><span>            (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">dir</span>
</span></span><span style="display:flex;"><span>                (<span style="color:#008080">my-window-height</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">children</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#008080">my-window-width</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">children</span>)))
</span></span><span style="display:flex;"><span>            (<span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">children</span>))
</span></span><span style="display:flex;"><span>            (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">&gt;</span> (<span style="color:#900;font-weight:bold">length</span> <span style="color:#008080">children</span>) <span style="color:#099">2</span>)
</span></span><span style="display:flex;"><span>                (<span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#008080">dir</span> (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#008080">nil</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">children</span>))))
</span></span><span style="display:flex;"><span>              (<span style="color:#008080">my-window-tree-to-list</span> (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">children</span>)))))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-list-to-window-tree</span> (<span style="color:#008080">conf</span> <span style="color:#008080">set-winbuf</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">newwin</span> (<span style="color:#008080">split-window</span> <span style="color:#008080">nil</span> (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">conf</span>)
</span></span><span style="display:flex;"><span>                              (<span style="color:#900;font-weight:bold">eq</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">conf</span>) <span style="color:#990073">&#39;horizontal</span>))))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">eq</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">conf</span>) <span style="color:#990073">&#39;horizontal</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#000;font-weight:bold">progn</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">set-winbuf</span> (<span style="color:#008080">selected-window</span>) (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">conf</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">select-window</span> <span style="color:#008080">newwin</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">listp</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#008080">conf</span>))
</span></span><span style="display:flex;"><span>              (<span style="color:#008080">my-list-to-window-tree</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#008080">conf</span>))
</span></span><span style="display:flex;"><span>            (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">set-winbuf</span> <span style="color:#008080">newwin</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#008080">conf</span>))))
</span></span><span style="display:flex;"><span>      (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">listp</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">conf</span>))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">my-list-to-window-tree</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">conf</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">set-winbuf</span> (<span style="color:#008080">selected-window</span>) (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">conf</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">select-window</span> <span style="color:#008080">newwin</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">set-winbuf</span> <span style="color:#008080">newwin</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#008080">conf</span>)))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-restore-window-configuration</span> (<span style="color:#008080">winconf</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">buf</span> (<span style="color:#008080">current-buffer</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">delete-other-windows</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">my-list-to-window-tree</span> <span style="color:#008080">winconf</span>
</span></span><span style="display:flex;"><span>                            (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">win</span> <span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>                              (<span style="color:#008080">set-window-buffer</span> <span style="color:#008080">win</span> (<span style="color:#0086b3">or</span> (<span style="color:#008080">get-buffer</span> <span style="color:#008080">name</span>)
</span></span><span style="display:flex;"><span>                                                         <span style="color:#008080">buf</span>))))))
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="操作对象之三--文件">操作对象之三 – 文件</h2>
<p>作为一个编辑器，自然文件是最重要的操作对象之一。这一节要介绍有关文件的一系列命令，比如查找文件，读写文件，文件信息、读取目录、文件名操作等。</p>
<h3 id="打开文件的过程">打开文件的过程</h3>
<p>当你打开一个文件时，实际上 emacs 做了很多事情：</p>
<ul>
<li>把文件名展开成为完整的文件名</li>
<li>判断文件是否存在</li>
<li>判断文件是否可读或者文件大小是否太大</li>
<li>查看文件是否已经打开，是否被锁定</li>
<li>向缓冲区插入文件内容</li>
<li>设置缓冲区的模式</li>
</ul>
<p>这还只是简单的一个步骤，实际情况比这要复杂的多，许多异常需要考虑。而且 为了所有函数的可扩展性，许多变量、handler 和 hook 加入到文件操作的函数 中，使得每一个环节都可以让用户或者 elisp 开发者可以定制，甚至完全接管 所有的文件操作。</p>
<p>这里需要区分两个概念：文件和缓冲区。它们是两个不同的对象，文件是在计算 机上可持久保存的信息，而缓冲区是 Emacs 中包含文件内容信息的对象，在 emacs 退出后就会消失，只有当保存缓冲区之后缓冲区里的内容才写到文件中去。</p>
<h3 id="文件读写">文件读写</h3>
<p>打开一个文件的命令是 find-file。这命令使一个缓冲区访问某个文件，并让这 个缓冲区成为当前缓冲区。在打开文件过程中会调用 find-file-hook。 find-file-noselect 是所有访问文件的核心函数。与 find-file 不同，它只返 回访问文件的缓冲区。这两个函数都有一个特点，如果 emacs 里已经有一个缓冲 区访问这个文件的话，emacs 不会创建另一个缓冲区来访问文件，而只是简单返 回或者转到这个缓冲区。怎样检查有没有缓冲区是否访问某个文件呢？所有和文 件关联的缓冲区里都有一个 buffer-local 变量 buffer-file-name。但是不要直 接设置这个变量来改变缓冲区关联的文件。而是使用 set-visited-file-name 来 修改。同样不要直接从 buffer-list 里搜索 buffer-file-name 来查找和某个文 件关联的缓冲区。应该使用 get-file-buffer 或者 find-buffer-visiting。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">find-file</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">with-current-buffer</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">find-file-noselect</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#008080">buffer-file-name</span>)                     <span style="color:#998;font-style:italic">; =&gt; &#34;/home/ywb/temp/test.txt&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">find-buffer-visiting</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; #&lt;buffer test.txt&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-file-buffer</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)      <span style="color:#998;font-style:italic">; =&gt; #&lt;buffer test.txt&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>保存一个文件的过程相对简单一些。首先创建备份文件，处理文件的位模式，将 缓冲区写入文件。保存文件的命令是 save-buffer。相当于其它编辑器里另存为 的命令是 write-file。在这个过程中会调用一些函数或者 hook。 write-file-functions 和 write-contents-functions 几乎功能完全相同。它们 都是在写入文件之前运行的函数，如果这些函数中有一个返回了 non-nil 的值， 则会认为文件已经写入了，后面的函数都不会运行，而且也不会使用再调用其它 写入文件的函数。这两个变量有一个重要的区别是 write-contents-functions 在 改变主模式之后会被修改，因为它没有 permanent-local 属性，而 write-file-functions 则会仍然保留。before-save-hook 和 write-file-functions 功能也比较类似，但是这个变量里的函数会逐个执行，不 论返回什么值也不会影响后面文件的写入。after-save-hook 是在文件已经写入 之后才调用的 hook，它是 save-buffer 最后一个动作。</p>
<p>但是实际上在 elisp 编程过程中经常遇到的一个问题是读取一个文件中的内容， 读取完之后并不希望这个缓冲区还留下来，如果直接用 kill-buffer 可能会把 用户打开的文件关闭。而且 find-file-noselect 做的事情实在超出我们的需要 的。这时你可能需要的是更底层的文件读写函数，它们是 insert-file-contents 和 write-region，调用形式分别是</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">insert-file-contents</span> <span style="color:#008080">filename</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">visit</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span> <span style="color:#900;font-weight:bold">replace</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">write-region</span> <span style="color:#008080">start</span> <span style="color:#008080">end</span> <span style="color:#008080">filename</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#900;font-weight:bold">append</span> <span style="color:#008080">visit</span> <span style="color:#008080">lockname</span> <span style="color:#008080">mustbenew</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>insert-file-contents 可以插入文件中指定部分到当前缓冲区中。如果指定 visit 则会标记缓冲区的修改状态并关联缓冲区到文件，一般是不用的。 replace 是指是否要删除缓冲区里其它内容，这比先删除缓冲区其它内容后插入文 件内容要快一些，但是一般也用不上。insert-file-contents 会处理文件的编 码，如果不需要解码文件的话，可以用 insert-file-contents-literally。</p>
<p>write-region 可以把缓冲区中的一部分写入到指定文件中。如果指定 append 则是添加到文件末尾。和 insert-file-contents 相似，visit 参数也会把缓冲 区和文件关联，lockname 则是文件锁定的名字，mustbenew 确保文件存在时会 要求用户确认操作。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/14-file.html#answer-header-function">思考题</a></p>
<p>写一个函数提取出某个 c 头文件中的函数声明中的函数名和声明位置。</p>
</blockquote>
<h3 id="文件信息">文件信息</h3>
<p>文件是否存在可以使用 file-exists-p 来判断。对于目录和一般文件都可以用 这个函数进行判断，但是符号链接只有当目标文件存在时才返回 t。</p>
<p>如何判断文件是否可读或者可写呢？file-readable-p、file-writable-p， file-executable-p 分用来测试用户对文件的权限。文件的位模式还可以用 file-modes 函数得到。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">file-exists-p</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)              <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-readable-p</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)            <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-writable-p</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)            <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-executable-p</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)          <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">format</span> <span style="color:#d14">&#34;%o&#34;</span> (<span style="color:#008080">file-modes</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>))   <span style="color:#998;font-style:italic">; =&gt; &#34;644&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>文件类型判断可以使用 file-regular-p、file-directory-p、file-symlink-p， 分别判断一个文件名是否是一个普通文件（不是目录，命名管道、终端或者其它 IO 设备）、文件名是否一个存在的目录、文件名是否是一个符号链接。其中 file-symlink-p 当文件名是一个符号链接时会返回目标文件名。文件的真实名 字也就是除去相对链接和符号链接后得到的文件名可以用 file-truename 得到。 事实上每个和文件关联的 buffer 里也有一个缓冲区局部变量 buffer-file-truename 来记录这个文件名。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#008080">$</span> <span style="color:#008080">ls</span> <span style="color:#008080">-l</span> <span style="color:#008080">t.txt</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">lrwxrwxrwx</span> <span style="color:#099">1</span> <span style="color:#008080">ywb</span> <span style="color:#008080">ywb</span> <span style="color:#099">8</span> <span style="color:#008080">2007-07-15</span> <span style="color:#008080">15:51</span> <span style="color:#008080">t.txt</span> <span style="color:#008080">-&gt;</span> <span style="color:#008080">test.txt</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-regular-p</span> <span style="color:#d14">&#34;~/temp/t.txt&#34;</span>)         <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-directory-p</span> <span style="color:#d14">&#34;~/temp/t.txt&#34;</span>)       <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-symlink-p</span> <span style="color:#d14">&#34;~/temp/t.txt&#34;</span>)         <span style="color:#998;font-style:italic">; =&gt; &#34;test.txt&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-truename</span> <span style="color:#d14">&#34;~/temp/t.txt&#34;</span>)          <span style="color:#998;font-style:italic">; =&gt; &#34;/home/ywb/temp/test.txt&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>文件更详细的信息可以用 file-attributes 函数得到。这个函数类似系统的 stat 命令，返回文件几乎所有的信息，包括文件类型，用户和组用户，访问日 期、修改日期、status change 日期、文件大小、文件位模式、inode number、 system number。这是我写的方便使用的帮助函数：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-type</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">car</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-name-number</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">cadr</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-uid</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-gid</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-atime</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">4</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-mtime</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">5</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-ctime</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">6</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-size</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">7</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-modes</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">8</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-guid-changep</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">9</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-inode-number</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">10</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-stat-system-number</span> (<span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">id-format</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">11</span> (<span style="color:#008080">file-attributes</span> <span style="color:#008080">file</span> <span style="color:#008080">id-format</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-type</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-name-number</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-uid</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-gid</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">3</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-atime</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">4</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-mtime</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">5</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-ctime</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">6</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-size</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">7</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-modes</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">8</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-guid-changep</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">9</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-inode-number</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">10</span> <span style="color:#008080">attr</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">file-attr-system-number</span> (<span style="color:#008080">attr</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">11</span> <span style="color:#008080">attr</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>前一组函数是直接由文件名访问文件信息，而后一组函数是由 file-attributes 的返回值来得到文件信息。</p>
<h3 id="修改文件信息">修改文件信息</h3>
<p>重命名和复制文件可以用 rename-file 和 copy-file。删除文件使用 delete-file。创建目录使用 make-directory 函数。不能用 delete-file 删除 目录，只能用 delete-directory 删除目录。当目录不为空时会产生一个错误。</p>
<p>设置文件修改时间使用 set-file-times。设置文件位模式可以用 set-file-modes 函数。set-file-modes 函数的参数必须是一个整数。你可以用位 函数 logand、logior 和 logxor 函数来进行位操作。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/14-file.html#answer-chmod">思考题</a></p>
<p>写一个函数模拟 chmod 命令的行为。</p>
</blockquote>
<h3 id="文件名操作">文件名操作</h3>
<p>虽然 MSWin 的文件名使用的路径分隔符不同，但是这里介绍的函数都能用于 MSWin 形式的文件名，只是返回的文件名都是 Unix 形式了。路径一般由目录和 文件名，而文件名一般由主文件名 (basename)、文件名后缀和版本号构成。 Emacs 有一系列函数来得到路径中的不同部分</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">file-name-directory</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)      <span style="color:#998;font-style:italic">; =&gt; &#34;~/temp/&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-nondirectory</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)   <span style="color:#998;font-style:italic">; =&gt; &#34;test.txt&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-sans-extension</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; &#34;~/temp/test&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-extension</span> <span style="color:#d14">&#34;~/temp/test.txt&#34;</span>)      <span style="color:#998;font-style:italic">; =&gt; &#34;txt&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-sans-versions</span> <span style="color:#d14">&#34;~/temp/test.txt~&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; &#34;~/temp/test.txt&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-sans-versions</span> <span style="color:#d14">&#34;~/temp/test.txt.~1~&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; &#34;~/temp/test.txt&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>路径如果是从根目录开始的称为是绝对路径。测试一个路径是否是绝对路径使用 file-name-absolute-p。如果在 Unix 或 GNU/Linux 系统，以 <code>~</code> 开头的路径也是绝对路径。在 MSWin 上，以 “/” 、 “&quot;、“X:” 开头的路径都是绝对路径。如果不是绝对路径，可以使用 expand-file-name 来得到绝对路径。把一个绝对路径转换成相对某个路径的相 对路径的可以用 file-relative-name 函数。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">file-name-absolute-p</span> <span style="color:#d14">&#34;~rms/foo&#34;</span>)       <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-absolute-p</span> <span style="color:#d14">&#34;/user/rms/foo&#34;</span>)  <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">expand-file-name</span> <span style="color:#d14">&#34;foo&#34;</span>)                <span style="color:#998;font-style:italic">; =&gt; &#34;/home/ywb/foo&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">expand-file-name</span> <span style="color:#d14">&#34;foo&#34;</span> <span style="color:#d14">&#34;/usr/spool/&#34;</span>)  <span style="color:#998;font-style:italic">; =&gt; &#34;/usr/spool/foo&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-relative-name</span> <span style="color:#d14">&#34;/foo/bar&#34;</span> <span style="color:#d14">&#34;/foo/&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; &#34;bar&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-relative-name</span> <span style="color:#d14">&#34;/foo/bar&#34;</span> <span style="color:#d14">&#34;/hack/&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; &#34;../foo/bar&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于目录，如果要将其作为目录，也就是确保它是以路径分隔符结束，可以用 file-name-as-directory。不要用 (concat dir “/”) 来转换，这会有移植问题。 和它相对应的函数是 directory-file-name</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">file-name-as-directory</span> <span style="color:#d14">&#34;~rms/lewis&#34;</span>)   <span style="color:#998;font-style:italic">; =&gt; &#34;~rms/lewis/&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">directory-file-name</span> <span style="color:#d14">&#34;~lewis/&#34;</span>)         <span style="color:#998;font-style:italic">; =&gt; &#34;~lewis&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果要得到所在系统使用的文件名，可以用 convert-standard-filename。比如 在 MSWin 系统上，可以用这个函数返回用 “&quot; 分隔的文件名</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">convert-standard-filename</span> <span style="color:#d14">&#34;c:/windows&#34;</span>)  <span style="color:#998;font-style:italic">;=&gt; &#34;c:\\windows&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="临时文件">临时文件</h3>
<p>如果需要产生一个临时文件，可以使用 make-temp-file。这个函数按给定前缀产 生一个不和现有文件冲突的文件，并返回它的文件名。如果给定的名字是一个相 对文件名，则产生的文件名会用 temporary-file-directory 进行扩展。也可以 用这个函数产生一个临时文件夹。如果只想产生一个不存在的文件名，可以用 make-temp-name 函数</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">make-temp-file</span> <span style="color:#d14">&#34;foo&#34;</span>)                  <span style="color:#998;font-style:italic">; =&gt; &#34;/tmp/foo5611dxf&#34;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-temp-name</span> <span style="color:#d14">&#34;foo&#34;</span>)                  <span style="color:#998;font-style:italic">; =&gt; &#34;foo5611q7l&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="读取目录内容">读取目录内容</h3>
<p>可以用 directory-files 来得到某个目录中的全部或者符合某个正则表达式的 文件名。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">directory-files</span> <span style="color:#d14">&#34;~/temp/dir/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; (&#34;#foo.el#&#34; &#34;.&#34; &#34;.#foo.el&#34; &#34;..&#34; &#34;foo.el&#34; &#34;t.pl&#34; &#34;t2.pl&#34;)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">directory-files</span> <span style="color:#d14">&#34;~/temp/dir/&#34;</span> <span style="color:#008080">t</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; (&#34;/home/ywb/temp/dir/#foo.el#&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  &#34;/home/ywb/temp/dir/.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  &#34;/home/ywb/temp/dir/.#foo.el&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  &#34;/home/ywb/temp/dir/..&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  &#34;/home/ywb/temp/dir/foo.el&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  &#34;/home/ywb/temp/dir/t.pl&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  &#34;/home/ywb/temp/dir/t2.pl&#34;)</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">directory-files</span> <span style="color:#d14">&#34;~/temp/dir/&#34;</span> <span style="color:#008080">nil</span> <span style="color:#d14">&#34;\\.pl$&#34;</span>) <span style="color:#998;font-style:italic">; =&gt; (&#34;t.pl&#34; &#34;t2.pl&#34;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>directory-files-and-attributes 和 directory-files 相似，但是返回的列表 中包含了 file-attributes 得到的信息。file-name-all-versions 用于得到某 个文件在目录中的所有版本，file-expand-wildcards 可以用通配符来得到目录 中的文件列表。</p>
<blockquote>
<p><a href="http://smacs.github.io/elisp/14-file.html#answer-recursive-ls">思考题</a></p>
<p>写一个函数返回当前目录包括子目录中所有文件名。</p>
</blockquote>
<h3 id="神奇的-handle">神奇的 Handle</h3>
<p>如果不把文件局限在存储在本地机器上的信息，如果有一套基本的文件操作，比 如判断文件是否存在、打开文件、保存文件、得到目录内容之类，那远程的文件 和本地文件的差别也仅在于文件名表示方法不同而已。在 Emacs 里，底层的文件 操作函数都可以托管给 elisp 中的函数，这样只要用 elisp 实现了某种类型文 件的基本操作，就能像编辑本地文件一样编辑其它类型文件了。</p>
<p>决定何种类型的文件名使用什么方式来操作是在 file-name-handler-alist 变 量定义的。它是由形如 <code>(REGEXP . HANDLER)</code> 的列表。如果文件名匹配这个 REGEXP 则使用 HANDLER 来进行相应的文件操作。这里所说的文件操作，具体的 来说有这些函数：</p>
<pre tabindex="0"><code>`access-file&#39;, `add-name-to-file&#39;, `byte-compiler-base-file-name&#39;,
`copy-file&#39;, `delete-directory&#39;, `delete-file&#39;,
`diff-latest-backup-file&#39;, `directory-file-name&#39;, `directory-files&#39;,
`directory-files-and-attributes&#39;, `dired-call-process&#39;,
`dired-compress-file&#39;, `dired-uncache&#39;,
`expand-file-name&#39;, `file-accessible-directory-p&#39;, `file-attributes&#39;,
`file-directory-p&#39;, `file-executable-p&#39;, `file-exists-p&#39;,
`file-local-copy&#39;, `file-remote-p&#39;, `file-modes&#39;,
`file-name-all-completions&#39;, `file-name-as-directory&#39;,
`file-name-completion&#39;, `file-name-directory&#39;, `file-name-nondirectory&#39;,
`file-name-sans-versions&#39;, `file-newer-than-file-p&#39;,
`file-ownership-preserved-p&#39;, `file-readable-p&#39;, `file-regular-p&#39;,
`file-symlink-p&#39;, `file-truename&#39;, `file-writable-p&#39;,
`find-backup-file-name&#39;, `find-file-noselect&#39;,
`get-file-buffer&#39;, `insert-directory&#39;, `insert-file-contents&#39;,
`load&#39;, `make-auto-save-file-name&#39;, `make-directory&#39;,
`make-directory-internal&#39;, `make-symbolic-link&#39;,
`rename-file&#39;, `set-file-modes&#39;, `set-file-times&#39;,
`set-visited-file-modtime&#39;, `shell-command&#39;, `substitute-in-file-name&#39;,
`unhandled-file-name-directory&#39;, `vc-registered&#39;,
`verify-visited-file-modtime&#39;,
`write-region&#39;.
</code></pre><p>在 HANDLE 里，可以只接管部分的文件操作，其它仍交给 emacs 原来的函数来完 成。举一个简单的例子。比如最新版本的 emacs 把 <code>*scratch*</code> 的 auto-save-mode 打开了。如果你不想这个缓 冲区的自动保存的文件名散布得到处都是，可以想办法让这个缓冲区的自动保存 文件放到指定的目录中。刚好 make-auto-save-file-name 是在上面这个列表里 的，但是不幸的是在函数定义里 make-auto-save-file-name 里不对不关联文件 的缓冲区使用 handler（我觉得是一个 bug 呀），继续往下看，发现生成保存文 件名是使用了 expand-file-name 函数，所以解决办法就产生了：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-scratch-auto-save-file-name</span> (<span style="color:#008080">operation</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">args</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">eq</span> <span style="color:#008080">operation</span> <span style="color:#990073">&#39;expand-file-name</span>)
</span></span><span style="display:flex;"><span>           (<span style="color:#900;font-weight:bold">string=</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">args</span>) <span style="color:#d14">&#34;#*scratch*#&#34;</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">expand-file-name</span> (<span style="color:#008080">concat</span> <span style="color:#d14">&#34;~/.emacs.d/backup/&#34;</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">args</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">inhibit-file-name-handlers</span>
</span></span><span style="display:flex;"><span>           (<span style="color:#458;font-weight:bold">cons</span> <span style="color:#990073">&#39;my-scratch-auto-save-file-name</span>
</span></span><span style="display:flex;"><span>                 (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">eq</span> <span style="color:#008080">inhibit-file-name-operation</span> <span style="color:#008080">operation</span>)
</span></span><span style="display:flex;"><span>                      <span style="color:#008080">inhibit-file-name-handlers</span>)))
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">inhibit-file-name-operation</span> <span style="color:#008080">operation</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">apply</span> <span style="color:#008080">operation</span> <span style="color:#008080">args</span>))))
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="函数列表-11">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">find-file</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">WILDCARDS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">find-file-noselect</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">NOWARN</span> <span style="color:#008080">RAWFILE</span> <span style="color:#008080">WILDCARDS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-visited-file-name</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">NO-QUERY</span> <span style="color:#008080">ALONG-WITH-FILE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-file-buffer</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">find-buffer-visiting</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">PREDICATE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">save-buffer</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ARGS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">insert-file-contents</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">VISIT</span> <span style="color:#008080">BEG</span> <span style="color:#008080">END</span> <span style="color:#008080">REPLACE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">insert-file-contents-literally</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">VISIT</span> <span style="color:#008080">BEG</span> <span style="color:#008080">END</span> <span style="color:#008080">REPLACE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">write-region</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">APPEND</span> <span style="color:#008080">VISIT</span> <span style="color:#008080">LOCKNAME</span> <span style="color:#008080">MUSTBENEW</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-exists-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-readable-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-writable-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-executable-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-modes</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-regular-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-directory-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-symlink-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-truename</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-attributes</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">ID-FORMAT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">rename-file</span> <span style="color:#008080">FILE</span> <span style="color:#008080">NEWNAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OK-IF-ALREADY-EXISTS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">copy-file</span> <span style="color:#008080">FILE</span> <span style="color:#008080">NEWNAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OK-IF-ALREADY-EXISTS</span> <span style="color:#008080">KEEP-TIME</span> <span style="color:#008080">PRESERVE-UID-GID</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#900;font-weight:bold">delete-file</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-directory</span> <span style="color:#008080">DIR</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">PARENTS</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">delete-directory</span> <span style="color:#008080">DIRECTORY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-file-modes</span> <span style="color:#008080">FILENAME</span> <span style="color:#008080">MODE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-directory</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-nondirectory</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-sans-extension</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-sans-versions</span> <span style="color:#008080">NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">KEEP-BACKUP-VERSION</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-absolute-p</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">expand-file-name</span> <span style="color:#008080">NAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DEFAULT-DIRECTORY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-relative-name</span> <span style="color:#008080">FILENAME</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIRECTORY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">file-name-as-directory</span> <span style="color:#008080">FILE</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">directory-file-name</span> <span style="color:#008080">DIRECTORY</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">convert-standard-filename</span> <span style="color:#008080">FILENAME</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-temp-file</span> <span style="color:#008080">PREFIX</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">DIR-FLAG</span> <span style="color:#008080">SUFFIX</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">make-temp-name</span> <span style="color:#008080">PREFIX</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">directory-files</span> <span style="color:#008080">DIRECTORY</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">FULL</span> <span style="color:#008080">MATCH</span> <span style="color:#008080">NOSORT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">dired-files-attributes</span> <span style="color:#008080">DIR</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="问题解答-7">问题解答</h3>
<h4 id="提取头文件中函数名">提取头文件中函数名</h4>
<p>这是我写的一个版本，主要是函数声明的正则表达式不好写，函数是很简单的。 从这个例子也可以看出它错误的把那个 typedef void 当成函数声明了。如果你 知道更好的正则表达式，请告诉我一下。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defvar</span> <span style="color:#008080">header-regexp-list</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#d14">&#34;^\\(?:\\(?:G_CONST_RETURN\\|extern\\|const\\)\\s-+\\)?[a-zA-Z][_a-zA-Z0-9]*\
</span></span></span><span style="display:flex;"><span><span style="color:#d14">\\(?:\\s-*[*]*[ \t\n]+\\|\\s-+[*]*\\)\\([a-zA-Z][_a-zA-Z0-9]*\\)\\s-*(&#34;</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#d14">&#34;^\\s-*#\\s-*define\\s-+\\([a-zA-Z][_a-zA-Z0-9]*\\)&#34;</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">1</span>)))
</span></span><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">parse-c-header</span> (<span style="color:#008080">file</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;Extract function name and declaration position using
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`header-regexp-list&#39;.&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span> <span style="color:#d14">&#34;fHeader file: \nP&#34;</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> (<span style="color:#008080">info</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">with-temp-buffer</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">insert-file-contents</span> <span style="color:#008080">file</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#0086b3">dolist</span> (<span style="color:#008080">re</span> <span style="color:#008080">header-regexp-list</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">while</span> (<span style="color:#008080">re-search-forward</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">re</span>) <span style="color:#008080">nil</span> <span style="color:#008080">t</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#0086b3">push</span> (<span style="color:#458;font-weight:bold">cons</span> (<span style="color:#008080">match-string</span> (<span style="color:#900;font-weight:bold">cdr</span> <span style="color:#008080">re</span>)) (<span style="color:#008080">line-beginning-position</span>)) <span style="color:#008080">info</span>))))
</span></span><span style="display:flex;"><span>    <span style="color:#008080">info</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">parse-c-header</span> <span style="color:#d14">&#34;/usr/include/glib-2.0/gmodule.h&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; ((&#34;g_module_name&#34; . 1788)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_open&#34; . 1747)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;G_MODULE_EXPORT&#34; . 1396)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;G_MODULE_EXPORT&#34; . 1317)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;G_MODULE_IMPORT&#34; . 1261)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_build_path&#34; . 3462)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_name&#34; . 2764)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_symbol&#34; . 2570)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_error&#34; . 2445)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_make_resident&#34; . 2329)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_close&#34; . 2190)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_open&#34; . 2021)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;g_module_supported&#34; . 1894)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;;  (&#34;void&#34; . 1673))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="模拟-chmod-的函数">模拟 chmod 的函数</h4>
<p>这是一个改变单个文件模式的 chmod 版本。递归版本的就自己作一个练习吧。最 好不要直接调用这个函数，因为每次调用都要解析一次 mode 参数，想一个只解 析一次的方法吧。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">chmod</span> (<span style="color:#008080">mode</span> <span style="color:#008080">file</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#d14">&#34;A elisp function to simulate command chmod.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Note that the command chmod can accept MODE match
</span></span></span><span style="display:flex;"><span><span style="color:#d14">`[ugoa]*([-+=]([rwxXst]*|[ugo]))+&#39;, but this version only can process
</span></span></span><span style="display:flex;"><span><span style="color:#d14">MODE match `[ugoa]*[-+=]([rwx]*|[ugo])&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#0086b3">cond</span> ((<span style="color:#900;font-weight:bold">integerp</span> <span style="color:#008080">mode</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">&gt;</span> <span style="color:#008080">mode</span> <span style="color:#099">#o777</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#458;font-weight:bold">error</span> <span style="color:#d14">&#34;Unknown mode option: %d&#34;</span> <span style="color:#008080">mode</span>)))
</span></span><span style="display:flex;"><span>        ((<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;^[0-7]\\{3\\}$&#34;</span> <span style="color:#008080">mode</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">mode</span> (<span style="color:#008080">string-to-number</span> <span style="color:#008080">mode</span> <span style="color:#099">8</span>)))
</span></span><span style="display:flex;"><span>        ((<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;^\\([ugoa]*\\)\\([-+=]\\)\\([rwx]*\\|[ugo]\\)$&#34;</span> <span style="color:#008080">mode</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">users</span> (<span style="color:#900;font-weight:bold">append</span> (<span style="color:#008080">match-string</span> <span style="color:#099">1</span> <span style="color:#008080">mode</span>) <span style="color:#008080">nil</span>))
</span></span><span style="display:flex;"><span>               (<span style="color:#008080">mask-func</span> (<span style="color:#008080">string-to-char</span> (<span style="color:#008080">match-string</span> <span style="color:#099">2</span> <span style="color:#008080">mode</span>)))
</span></span><span style="display:flex;"><span>               (<span style="color:#008080">bits</span> (<span style="color:#900;font-weight:bold">append</span> (<span style="color:#008080">match-string</span> <span style="color:#099">3</span> <span style="color:#008080">mode</span>) <span style="color:#008080">nil</span>))
</span></span><span style="display:flex;"><span>               (<span style="color:#008080">oldmode</span> (<span style="color:#008080">file-modes</span> <span style="color:#008080">file</span>))
</span></span><span style="display:flex;"><span>               (<span style="color:#008080">user-list</span> <span style="color:#000;font-weight:bold">&#39;</span>((<span style="color:#008080">?a</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">#o777</span>)
</span></span><span style="display:flex;"><span>                            (<span style="color:#008080">?u</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">#o700</span>)
</span></span><span style="display:flex;"><span>                            (<span style="color:#008080">?g</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">#o070</span>)
</span></span><span style="display:flex;"><span>                            (<span style="color:#008080">?o</span> <span style="color:#000;font-weight:bold">.</span> <span style="color:#099">#o007</span>)))
</span></span><span style="display:flex;"><span>               <span style="color:#008080">mask</span>)
</span></span><span style="display:flex;"><span>           (<span style="color:#0086b3">when</span> <span style="color:#008080">bits</span>
</span></span><span style="display:flex;"><span>             (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">bits</span> (<span style="color:#900;font-weight:bold">*</span> (<span style="color:#0086b3">cond</span> ((<span style="color:#900;font-weight:bold">=</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">bits</span>) <span style="color:#008080">?u</span>)
</span></span><span style="display:flex;"><span>                                  (<span style="color:#008080">lsh</span> (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">oldmode</span> <span style="color:#099">#o700</span>) <span style="color:#099">-6</span>))
</span></span><span style="display:flex;"><span>                                 ((<span style="color:#900;font-weight:bold">=</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">bits</span>) <span style="color:#008080">?g</span>)
</span></span><span style="display:flex;"><span>                                  (<span style="color:#008080">lsh</span> (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">oldmode</span> <span style="color:#099">#o070</span>) <span style="color:#099">-3</span>))
</span></span><span style="display:flex;"><span>                                 ((<span style="color:#900;font-weight:bold">=</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">bits</span>) <span style="color:#008080">?o</span>)
</span></span><span style="display:flex;"><span>                                  (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">oldmode</span> <span style="color:#099">#o007</span>))
</span></span><span style="display:flex;"><span>                                 (<span style="color:#008080">t</span>
</span></span><span style="display:flex;"><span>                                  (<span style="color:#900;font-weight:bold">+</span> (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">member</span> <span style="color:#008080">?r</span> <span style="color:#008080">bits</span>) <span style="color:#099">4</span> <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>                                     (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">member</span> <span style="color:#008080">?w</span> <span style="color:#008080">bits</span>) <span style="color:#099">2</span> <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>                                     (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#900;font-weight:bold">member</span> <span style="color:#008080">?x</span> <span style="color:#008080">bits</span>) <span style="color:#099">1</span> <span style="color:#099">0</span>))))
</span></span><span style="display:flex;"><span>                           <span style="color:#099">#o111</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">users</span>
</span></span><span style="display:flex;"><span>                 (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">mask</span> (<span style="color:#900;font-weight:bold">apply</span> <span style="color:#990073">&#39;logior</span>
</span></span><span style="display:flex;"><span>                                   (<span style="color:#008080">delq</span> <span style="color:#008080">nil</span> (<span style="color:#900;font-weight:bold">mapcar</span>
</span></span><span style="display:flex;"><span>                                              (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">u</span>)
</span></span><span style="display:flex;"><span>                                                (<span style="color:#008080">assoc-default</span> <span style="color:#008080">u</span> <span style="color:#008080">user-list</span>))
</span></span><span style="display:flex;"><span>                                              <span style="color:#008080">users</span>))))
</span></span><span style="display:flex;"><span>               (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">mask</span> <span style="color:#099">#o777</span>))
</span></span><span style="display:flex;"><span>             (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">mode</span>
</span></span><span style="display:flex;"><span>                   (<span style="color:#0086b3">cond</span> ((<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">mask-func</span> <span style="color:#008080">?\=</span>)
</span></span><span style="display:flex;"><span>                          (<span style="color:#900;font-weight:bold">logior</span> (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">bits</span> <span style="color:#008080">mask</span>)
</span></span><span style="display:flex;"><span>                                  (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">oldmode</span> (<span style="color:#900;font-weight:bold">logxor</span> <span style="color:#008080">mask</span> <span style="color:#099">#o777</span>))))
</span></span><span style="display:flex;"><span>                         ((<span style="color:#900;font-weight:bold">=</span> <span style="color:#008080">mask-func</span> <span style="color:#008080">?\+</span>)
</span></span><span style="display:flex;"><span>                          (<span style="color:#900;font-weight:bold">logior</span> <span style="color:#008080">oldmode</span> (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">bits</span> <span style="color:#008080">mask</span>)))
</span></span><span style="display:flex;"><span>                         (<span style="color:#008080">t</span>
</span></span><span style="display:flex;"><span>                          (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">oldmode</span>
</span></span><span style="display:flex;"><span>                                  (<span style="color:#900;font-weight:bold">logxor</span> (<span style="color:#900;font-weight:bold">logand</span> <span style="color:#008080">bits</span> <span style="color:#008080">mask</span>) <span style="color:#099">#o777</span>))))))))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">t</span> (<span style="color:#458;font-weight:bold">error</span> <span style="color:#d14">&#34;Unknow mode option: %S&#34;</span> <span style="color:#008080">mode</span>)))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">set-file-modes</span> <span style="color:#008080">file</span> <span style="color:#008080">mode</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="列出目录中所有文件">列出目录中所有文件</h4>
<p>为了让这个函数更类似 directory-files 函数，我把参数设置为和它一样的：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-directory-all-files</span> (<span style="color:#008080">dir</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">full</span> <span style="color:#008080">match</span> <span style="color:#008080">nosort</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#900;font-weight:bold">apply</span> <span style="color:#990073">&#39;append</span>
</span></span><span style="display:flex;"><span>   (<span style="color:#008080">delq</span> <span style="color:#008080">nil</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#900;font-weight:bold">mapcar</span>
</span></span><span style="display:flex;"><span>     (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">file</span>)
</span></span><span style="display:flex;"><span>       (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">not</span> (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;^[.]+$&#34;</span> (<span style="color:#008080">file-name-nondirectory</span> <span style="color:#008080">file</span>)))
</span></span><span style="display:flex;"><span>                (<span style="color:#008080">file-directory-p</span> (<span style="color:#008080">expand-file-name</span> <span style="color:#008080">file</span> <span style="color:#008080">dir</span>)))
</span></span><span style="display:flex;"><span>           (<span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">full</span>
</span></span><span style="display:flex;"><span>               (<span style="color:#008080">my-directory-all-files</span> <span style="color:#008080">file</span> <span style="color:#008080">full</span> <span style="color:#008080">match</span> <span style="color:#008080">nosort</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#900;font-weight:bold">mapcar</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">f</span>)
</span></span><span style="display:flex;"><span>                       (<span style="color:#008080">concat</span> (<span style="color:#008080">file-name-as-directory</span> <span style="color:#008080">file</span>) <span style="color:#008080">f</span>))
</span></span><span style="display:flex;"><span>                     (<span style="color:#008080">my-directory-all-files</span> (<span style="color:#008080">expand-file-name</span> <span style="color:#008080">file</span> <span style="color:#008080">dir</span>)
</span></span><span style="display:flex;"><span>                                             <span style="color:#008080">full</span> <span style="color:#008080">match</span> <span style="color:#008080">nosort</span>)))
</span></span><span style="display:flex;"><span>         (<span style="color:#000;font-weight:bold">if</span> (<span style="color:#008080">string-match</span> <span style="color:#008080">match</span> <span style="color:#008080">file</span>)
</span></span><span style="display:flex;"><span>             (<span style="color:#458;font-weight:bold">list</span> <span style="color:#008080">file</span>))))
</span></span><span style="display:flex;"><span>     (<span style="color:#008080">directory-files</span> <span style="color:#008080">dir</span> <span style="color:#008080">full</span> <span style="color:#008080">nil</span> <span style="color:#008080">nosort</span>)))))
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="操作对象之四--文本">操作对象之四 – 文本</h2>
<p>文本的插入删除，查找替换操作已经在缓冲区一节中讲过了。这一节主要介绍文 本属性。</p>
<p>如果使用过其它图形界面的文本组件进行编程，它们对于文本的高亮一般都是采 用给对应文本贴上相应标签的方法。Emacs 的处理方法也是类似的，但是相比之 下，要强大的多。在 Emacs 里，在不同位置上的每个字符都可以有一个属性列表。 这个属性列表和符号的属性列表很相似，都是由一个名字和值构成的对组成。名 字和值都可以是一个 lisp 对象，但是通常名字都是一个符号，这样可以用这个 符号来查找相应的属性值。复制文本通常都会复制相应的字符的文本属性，但是 也可以用相应的函数只复制文本字符串，比如 substring-no-properties、 insert-buffer-substring-no-properties、buffer-substring-no-properties。</p>
<p>产生一个带属性的字符串可以用 propertize 函数</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">propertize</span> <span style="color:#d14">&#34;abc&#34;</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;bold</span>)          <span style="color:#998;font-style:italic">; =&gt; #(&#34;abc&#34; 0 3 (face bold))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果你在一个 text-mode 的缓冲区内用 M-x eval-expression 用 insert 函数 插入前面这个字符串，就会发现插入的文本已经是粗体字了。之所以不能在 <code>*scratch*</code> 产生这种效果，是因为通常我们是开启了 font-lock-mode，在 font-lock-mode 里，文本的 face 属性是实时计算出来的。 在插入文本之后，它的 face 属性已经很快地被改变了。你可以在关闭 font-lock-mode 后再测试一次应该是可以看到 <code>*scratch*</code> 里也是可以用这种方法插入带 face 属性的文本的。</p>
<p>虽然文本属性的名字可以是任意的，但是一些名字是有特殊含义的。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>category</td>
<td>值必须是一个符号，这个符号的属性将作为这个字符的属性</td>
</tr>
<tr>
<td>face</td>
<td>控制文本的字体和颜色</td>
</tr>
<tr>
<td>font-lock-face</td>
<td>和 face 相似，可以作为 font-lock-mode 中静态文本的 face</td>
</tr>
<tr>
<td>mouse-face</td>
<td>当鼠标停在文本上时的文本 face</td>
</tr>
<tr>
<td>fontified</td>
<td>记录是否使用 font lock 标记了 face</td>
</tr>
<tr>
<td>display</td>
<td>改变文本的显示方式，比如高、低、长短、宽窄，或者用图片代替</td>
</tr>
<tr>
<td>help-echo</td>
<td>鼠标停在文本上时显示的文字</td>
</tr>
<tr>
<td>keymap</td>
<td>光标或者鼠标在文本上时使用的按键映射</td>
</tr>
<tr>
<td>local-map</td>
<td>和 keymap 类似，通常只使用 keymap</td>
</tr>
<tr>
<td>syntax-table</td>
<td>字符的语法表</td>
</tr>
<tr>
<td>read-only</td>
<td>不能修改文本，通过 stickness 来选择可插入的位置</td>
</tr>
<tr>
<td>invisible</td>
<td>不显示在屏幕上</td>
</tr>
<tr>
<td>intangible</td>
<td>把文本作为一个整体，光标不能进入</td>
</tr>
<tr>
<td>field</td>
<td>一个特殊标记，有相应的函数可以操作带这个标记的文本</td>
</tr>
<tr>
<td>cursor</td>
<td>（不知道具体用途）</td>
</tr>
<tr>
<td>pointer</td>
<td>修改鼠标停在文本上时的图像</td>
</tr>
<tr>
<td>line-spacing</td>
<td>新的一行的距离</td>
</tr>
<tr>
<td>line-height</td>
<td>本行的高度</td>
</tr>
<tr>
<td>modification-hooks</td>
<td>修改这个字符时调用的函数</td>
</tr>
<tr>
<td>insert-in-front-hooks</td>
<td>与 modification-hooks 相似，在字符前插入调用的函数</td>
</tr>
<tr>
<td>insert-behind-hooks</td>
<td>与 modification-hooks 相似，在字符后插入调用的函数</td>
</tr>
<tr>
<td>point-entered</td>
<td>当光标进入时调用的函数</td>
</tr>
<tr>
<td>point-left</td>
<td>当光标离开时调用的函数</td>
</tr>
<tr>
<td>composition</td>
<td>将多个字符显示为一个字形</td>
</tr>
</tbody>
</table>
<p>正是由于 emacs 的文本有如此丰富的属性，使得 emacs 里的文字才变得多彩， 变得人性化。</p>
<h3 id="查看文本属性">查看文本属性</h3>
<p>由于字符串和缓冲区都可以有文本属性，所以下面的函数通常不提供特定参数就是检 查当前缓冲区的文本属性，如果提供文本对象，则是操作对应的文本属性。</p>
<p>查看文本对象在某处的文本属性可以用 get-text-property 函数。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">concat</span> <span style="color:#d14">&#34;abc&#34;</span>
</span></span><span style="display:flex;"><span>                  (<span style="color:#008080">propertize</span> <span style="color:#d14">&#34;cde&#34;</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;bold</span>))) <span style="color:#998;font-style:italic">; =&gt; #(&#34;abccde&#34; 3 6 (face bold))</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-text-property</span> <span style="color:#099">3</span> <span style="color:#990073">&#39;face</span> <span style="color:#008080">foo</span>)                    <span style="color:#998;font-style:italic">; =&gt; bold</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">save-excursion</span>
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">insert</span> <span style="color:#008080">foo</span>))
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-text-property</span> <span style="color:#099">4</span> <span style="color:#990073">&#39;face</span>)                        <span style="color:#998;font-style:italic">; =&gt; bold</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>get-char-property 和 get-text-property 相似，但是它是先查找 overlay 的 文本属性。overlay 是缓冲区文字在屏幕上的显示方式，它属于某个缓冲区，具 有起点和终点，也具有文本属性，可以修改缓冲区对应区域上文本的显示方式。</p>
<p>get-text-property 是查找某个属性的值，用 text-properties-at 可以得到某 个位置上文本的所有属性。</p>
<h3 id="修改文本属性">修改文本属性</h3>
<p>put-text-property 可以给文本对象添加一个属性。比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">str</span> <span style="color:#d14">&#34;abc&#34;</span>))
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">put-text-property</span> <span style="color:#099">0</span> <span style="color:#099">3</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;bold</span> <span style="color:#008080">str</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#008080">str</span>)                                  <span style="color:#998;font-style:italic">; =&gt; #(&#34;abc&#34; 0 3 (face bold))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>和 put-text-property 类似，add-text-properties 可以给文本对象添加一系 列的属性。和 add-text-properties 不同，可以用 set-text-properties 直接 设置文本属性列表。你可以用 =(set-text-properties start end nil)= 来除去 某个区间上的文本属性。也可以用 remove-text-properties 和 remove-list-of-text-properties 来除去某个区域的指定文本属性。这两个函 数的属性列表参数只有名字起作用，值是被忽略的。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">propertize</span> <span style="color:#d14">&#34;abcdef&#34;</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;bold</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#990073">&#39;pointer</span> <span style="color:#990073">&#39;hand</span>))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt; #(&#34;abcdef&#34; 0 6 (pointer hand face bold))</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-text-properties</span> <span style="color:#099">0</span> <span style="color:#099">2</span> <span style="color:#008080">nil</span> <span style="color:#008080">foo</span>)       <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>   <span style="color:#998;font-style:italic">; =&gt; #(&#34;abcdef&#34; 2 6 (pointer hand face bold))</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">remove-text-properties</span> <span style="color:#099">2</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">face</span> <span style="color:#008080">nil</span>) <span style="color:#008080">foo</span>) <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>   <span style="color:#998;font-style:italic">; =&gt; #(&#34;abcdef&#34; 2 4 (pointer hand) 4 6 (pointer hand face bold))</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">remove-list-of-text-properties</span> <span style="color:#099">4</span> <span style="color:#099">6</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">face</span> <span style="color:#008080">nil</span> <span style="color:#008080">pointer</span> <span style="color:#008080">nil</span>) <span style="color:#008080">foo</span>) <span style="color:#998;font-style:italic">; =&gt; t</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">foo</span>   <span style="color:#998;font-style:italic">; =&gt; #(&#34;abcdef&#34; 2 4 (pointer hand))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="查找文本属性">查找文本属性</h3>
<p>文本属性通常都是连成一个区域的，所以查找文本属性的函数是查找属性变化的 位置。这些函数一般都不作移动，只是返回查找到的位置。使用这些函数时最好 使用 LIMIT 参数，这样可以提高效率，因为有时一个属性直到缓冲区末尾也没 有变化，在这些文本中可能就是多余的。</p>
<p>next-property-change 查找从当前位置起任意一个文本属性发生改变的位置。 next-single-property-change 查找指定的一个文本属性改变的位置。 next-char-property-change 把 overlay 的文本属性考虑在内查找属性发生改 变的位置。next-single-property-change 类似的查找指定的一个考虑 overlay 后文本属性改变的位置。这四个函数都对应有 previous- 开头的函数，用于查 找当前位置之前文本属性改变的位置</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">foo</span> (<span style="color:#008080">concat</span> <span style="color:#d14">&#34;ab&#34;</span>
</span></span><span style="display:flex;"><span>                  (<span style="color:#008080">propertize</span> <span style="color:#d14">&#34;cd&#34;</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;bold</span>)
</span></span><span style="display:flex;"><span>                  (<span style="color:#008080">propertize</span> <span style="color:#d14">&#34;ef&#34;</span> <span style="color:#990073">&#39;pointer</span> <span style="color:#990073">&#39;hand</span>)))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">;; =&gt; #(&#34;abcdef&#34; 2 4 (face bold) 4 6 (pointer hand))</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-property-change</span> <span style="color:#099">1</span> <span style="color:#008080">foo</span>)                  <span style="color:#998;font-style:italic">; =&gt; 2</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-single-property-change</span> <span style="color:#099">1</span> <span style="color:#990073">&#39;pointer</span> <span style="color:#008080">foo</span>)  <span style="color:#998;font-style:italic">; =&gt; 4</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">previous-property-change</span> <span style="color:#099">6</span> <span style="color:#008080">foo</span>)              <span style="color:#998;font-style:italic">; =&gt; 4</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">previous-single-property-change</span> <span style="color:#099">6</span> <span style="color:#990073">&#39;face</span> <span style="color:#008080">foo</span>) <span style="color:#998;font-style:italic">; =&gt; 4</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>text-property-any 查找区域内第一个指定属性值为给定值的字符位置。 text-property-not-all 和它相反，查找区域内第一个指定属性值不是给定值的 字符位置。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">text-property-any</span> <span style="color:#099">0</span> <span style="color:#099">6</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;bold</span> <span style="color:#008080">foo</span>)          <span style="color:#998;font-style:italic">; =&gt; 2</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">text-property-any</span> <span style="color:#099">0</span> <span style="color:#099">6</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;underline</span> <span style="color:#008080">foo</span>)     <span style="color:#998;font-style:italic">; =&gt; nil</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">text-property-not-all</span> <span style="color:#099">2</span> <span style="color:#099">6</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;bold</span> <span style="color:#008080">foo</span>)      <span style="color:#998;font-style:italic">; =&gt; 4</span>
</span></span><span style="display:flex;"><span>(<span style="color:#008080">text-property-not-all</span> <span style="color:#099">2</span> <span style="color:#099">6</span> <span style="color:#990073">&#39;face</span> <span style="color:#990073">&#39;underline</span> <span style="color:#008080">foo</span>) <span style="color:#998;font-style:italic">; =&gt; 2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><a href="http://smacs.github.io/elisp/15-text.html#answer-fontify">思考题</a></p>
<p>写一个命令，可在 text-mode 里用指定模式给选中的文本添加高亮。</p>
</blockquote>
<h3 id="函数列表-12">函数列表</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#008080">propertize</span> <span style="color:#008080">STRING</span> <span style="color:#000;font-weight:bold">&amp;rest</span> <span style="color:#008080">PROPERTIES</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-text-property</span> <span style="color:#008080">POSITION</span> <span style="color:#008080">PROP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">get-char-property</span> <span style="color:#008080">POSITION</span> <span style="color:#008080">PROP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">text-properties-at</span> <span style="color:#008080">POSITION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">put-text-property</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">PROPERTY</span> <span style="color:#008080">VALUE</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">add-text-properties</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">PROPERTIES</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">set-text-properties</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">PROPERTIES</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">remove-text-properties</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">PROPERTIES</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">remove-list-of-text-properties</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">LIST-OF-PROPERTIES</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-single-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#008080">PROP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-char-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">next-single-char-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#008080">PROP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">previous-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">previous-single-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#008080">PROP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">previous-char-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">previous-single-char-property-change</span> <span style="color:#008080">POSITION</span> <span style="color:#008080">PROP</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span> <span style="color:#008080">LIMIT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">text-property-any</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">PROPERTY</span> <span style="color:#008080">VALUE</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#008080">text-property-not-all</span> <span style="color:#008080">START</span> <span style="color:#008080">END</span> <span style="color:#008080">PROPERTY</span> <span style="color:#008080">VALUE</span> <span style="color:#000;font-weight:bold">&amp;optional</span> <span style="color:#008080">OBJECT</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="问题解答-8">问题解答</h3>
<h4 id="手工高亮代码">手工高亮代码</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#0086b3">defun</span> <span style="color:#008080">my-fontify-region</span> (<span style="color:#008080">beg</span> <span style="color:#008080">end</span> <span style="color:#008080">mode</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#008080">interactive</span>
</span></span><span style="display:flex;"><span>   (<span style="color:#458;font-weight:bold">list</span> (<span style="color:#008080">region-beginning</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#008080">region-end</span>)
</span></span><span style="display:flex;"><span>         (<span style="color:#900;font-weight:bold">intern</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#008080">completing-read</span> <span style="color:#d14">&#34;Which mode to use: &#34;</span>
</span></span><span style="display:flex;"><span>                           <span style="color:#008080">obarray</span> (<span style="color:#0086b3">lambda</span> (<span style="color:#008080">s</span>)
</span></span><span style="display:flex;"><span>                                     (<span style="color:#0086b3">and</span> (<span style="color:#900;font-weight:bold">fboundp</span> <span style="color:#008080">s</span>)
</span></span><span style="display:flex;"><span>                                          (<span style="color:#008080">string-match</span> <span style="color:#d14">&#34;-mode$&#34;</span> (<span style="color:#900;font-weight:bold">symbol-name</span> <span style="color:#008080">s</span>))))
</span></span><span style="display:flex;"><span>                           <span style="color:#008080">t</span>))))
</span></span><span style="display:flex;"><span>  (<span style="color:#000;font-weight:bold">let</span> ((<span style="color:#008080">buf</span> (<span style="color:#008080">current-buffer</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">font-lock-verbose</span> <span style="color:#008080">nil</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">start</span> <span style="color:#099">1</span>) <span style="color:#008080">face</span> <span style="color:#008080">face-list</span>)
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">set-text-properties</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span> <span style="color:#000;font-weight:bold">&#39;</span>(<span style="color:#008080">face</span> <span style="color:#008080">nil</span>))
</span></span><span style="display:flex;"><span>    (<span style="color:#008080">with-temp-buffer</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">goto-char</span> (<span style="color:#008080">point-min</span>))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">insert-buffer-substring</span> <span style="color:#008080">buf</span> <span style="color:#008080">beg</span> <span style="color:#008080">end</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#900;font-weight:bold">funcall</span> <span style="color:#008080">mode</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">font-lock-fontify-buffer</span>)
</span></span><span style="display:flex;"><span>      (<span style="color:#0086b3">or</span> (<span style="color:#008080">get-text-property</span> <span style="color:#008080">start</span> <span style="color:#990073">&#39;face</span>)
</span></span><span style="display:flex;"><span>          (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">start</span> (<span style="color:#008080">next-single-property-change</span> <span style="color:#008080">start</span> <span style="color:#990073">&#39;face</span>)))
</span></span><span style="display:flex;"><span>      (<span style="color:#008080">while</span> (<span style="color:#0086b3">and</span> <span style="color:#008080">start</span> (<span style="color:#900;font-weight:bold">&lt;</span> <span style="color:#008080">start</span> (<span style="color:#008080">point-max</span>)))
</span></span><span style="display:flex;"><span>        (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">end</span> (<span style="color:#0086b3">or</span> (<span style="color:#008080">next-single-property-change</span> <span style="color:#008080">start</span> <span style="color:#990073">&#39;face</span>)
</span></span><span style="display:flex;"><span>                      (<span style="color:#008080">point-max</span>))
</span></span><span style="display:flex;"><span>              <span style="color:#008080">face</span> (<span style="color:#008080">get-text-property</span> <span style="color:#008080">start</span> <span style="color:#990073">&#39;face</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#0086b3">and</span> <span style="color:#008080">face</span> <span style="color:#008080">end</span> (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">face-list</span> (<span style="color:#458;font-weight:bold">cons</span> (<span style="color:#458;font-weight:bold">list</span> (<span style="color:#900;font-weight:bold">1-</span> <span style="color:#008080">start</span>) (<span style="color:#900;font-weight:bold">1-</span> <span style="color:#008080">end</span>) <span style="color:#008080">face</span>) <span style="color:#008080">face-list</span>)))
</span></span><span style="display:flex;"><span>        (<span style="color:#000;font-weight:bold">setq</span> <span style="color:#008080">start</span> <span style="color:#008080">end</span>)))
</span></span><span style="display:flex;"><span>    (<span style="color:#0086b3">when</span> <span style="color:#008080">face-list</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#0086b3">dolist</span> (<span style="color:#008080">f</span> (<span style="color:#900;font-weight:bold">nreverse</span> <span style="color:#008080">face-list</span>))
</span></span><span style="display:flex;"><span>        (<span style="color:#008080">put-text-property</span> (<span style="color:#900;font-weight:bold">+</span> <span style="color:#008080">beg</span> (<span style="color:#900;font-weight:bold">car</span> <span style="color:#008080">f</span>)) (<span style="color:#900;font-weight:bold">+</span> <span style="color:#008080">beg</span> (<span style="color:#900;font-weight:bold">cadr</span> <span style="color:#008080">f</span>))
</span></span><span style="display:flex;"><span>                           <span style="color:#990073">&#39;face</span> (<span style="color:#900;font-weight:bold">nth</span> <span style="color:#099">2</span> <span style="color:#008080">f</span>))))))
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是直接从那个临时缓冲区里把整个代码拷贝出来也可以了，但是可能某些情况 下，不好修改当前缓冲区，或者不想把那个模式里其它文本属性拷贝出来，这个 函数还是有用的。当然最主要的用途是演示使用查找和添加文本属性的方法。事 实上这个函数也是我用来高亮 muse 模式里 src 标签内源代码所用的方法。但是 不幸的是 muse 模式里这个函数并不能产生很好的效果，不知道为什么。</p>
<h2 id="后记">后记</h2>
<p>到现在为止，我计划写的 elisp 入门内容已经写完了。如果你都看完看懂这些内 容，我想写一些简单的 elisp 应用应该是没有什么问题了。还有一些比较重要的 内容没有涉及到，我在这列一下，如果你对此有兴趣，可以自己看 elisp manual 里相关章节：</p>
<ul>
<li>按键映射 (keymap) 和菜单</li>
<li>Minibuffer 和补全</li>
<li>进程</li>
<li>调试</li>
<li>主模式 (major mode) 和从属模式 (minor mode)</li>
<li>定制声明</li>
<li>修正函数 (advising function)</li>
<li>非 ASCII 字符</li>
</ul>
<p>其实看一遍 elisp manual 也是很好的选择。我在写这些文字时就是一边参考 elisp manual 一边写的。写的时候我一直有种不安的感觉，这近 3M 的文字被 我压缩到这么一点点是不是太过份了。在 elisp manual 里一些很重要的说明经 常被我一两句话就带过了，有时根本就没有提到，这会不会让刚学 elisp 的人 误入歧途呢？每每想到这一点，我就想就此停住。但是半途而废总是不好的。所 以我还是决定写完应该写的就好了。其它的再说吧。</p>
<p>如果你是一个新手，我很想知道你看完这个入门教程的感受。当然如果实在没有 兴趣看，也可以告诉我究竟哪里写的不好。我希望在这份文档上花的时间和精力没有白费。</p>
    </div>

    

    <div class="container-comment-giscus">
        <script src="https://giscus.app/client.js"
        data-repo="loveminimal/comment"
        data-repo-id="R_kgDOJNJQ8g"
        data-category="General"
        data-category-id="DIC_kwDOJNJQ8s4CYl0m"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="noborder_light"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
        </script>
</div>
</div>

        </div>
        <div id="footer"><div class="container-footer">
    

    <div class="beian">
        
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=">
            

        </a>

        
        <a href="/about" target="_blank">
            
            将喜欢的一切留在身边，这便是努力的意义
            
        </a>
    </div>

    
    <div class="info">
        
        <a href="https://github.com/loveminimal/hugo-theme-virgo">🕊️</a> 2016 - <span id="info-date"></span>
    </div>

</div></div>
        <div class="cool-after" style="
            
                background-color: rgba(255, 255, 255, 0.69); 
                backdrop-filter: saturate(180%) blur(6px);
            
            "></div>
    </body>
</html>
